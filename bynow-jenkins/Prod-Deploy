properties([
	parameters([
		[$class: 'ChoiceParameter',
			choiceType: 'PT_SINGLE_SELECT',
			name: 'PROJECT',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
                        def artifactsDir = '/data/artifacts'
                        def projects = []

                        try {
                            def backendDir = new File("${artifactsDir}/backend")
                            if (backendDir.exists()) {
                                backendDir.listFiles()?.each { projectDir ->
                                    if (projectDir.isDirectory()) {
                                        projects << "[åç«¯] ${projectDir.name}"
                                    }
                                }
                            }

                            def frontendDir = new File("${artifactsDir}/frontend")
                            if (frontendDir.exists()) {
                                frontendDir.listFiles()?.each { projectDir ->
                                    if (projectDir.isDirectory()) {
                                        projects << "[å‰ç«¯] ${projectDir.name}"
                                    }
                                }
                            }

                            return projects.isEmpty() ? ['æ²¡æœ‰å¯ç”¨çš„é¡¹ç›®'] : projects.sort()

                        } catch (Exception e) {
                            return ['è¯»å–é¡¹ç›®å¤±è´¥: ' + e.message]
                        }
                    '''
				]
			],
			description: 'é€‰æ‹©é¡¹ç›®'
		],

		[$class: 'CascadeChoiceParameter',
			choiceType: 'PT_CHECKBOX',
			name: 'MODULES',
			referencedParameters: 'PROJECT',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
                        def artifactsDir = '/data/artifacts'
                        def modules = []

                        try {
                            def projectMatch = PROJECT =~ /^\\[(åç«¯|å‰ç«¯)\\]\\s+(.+)$/
                            if (!projectMatch.find()) {
                                return ['é¡¹ç›®æ ¼å¼é”™è¯¯']
                            }

                            def projectType = projectMatch.group(1)
                            def projectName = projectMatch.group(2)

                            if (projectType == 'å‰ç«¯') {
                                return ['(å‰ç«¯é¡¹ç›®æ— éœ€é€‰æ‹©æ¨¡å—)']
                            }

                            def projectDir = new File("${artifactsDir}/backend/${projectName}")
                            if (!projectDir.exists()) {
                                return ['é¡¹ç›®ç›®å½•ä¸å­˜åœ¨']
                            }

                            projectDir.listFiles()?.each { moduleDir ->
                                if (moduleDir.isDirectory()) {
                                    modules << moduleDir.name
                                }
                            }

                            return modules.isEmpty() ? ['æ²¡æœ‰å¯ç”¨çš„æ¨¡å—'] : modules.sort()

                        } catch (Exception e) {
                            return ['è¯»å–æ¨¡å—å¤±è´¥: ' + e.message]
                        }
                    '''
				]
			],
			description: 'é€‰æ‹©è¦å‘å¸ƒçš„æ¨¡å—ï¼ˆå¯å¤šé€‰ï¼ŒCtrl+ç‚¹å‡»ï¼‰'
		],

		[$class: 'DynamicReferenceParameter',
			choiceType: 'ET_FORMATTED_HTML',
			name: 'MODULE_VERSION_SELECTORS',
			referencedParameters: 'PROJECT,MODULES',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
                        def artifactsDir = '/data/artifacts'

                        try {
                            def projectMatch = PROJECT =~ /^\\[(åç«¯|å‰ç«¯)\\]\\s+(.+)$/
                            if (!projectMatch.find()) {
                                return '<div style="color: red;">é¡¹ç›®æ ¼å¼é”™è¯¯</div>'
                            }

                            def projectType = projectMatch.group(1)
                            def projectName = projectMatch.group(2)

                            if (projectType == 'å‰ç«¯') {
                                // å‰ç«¯é¡¹ç›®ï¼šè¡¨æ ¼å½¢å¼æ˜¾ç¤ºå¯ç”¨çš„ tar.gz æ–‡ä»¶
                                def frontendDir = new File("${artifactsDir}/frontend/${projectName}")

                                if (!frontendDir.exists()) {
                                    return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ å‰ç«¯é¡¹ç›®ç›®å½•ä¸å­˜åœ¨</div>'
                                }

                                def tarFiles = frontendDir.listFiles()?.findAll { file ->
                                    file.isFile() && file.name.endsWith('.tar.gz')
                                }?.sort { a, b -> b.lastModified() <=> a.lastModified() }

                                if (!tarFiles || tarFiles.isEmpty()) {
                                    return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ æœªæ‰¾åˆ°å‰ç«¯æ„å»ºäº§ç‰©</div>'
                                }

                                def html = new StringBuilder()
                                html.append('<div style="font-family: Arial, sans-serif; padding: 15px; background: #f8f9fa; border-radius: 5px;">')
                                html.append('<h3 style="margin-top: 0; color: #333;">ğŸŒ é€‰æ‹©å‰ç«¯ç‰ˆæœ¬</h3>')
                                html.append('<div style="color: #666; margin-bottom: 15px;">é¡¹ç›®: <strong>' + projectName + '</strong> | å…± ' + tarFiles.size() + ' ä¸ªç‰ˆæœ¬</div>')

                                html.append('<div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 500px; overflow-y: auto;">')
                                html.append('<table style="width: 100%; border-collapse: collapse;">')
                                html.append('<thead style="position: sticky; top: 0; background: white; z-index: 10;">')
                                html.append('<tr style="background: #f5f5f5;">')
                                html.append('<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd; width: 40px;"></th>')
                                html.append('<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">ç‰ˆæœ¬</th>')
                                html.append('<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">æ„å»ºæ—¶é—´</th>')
                                html.append('<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">å¤§å°</th>')
                                html.append('</tr>')
                                html.append('</thead>')
                                html.append('<tbody>')

                                tarFiles.eachWithIndex { file, index ->
                                    def fileName = file.name
                                    def date = new Date(file.lastModified()).format('yyyy-MM-dd HH:mm:ss')
                                    def sizeMB = file.length() / 1024.0 / 1024.0
                                    def size = String.format('%.2f MB', sizeMB)

                                    def versionDisplay = fileName.replace('.tar.gz', '')

                                    def rowStyle = index == 0 ? 'background: #e3f2fd;' : (index % 2 == 0 ? 'background: #fafafa;' : '')
                                    def badge = index == 0 ? '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px;">æœ€æ–°</span>' : ''

                                    html.append('<tr style="' + rowStyle + '">')
                                    html.append('<td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">')
                                    html.append('<input type="radio" name="value" value="frontend:' + fileName + '"' + (index == 0 ? ' checked' : '') + '>')
                                    html.append('</td>')
                                    html.append('<td style="padding: 10px; border-bottom: 1px solid #eee; font-family: Consolas, monospace; font-size: 13px;">')
                                    html.append(versionDisplay + badge)
                                    html.append('</td>')
                                    html.append('<td style="padding: 10px; border-bottom: 1px solid #eee; color: #666;">' + date + '</td>')
                                    html.append('<td style="padding: 10px; border-bottom: 1px solid #eee; color: #666; font-weight: 500;">' + size + '</td>')
                                    html.append('</tr>')
                                }

                                html.append('</tbody>')
                                html.append('</table>')

                                html.append('<div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ff9800; border-radius: 3px;">')
                                html.append('<strong>ğŸ’¡ æç¤ºï¼š</strong> é»˜è®¤é€‰ä¸­æœ€æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡»å…¶ä»–è¡Œå¯åˆ‡æ¢ç‰ˆæœ¬')
                                html.append('</div>')

                                html.append('</div>')
                                html.append('</div>')

                                return html.toString()
                            }

                            // åç«¯é¡¹ç›®é€»è¾‘ - ä½¿ç”¨ä¸‹æ‹‰æ¡†
                            if (!MODULES || MODULES.trim().isEmpty() || MODULES == '(å‰ç«¯é¡¹ç›®æ— éœ€é€‰æ‹©æ¨¡å—)') {
                                return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ è¯·å…ˆé€‰æ‹©æ¨¡å—</div>'
                            }

                            def selectedModules = MODULES.split(',').collect { it.trim() }.findAll { it }

                            if (selectedModules.isEmpty()) {
                                return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ è¯·å…ˆé€‰æ‹©æ¨¡å—</div>'
                            }

                            def html = new StringBuilder()
                            html.append('<div style="font-family: Arial, sans-serif; padding: 15px; background: #f8f9fa; border-radius: 5px;">')
                            html.append('<h3 style="margin-top: 0; color: #333;">ğŸ“¦ ä¸ºæ¯ä¸ªæ¨¡å—é€‰æ‹©ç‰ˆæœ¬</h3>')
                            html.append('<div style="color: #666; margin-bottom: 15px;">é¡¹ç›®: <strong>' + projectName + '</strong> | å·²é€‰æ‹© ' + selectedModules.size() + ' ä¸ªæ¨¡å—</div>')

                            selectedModules.eachWithIndex { module, moduleIndex ->
                                def artifactPath = artifactsDir + '/backend/' + projectName + '/' + module
                                def dir = new File(artifactPath)

                                html.append('<div style="margin-bottom: 20px; padding: 0; background: white; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">')

                                // æ¨¡å—æ ‡é¢˜æ 
                                html.append('<div style="padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; font-size: 15px;">')
                                html.append('<span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 3px; margin-right: 10px;">' + (moduleIndex + 1) + '</span>')
                                html.append(module)
                                html.append('</div>')

                                if (!dir.exists()) {
                                    html.append('<div style="padding: 15px; color: #dc3545;">âŒ æ¨¡å—ç›®å½•ä¸å­˜åœ¨</div>')
                                } else {
                                    def files = dir.listFiles()?.findAll { file ->
                                        file.isFile() &&
                                        !file.name.endsWith('.json') &&
                                        file.name.endsWith('.jar')
                                    }

                                    if (!files || files.isEmpty()) {
                                        html.append('<div style="padding: 15px; color: #dc3545;">âŒ æ²¡æœ‰å¯ç”¨ç‰ˆæœ¬</div>')
                                    } else {
                                        files.sort { a, b -> b.lastModified() <=> a.lastModified() }

                                        html.append('<div style="padding: 15px;">')
                                        html.append('<select name="value" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background: white;">')

                                        files.eachWithIndex { file, index ->
                                            def fileName = file.name
                                            if (fileName.startsWith(module + '-') && fileName.endsWith('.jar')) {
                                                def version = fileName.substring(module.length() + 1, fileName.length() - 4)
                                                def date = new Date(file.lastModified()).format('yyyy-MM-dd HH:mm:ss')
                                                def sizeMB = file.length() / 1024.0 / 1024.0
                                                def size = String.format('%.2f MB', sizeMB)

                                                def badge = index == 0 ? ' ğŸŒŸ æœ€æ–°' : ''
                                                def selected = index == 0 ? ' selected' : ''

                                                html.append('<option value="' + module + ':' + version + '"' + selected + '>')
                                                html.append(version + badge + ' (' + date + ', ' + size + ')')
                                                html.append('</option>')
                                            }
                                        }

                                        html.append('</select>')

                                        html.append('<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 3px; color: #666; font-size: 12px;">')
                                        html.append('ğŸ“Š å…± ' + files.size() + ' ä¸ªç‰ˆæœ¬å¯é€‰ | é»˜è®¤é€‰ä¸­æœ€æ–°ç‰ˆæœ¬')
                                        html.append('</div>')

                                        html.append('</div>')
                                    }
                                }

                                html.append('</div>')
                            }

                            html.append('<div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 3px;">')
                            html.append('<strong>ğŸ’¡ æç¤ºï¼š</strong> æ¯ä¸ªæ¨¡å—é»˜è®¤é€‰ä¸­æœ€æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥åˆ†åˆ«ä¸ºä¸åŒæ¨¡å—é€‰æ‹©ä¸åŒç‰ˆæœ¬')
                            html.append('</div>')

                            html.append('</div>')

                            return html.toString()

                        } catch (Exception e) {
                            return '<div style="color: red;">è¯»å–ç‰ˆæœ¬å¤±è´¥: ' + e.message + '</div>'
                        }
                    '''
				]
			],
			description: 'é€‰æ‹©ç‰ˆæœ¬'
		],
		[$class: 'DynamicReferenceParameter',
			choiceType: 'ET_FORMATTED_HTML',
			name: 'DEPLOY_HOSTS',
			referencedParameters: 'PROJECT',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
				import groovy.json.JsonSlurper

				def configFile = '/data/deployments/servers-config.json'

				try {
					def projectMatch = PROJECT =~ /^\\[(åç«¯|å‰ç«¯)\\]\\s+(.+)$/
					if (!projectMatch.find()) {
						return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ é¡¹ç›®æ ¼å¼é”™è¯¯</div>'
					}

					def projectType = projectMatch.group(1)
					def projectName = projectMatch.group(2)

					def configFileObj = new File(configFile)
					if (!configFileObj.exists()) {
						return '<div style="padding: 10px; background: #ffebee; border-radius: 5px;">âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: ' + configFile + '</div>'
					}

					def jsonSlurper = new JsonSlurper()
					def config = jsonSlurper.parse(configFileObj)

					def projectConfig = config.projects[projectName]
					if (!projectConfig) {
						return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ é¡¹ç›® <strong>' + projectName + '</strong> çš„é…ç½®ä¸å­˜åœ¨</div>'
					}

					if (projectConfig.hosts && projectConfig.hosts instanceof List && !projectConfig.hosts.isEmpty()) {
						def hosts = projectConfig.hosts

						def html = new StringBuilder()
						html.append('<div style="font-family: Arial, sans-serif; padding: 15px; background: #f8f9fa; border-radius: 5px;">')
						html.append('<h3 style="margin-top: 0; color: #333;">ğŸ–¥ï¸ é€‰æ‹©éƒ¨ç½²èŠ‚ç‚¹</h3>')
						html.append('<div style="color: #666; margin-bottom: 15px;">')
						html.append('é¡¹ç›®: <strong>' + projectName + '</strong> ')
						html.append('<span style="background: ' + (projectType == 'å‰ç«¯' ? '#e3f2fd' : '#f3e5f5') + '; color: ' + (projectType == 'å‰ç«¯' ? '#1976d2' : '#7b1fa2') + '; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-left: 8px;">' + projectType + '</span>')
						html.append(' | å…± ' + hosts.size() + ' ä¸ªèŠ‚ç‚¹å¯ç”¨')
						html.append('</div>')

						html.append('<div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">')

						html.append('<div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-radius: 4px;">')
						html.append('<label style="cursor: pointer; display: flex; align-items: center;">')
						html.append('<input type="checkbox" id="selectAllHosts" checked style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">')
						html.append('<span style="font-weight: bold; color: #1976d2;">âœ… å…¨é€‰ / å–æ¶ˆå…¨é€‰</span>')
						html.append('</label>')
						html.append('</div>')

						html.append('<script>')
						html.append('(function() {')
						html.append('  var selectAllCheckbox = document.getElementById("selectAllHosts");')
						html.append('  if (selectAllCheckbox) {')
						html.append('    selectAllCheckbox.addEventListener("change", function() {')
						html.append('      var checkboxes = document.querySelectorAll("input.host-checkbox[type=\\'checkbox\\']");')
						html.append('      checkboxes.forEach(function(cb) { cb.checked = this.checked; }.bind(this));')
						html.append('    });')
						html.append('  }')
						html.append('  ')
						html.append('  // ç›‘å¬å•ä¸ªå¤é€‰æ¡†å˜åŒ–ï¼Œæ›´æ–°å…¨é€‰çŠ¶æ€')
						html.append('  var hostCheckboxes = document.querySelectorAll("input.host-checkbox[type=\\'checkbox\\']");')
						html.append('  hostCheckboxes.forEach(function(cb) {')
						html.append('    cb.addEventListener("change", function() {')
						html.append('      var allChecked = Array.from(hostCheckboxes).every(function(c) { return c.checked; });')
						html.append('      var anyChecked = Array.from(hostCheckboxes).some(function(c) { return c.checked; });')
						html.append('      if (selectAllCheckbox) {')
						html.append('        selectAllCheckbox.checked = allChecked;')
						html.append('        selectAllCheckbox.indeterminate = anyChecked && !allChecked;')
						html.append('      }')
						html.append('    });')
						html.append('  });')
						html.append('})();')
						html.append('</script>')

						html.append('<div style="display: grid; gap: 10px;">')

						hosts.eachWithIndex { hostConfig, index ->
							def name = hostConfig.name ?: "èŠ‚ç‚¹ ${index + 1}"
							def host = hostConfig.host ?: "æœªçŸ¥"
							def user = hostConfig.user ?: "æœªçŸ¥"
							def description = hostConfig.description ?: ""

							html.append('<div style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px; background: #fafafa; transition: all 0.2s; position: relative;">')
							html.append('<label style="cursor: pointer; display: flex; align-items: start;">')

							html.append('<input type="checkbox" class="host-checkbox" name="value" value="' + index + '" checked style="width: 18px; height: 18px; margin-right: 12px; margin-top: 2px; cursor: pointer; flex-shrink: 0;">')

							html.append('<div style="flex: 1;">')
							html.append('<div style="font-weight: bold; font-size: 15px; color: #333; margin-bottom: 6px;">')
							html.append('<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-right: 8px;">' + index + '</span>')
							html.append(name)
							if (description) {
								html.append('<span style="color: #999; font-size: 12px; font-weight: normal; margin-left: 8px;">(' + description + ')</span>')
							}
							html.append('</div>')

							html.append('<div style="font-size: 13px; color: #666; margin-bottom: 4px;">')
							html.append('ğŸŒ ä¸»æœº: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-family: Consolas, monospace;">' + host + '</code>')
							html.append('</div>')

							html.append('<div style="font-size: 13px; color: #666;">')
							html.append('ğŸ‘¤ ç”¨æˆ·: <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-family: Consolas, monospace;">' + user + '</code>')
							html.append('</div>')

							html.append('</div>')
							html.append('</label>')
							html.append('</div>')
						}

						html.append('</div>')

						html.append('<div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ff9800; border-radius: 3px;">')
						html.append('<strong>ğŸ’¡ æç¤ºï¼š</strong>')
						html.append('<ul style="margin: 8px 0 0 0; padding-left: 20px; color: #666; font-size: 13px;">')
						html.append('<li>é»˜è®¤å…¨é€‰æ‰€æœ‰èŠ‚ç‚¹</li>')
						html.append('<li>å–æ¶ˆå‹¾é€‰å¯è·³è¿‡æŸäº›èŠ‚ç‚¹</li>')
						html.append('<li><strong>ç°åº¦å‘å¸ƒ</strong>ï¼šå…ˆåªé€‰ä»èŠ‚ç‚¹ï¼ŒéªŒè¯åå†å‘å¸ƒä¸»èŠ‚ç‚¹</li>')
						html.append('<li>è‡³å°‘é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æ‰èƒ½ç»§ç»­</li>')
						html.append('</ul>')
						html.append('</div>')

						html.append('</div>')
						html.append('</div>')

						return html.toString()

					} else {
						def host = projectConfig.host ?: "æœªé…ç½®"
						def user = projectConfig.user ?: "æœªé…ç½®"
						def baseDir = projectConfig.baseDir ?: "æœªé…ç½®"
						def description = projectConfig.description ?: ""

						return """
							<div style="font-family: Arial, sans-serif; padding: 15px; background: #e8f5e9; border-radius: 5px; border-left: 4px solid #4caf50;">
								<input type="hidden" name="value" value="SINGLE_HOST">
								<div style="font-size: 14px; color: #2e7d32;">
									<div style="font-weight: bold; font-size: 16px; margin-bottom: 10px;">
										ğŸ–¥ï¸ å•ä¸»æœºé¡¹ç›®
										<span style="background: ${projectType == 'å‰ç«¯' ? '#e3f2fd' : '#f3e5f5'}; color: ${projectType == 'å‰ç«¯' ? '#1976d2' : '#7b1fa2'}; padding: 2px 8px; border-radius: 3px; font-size: 12px; margin-left: 8px;">${projectType}</span>
									</div>
									<div style="margin-top: 8px; color: #666;">
										<div style="margin-bottom: 6px;">
											<strong>é¡¹ç›®ï¼š</strong>${projectName}
											${description ? '<span style="color: #999;">(' + description + ')</span>' : ''}
										</div>
										<div style="margin-bottom: 6px;">
											<strong>ç›®æ ‡ä¸»æœºï¼š</strong><code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${host}</code>
										</div>
										<div style="margin-bottom: 6px;">
											<strong>ç”¨æˆ·ï¼š</strong><code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${user}</code>
										</div>
										<div>
											<strong>éƒ¨ç½²ç›®å½•ï¼š</strong><code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${baseDir}</code>
										</div>
									</div>
									<div style="margin-top: 12px; padding: 10px; background: #fff9c4; border-radius: 3px; color: #f57f17; font-size: 12px;">
										â„¹ï¸ æ— éœ€é€‰æ‹©èŠ‚ç‚¹ï¼Œå°†è‡ªåŠ¨éƒ¨ç½²åˆ°é…ç½®çš„æœåŠ¡å™¨
									</div>
								</div>
							</div>
						"""
					}

				} catch (Exception e) {
					return '<div style="color: red; padding: 10px; background: #ffebee; border-radius: 5px;">âŒ è¯»å–é…ç½®å¤±è´¥: ' + e.message + '<br><br><pre style="background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto;">' + e.toString() + '</pre></div>'
				}
			'''
				]
			],
			description: 'é€‰æ‹©è¦éƒ¨ç½²çš„èŠ‚ç‚¹ï¼ˆå¤šä¸»æœºé¡¹ç›®å¯å¤šé€‰ï¼‰'
		],


		booleanParam(
			name: 'SKIP_HEALTH_CHECK',
			defaultValue: false,
			description: 'è·³è¿‡å¥åº·æ£€æŸ¥'
		),

		booleanParam(
			name: 'PARALLEL_DEPLOY',
			defaultValue: false,
			description: 'å¹¶è¡Œå‘å¸ƒï¼ˆåŒæ—¶å‘å¸ƒå¤šä¸ªæ¨¡å—ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œä»…åç«¯ï¼‰'
		)
	])
])

pipeline {
	agent any

	environment {
		CONFIG_FILE = '/data/deployments/servers-config.json'
		DEPLOYMENT_FILE = '/data/deployments/production-deployment.json'
		ARTIFACTS_DIR = '/data/artifacts'
	}

	stages {
		stage('è§£æå‚æ•°') {
			steps {
				script {
					echo "=========================================="
					echo "ğŸ“‹ è§£ææ„å»ºå‚æ•°"
					echo "=========================================="

					def projectInfo = parseProjectInfo(params.PROJECT)
					if (!projectInfo) {
						error "âŒ é¡¹ç›®æ ¼å¼é”™è¯¯: ${params.PROJECT}"
					}

					env.PROJECT_TYPE_CN = projectInfo.typeCn
					env.PROJECT_NAME = projectInfo.name
					env.PROJECT_TYPE = (projectInfo.typeCn == 'åç«¯') ? 'backend' : 'frontend'

					echo """
					é¡¹ç›®åç§°: ${env.PROJECT_NAME}
					é¡¹ç›®ç±»å‹: ${env.PROJECT_TYPE_CN}
					==========================================
					åŸå§‹å‚æ•°è°ƒè¯•
					==========================================
					DEPLOY_HOSTS åŸå§‹å€¼: '${params.DEPLOY_HOSTS}'
					DEPLOY_HOSTS ç±»å‹: ${params.DEPLOY_HOSTS?.getClass()}
					DEPLOY_HOSTS é•¿åº¦: ${params.DEPLOY_HOSTS?.length()}
					==========================================
					"""


					def deploymentPlan = [:]

					if (env.PROJECT_TYPE == 'backend') {
						def versionSelections = params.MODULE_VERSION_SELECTORS

						if (!versionSelections || versionSelections.trim().isEmpty()) {
							error "âŒ è¯·ä¸ºæ¯ä¸ªæ¨¡å—é€‰æ‹©ç‰ˆæœ¬"
						}

						echo ""
						echo "å¼€å§‹è§£æç‰ˆæœ¬é€‰æ‹©..."

						versionSelections.split(',').eachWithIndex { selection, index ->
							echo "  [${index}] åŸå§‹é€‰é¡¹: '${selection}'"

							def parts = selection.trim().split(':')
							echo "      åˆ†å‰²åé•¿åº¦: ${parts.length}"

							if (parts.length >= 2) {
								def module = parts[0].trim()
								def version = parts[1].trim()

								echo "      æ¨¡å—: '${module}'"
								echo "      ç‰ˆæœ¬: '${version}'"

								deploymentPlan[module] = version
								echo "      âœ… å·²æ·»åŠ åˆ°éƒ¨ç½²è®¡åˆ’"
							} else {
								echo "      âš ï¸ æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡"
							}
						}

						if (deploymentPlan.isEmpty()) {
							error "âŒ æœªèƒ½è§£æåˆ°ä»»ä½•æ¨¡å—ç‰ˆæœ¬ä¿¡æ¯"
						}
					} else {
						def versionSelection = params.MODULE_VERSION_SELECTORS

						echo ""
						echo "å‰ç«¯ç‰ˆæœ¬é€‰æ‹©åŸå§‹å€¼:"
						echo "---"
						echo versionSelection
						echo "---"

						if (!versionSelection || versionSelection.trim().isEmpty()) {
							error "âŒ è¯·é€‰æ‹©å‰ç«¯ç‰ˆæœ¬"
						}
						versionSelection = versionSelection.trim().replaceAll(/[,\s]+$/, '')
						def parts = versionSelection.trim().split(':')
						if (parts.length == 2 && parts[0] == 'frontend') {
							def tarFileName = parts[1].trim().replaceAll(/[,\s]+$/, '')
							deploymentPlan['frontend'] = tarFileName

							echo "å‰ç«¯ç‰ˆæœ¬: ${tarFileName}"

							def metadataFile = "${env.ARTIFACTS_DIR}/frontend/${env.PROJECT_NAME}/${tarFileName}.json"
							if (fileExists(metadataFile)) {
								try {
									def metadata = readJSON file: metadataFile
									echo "Git Commit: ${metadata.gitCommit ?: 'unknown'}"
									echo "Git Branch: ${metadata.gitBranch ?: 'unknown'}"
									echo "æ„å»ºæ—¶é—´: ${metadata.buildTime ?: 'unknown'}"
								} catch (Exception e) {
									echo "âš ï¸ è¯»å–å…ƒæ•°æ®å¤±è´¥: ${e.message}"
								}
							}
						} else {
							error "âŒ å‰ç«¯ç‰ˆæœ¬é€‰æ‹©æ ¼å¼é”™è¯¯"
						}
					}

					// ä¿å­˜éƒ¨ç½²è®¡åˆ’
					env.DEPLOYMENT_PLAN = writeJSON returnText: true, json: deploymentPlan

					echo ""
					echo "=========================================="
					echo "éƒ¨ç½²è®¡åˆ’"
					echo "=========================================="
					echo "JSON æ ¼å¼:"
					echo env.DEPLOYMENT_PLAN
					echo ""
					echo "è¯¦ç»†åˆ—è¡¨:"
					deploymentPlan.each { module, version ->
						echo "  âœ“ ${module}: ${version}"
					}
					echo ""
					if (env.PROJECT_TYPE == 'backend') {
						echo "å¹¶è¡Œå‘å¸ƒ: ${params.PARALLEL_DEPLOY ? 'æ˜¯' : 'å¦'}"
					}
					echo "è·³è¿‡å¥åº·æ£€æŸ¥: ${params.SKIP_HEALTH_CHECK ? 'æ˜¯' : 'å¦'}"
					echo "=========================================="


					echo ""
					echo "=========================================="
					echo "ğŸ–¥ï¸ è§£æèŠ‚ç‚¹é€‰æ‹©"
					echo "=========================================="

					def deployHosts = params.DEPLOY_HOSTS?.trim() ?: ''

					echo "åŸå§‹å€¼: '${deployHosts}'"

					if (deployHosts == 'SINGLE_HOST') {
						// å•ä¸»æœºé¡¹ç›®
						env.SELECTED_HOSTS = 'ALL'
						echo "âœ“ èŠ‚ç‚¹ç±»å‹: å•ä¸»æœºé¡¹ç›®"
						echo "âœ“ éƒ¨ç½²ç­–ç•¥: è‡ªåŠ¨éƒ¨ç½²åˆ°å”¯ä¸€ä¸»æœº"
					} else if (deployHosts.isEmpty() || deployHosts == '') {

						echo "âš ï¸ è­¦å‘Š: DEPLOY_HOSTS å‚æ•°ä¸ºç©º"
						echo "âš ï¸ è¿™å¯èƒ½æ˜¯å‚æ•°ä¼ é€’é—®é¢˜"

						def config = readJSON file: env.CONFIG_FILE
						def projectConfig = config.projects[env.PROJECT_NAME]

						if (projectConfig?.hosts && projectConfig.hosts instanceof List) {

							env.SELECTED_HOSTS = 'ALL'
							echo "âœ“ æ£€æµ‹åˆ°å¤šä¸»æœºé¡¹ç›®ï¼Œé»˜è®¤å…¨é€‰ï¼ˆ${projectConfig.hosts.size()} å°ï¼‰"
						} else {

							env.SELECTED_HOSTS = 'ALL'
							echo "âœ“ æ£€æµ‹åˆ°å•ä¸»æœºé¡¹ç›®"
						}
					} else {

						env.SELECTED_HOSTS = deployHosts
						def indices = deployHosts.split(',')

						echo "âœ“ èŠ‚ç‚¹ç±»å‹: å¤šä¸»æœºé¡¹ç›®"
						echo "âœ“ é€‰æ‹©èŠ‚ç‚¹æ•°: ${indices.length}"
						echo "âœ“ èŠ‚ç‚¹ç´¢å¼•: ${deployHosts}"

						indices.eachWithIndex { idx, i ->
							echo "  ${i + 1}. ç´¢å¼• ${idx.trim()}"
						}
					}

					echo "=========================================="
				}
			}
		}


		stage('è¯»å–é…ç½®') {
			steps {
				script {
					echo "=========================================="
					echo "ğŸ“– è¯»å–æœåŠ¡å™¨é…ç½®"
					echo "=========================================="

					def config = readJSON file: env.CONFIG_FILE
					def projectConfig = config.projects[env.PROJECT_NAME]

					if (!projectConfig) {
						error "âŒ é¡¹ç›®é…ç½®ä¸å­˜åœ¨: ${env.PROJECT_NAME}"
					}


					if (projectConfig.hosts) {

						env.DEPLOY_MODE = 'MULTI_HOST'

						def allHosts = projectConfig.hosts
						def selectedHosts = []

						if (env.SELECTED_HOSTS == 'ALL') {

							selectedHosts = allHosts
							echo "éƒ¨ç½²æ¨¡å¼: å¤šä¸»æœºéƒ¨ç½²ï¼ˆå…¨éƒ¨ ${allHosts.size()} ä¸ªèŠ‚ç‚¹ï¼‰"
						} else {

							try {
								def indices = env.SELECTED_HOSTS.split(',').collect { it.trim().toInteger() }

								indices.each { index ->
									if (index >= 0 && index < allHosts.size()) {
										selectedHosts << allHosts[index]
									} else {
										echo "âš ï¸ è­¦å‘Šï¼šç´¢å¼• ${index} è¶…å‡ºèŒƒå›´ï¼ˆ0-${allHosts.size()-1}ï¼‰ï¼Œå·²å¿½ç•¥"
									}
								}
							} catch (Exception e) {
								echo "âš ï¸ è­¦å‘Šï¼šè§£æèŠ‚ç‚¹ç´¢å¼•å¤±è´¥ï¼Œä½¿ç”¨å…¨éƒ¨èŠ‚ç‚¹"
								echo "é”™è¯¯: ${e.message}"
								selectedHosts = allHosts
							}

							echo "éƒ¨ç½²æ¨¡å¼: å¤šä¸»æœºéƒ¨ç½²ï¼ˆé€‰æ‹© ${selectedHosts.size()} ä¸ªèŠ‚ç‚¹ï¼‰"
						}

						if (selectedHosts.isEmpty()) {
							error "âŒ æœªé€‰æ‹©ä»»ä½•æœ‰æ•ˆçš„éƒ¨ç½²èŠ‚ç‚¹"
						}


						env.HOSTS_CONFIG = writeJSON returnText: true, json: selectedHosts
						env.BASE_DIR = selectedHosts[0].baseDir

						echo ""
						echo "ğŸ“Š èŠ‚ç‚¹ä¿¡æ¯:"
						echo "  å¯ç”¨èŠ‚ç‚¹æ€»æ•°: ${allHosts.size()}"
						echo "  é€‰æ‹©éƒ¨ç½²èŠ‚ç‚¹: ${selectedHosts.size()}"
						echo ""


						echo "ğŸ“‹ æ‰€æœ‰å¯ç”¨èŠ‚ç‚¹:"
						allHosts.eachWithIndex { hostConfig, index ->
							def selected = selectedHosts.contains(hostConfig) ? "âœ…" : "â¬œ"
							echo "  ${selected} [${index}] ${hostConfig.name} (${hostConfig.host})"
						}
						echo ""


						echo "ğŸ¯ å°†è¦éƒ¨ç½²åˆ°ä»¥ä¸‹èŠ‚ç‚¹:"
						selectedHosts.eachWithIndex { hostConfig, index ->
							echo "  ${index + 1}. ${hostConfig.name} (${hostConfig.host})"
						}
						echo ""
						echo "éƒ¨ç½²ç›®å½•: ${env.BASE_DIR}"

					} else {

						env.DEPLOY_MODE = 'SINGLE_HOST'
						env.HOST = projectConfig.host
						env.USER = projectConfig.user
						env.BASE_DIR = projectConfig.baseDir

						echo "éƒ¨ç½²æ¨¡å¼: å•ä¸»æœºéƒ¨ç½²"
						echo "ç›®æ ‡ä¸»æœº: ${env.HOST}"
						echo "ç”¨æˆ·: ${env.USER}"
						echo "éƒ¨ç½²ç›®å½•: ${env.BASE_DIR}"
					}

					echo "=========================================="
				}
			}
		}

		stage('æ£€æŸ¥åˆ¶å“') {
			steps {
				script {
					echo "=========================================="
					echo "æ£€æŸ¥æ‰€æœ‰åˆ¶å“æ˜¯å¦å­˜åœ¨"
					echo "=========================================="

					def deploymentPlan = readJSON text: env.DEPLOYMENT_PLAN
					def missingArtifacts = []

					if (env.PROJECT_TYPE == 'frontend') {
						def tarFileName = deploymentPlan['frontend']
						def artifactFile = "${env.ARTIFACTS_DIR}/frontend/${env.PROJECT_NAME}/${tarFileName}"

						if (!fileExists(artifactFile)) {
							missingArtifacts << "  âŒ ${tarFileName}"
							echo "  âŒ å‰ç«¯åˆ¶å“ä¸å­˜åœ¨: ${artifactFile}"
						} else {
							def fileSize = sh(script: "du -h '${artifactFile}' | cut -f1", returnStdout: true).trim()
							echo "  âœ… å‰ç«¯åˆ¶å“ (${tarFileName}): ${fileSize}"
						}
					} else {
						deploymentPlan.each { module, version ->
							def artifactFile = "${env.ARTIFACTS_DIR}/backend/${env.PROJECT_NAME}/${module}/${module}-${version}.jar"

							if (!fileExists(artifactFile)) {
								missingArtifacts << "  âŒ ${module} (${version})"
								echo "  âŒ ${module}: åˆ¶å“ä¸å­˜åœ¨"
							} else {
								def fileSize = sh(script: "du -h '${artifactFile}' | cut -f1", returnStdout: true).trim()
								echo "  âœ… ${module} (${version}): ${fileSize}"
							}
						}
					}

					if (!missingArtifacts.isEmpty()) {
						error "âŒ ä»¥ä¸‹åˆ¶å“ä¸å­˜åœ¨:\n${missingArtifacts.join('\n')}"
					}

					echo "=========================================="
					echo "âœ… æ‰€æœ‰åˆ¶å“æ£€æŸ¥é€šè¿‡"
					echo "=========================================="
				}
			}
		}

		stage('ç¡®è®¤å‘å¸ƒ') {
			steps {
				script {
					def deploymentPlan = readJSON text: env.DEPLOYMENT_PLAN

					def message = """
========================================
âš ï¸  ç¡®è®¤å‘å¸ƒï¼Ÿ
========================================
é¡¹ç›®: ${env.PROJECT_NAME}
ç±»å‹: ${env.PROJECT_TYPE_CN}
"""


					if (env.DEPLOY_MODE == 'MULTI_HOST') {
						def hostsConfig = readJSON text: env.HOSTS_CONFIG
						def config = readJSON file: env.CONFIG_FILE
						def allHostsCount = config.projects[env.PROJECT_NAME].hosts.size()

						message += """
éƒ¨ç½²æ¨¡å¼: å¤šä¸»æœºéƒ¨ç½²
å¯ç”¨èŠ‚ç‚¹: ${allHostsCount} å°
é€‰æ‹©èŠ‚ç‚¹: ${hostsConfig.size()} å°

å°†è¦éƒ¨ç½²åˆ°:
"""
						hostsConfig.eachWithIndex { hostConfig, index ->
							message += "  ${index + 1}. ${hostConfig.name} (${hostConfig.host})\n"
						}
						message += "\n"
					} else {
						message += """
æœåŠ¡å™¨: ${env.HOST}

"""
					}


					if (env.PROJECT_TYPE == 'frontend') {
						message += "å‰ç«¯ç‰ˆæœ¬: ${deploymentPlan['frontend']}\n\n"
					} else {
						message += "éƒ¨ç½²è®¡åˆ’:\n"

						if (deploymentPlan && !deploymentPlan.isEmpty()) {
							deploymentPlan.each { module, version ->
								message += "  - ${module}: ${version}\n"
							}
						} else {
							message += "  (æ— )\n"
						}

						message += "\n"
						message += "å¹¶è¡Œå‘å¸ƒ: ${params.PARALLEL_DEPLOY ? 'æ˜¯' : 'å¦'}\n"
					}

					message += "è·³è¿‡å¥åº·æ£€æŸ¥: ${params.SKIP_HEALTH_CHECK ? 'æ˜¯' : 'å¦'}\n"
					message += """
âš ï¸ æ­¤æ“ä½œå°†æ›´æ–°ç”Ÿäº§ç¯å¢ƒï¼
========================================
"""


					echo "=========================================="
					echo "ç¡®è®¤å‘å¸ƒå¼¹çª—å†…å®¹:"
					echo "=========================================="
					echo message
					echo "=========================================="
					echo "éƒ¨ç½²è®¡åˆ’ JSON:"
					echo env.DEPLOYMENT_PLAN
					echo "=========================================="

					timeout(time: 10, unit: 'MINUTES') {
						input message: message, ok: 'âœ… ç¡®è®¤å‘å¸ƒ'
					}
				}
			}
		}

		stage('æ‰¹é‡å‘å¸ƒ') {
			steps {
				script {
					def deploymentPlan = readJSON text: env.DEPLOYMENT_PLAN
					def currentTime = new Date().format('yyyy-MM-dd HH:mm:ss')
					def deployedBy = env.BUILD_USER ?: 'jenkins'
					def buildNum = env.BUILD_NUMBER.toInteger()

					echo "=========================================="
					echo "å¼€å§‹æ‰¹é‡å‘å¸ƒ"
					echo "=========================================="


					def deployResults = [:]

					if (env.PROJECT_TYPE == 'frontend') {

						echo "å‰ç«¯é¡¹ç›®å‘å¸ƒ..."

						try {
							deployFrontendProject(deploymentPlan['frontend'])


							def host = env.HOST
							deployResults[host] = [
								name: "å‰ç«¯æœåŠ¡å™¨",
								modules: [
									frontend: [
										version: deploymentPlan['frontend'],
										deployTime: currentTime,
										deployedBy: deployedBy,
										buildNumber: buildNum,
										status: 'success'
									]
								],
								lastDeployTime: currentTime
							]

						} catch (Exception e) {
							echo "âŒ å‰ç«¯éƒ¨ç½²å¤±è´¥: ${e.message}"

							def host = env.HOST
							deployResults[host] = [
								name: "å‰ç«¯æœåŠ¡å™¨",
								modules: [
									frontend: [
										version: deploymentPlan['frontend'],
										deployTime: currentTime,
										deployedBy: deployedBy,
										buildNumber: buildNum,
										status: 'failed',
										error: e.message
									]
								],
								lastDeployTime: currentTime
							]

							throw e
						}

					} else {

						if (params.PARALLEL_DEPLOY) {
							echo "ä½¿ç”¨å¹¶è¡Œæ¨¡å¼å‘å¸ƒ..."
							def parallelStages = [:]
							deploymentPlan.each { module, version ->
								parallelStages[module] = {
									deployBackendModule(module, version)
								}
							}
							parallel parallelStages


							if (env.DEPLOY_MODE == 'MULTI_HOST') {
								def hostsConfig = readJSON text: env.HOSTS_CONFIG

								hostsConfig.each { hostConfig ->
									def host = hostConfig.host
									def moduleResults = [:]

									deploymentPlan.each { module, version ->
										moduleResults[module] = [
											version: version,
											deployTime: currentTime,
											deployedBy: deployedBy,
											buildNumber: buildNum,
											status: 'success'
										]
									}

									deployResults[host] = [
										name: hostConfig.name,
										modules: moduleResults,
										lastDeployTime: currentTime
									]
								}
							} else {
								def host = env.HOST
								def moduleResults = [:]

								deploymentPlan.each { module, version ->
									moduleResults[module] = [
										version: version,
										deployTime: currentTime,
										deployedBy: deployedBy,
										buildNumber: buildNum,
										status: 'success'
									]
								}

								deployResults[host] = [
									name: "å•ä¸»æœº",
									modules: moduleResults,
									lastDeployTime: currentTime
								]
							}

						} else {
							echo "ä½¿ç”¨ä¸²è¡Œæ¨¡å¼å‘å¸ƒ..."


							if (env.DEPLOY_MODE == 'MULTI_HOST') {
								def hostsConfig = readJSON text: env.HOSTS_CONFIG

								hostsConfig.each { hostConfig ->
									def host = hostConfig.host
									deployResults[host] = [
										name: hostConfig.name,
										modules: [:],
										lastDeployTime: currentTime
									]
								}


								deploymentPlan.each { module, version ->
									echo "\n=========================================="
									echo "å‘å¸ƒæ¨¡å—: ${module}"
									echo "ç‰ˆæœ¬: ${version}"
									echo "=========================================="

									try {
										deployBackendModule(module, version)


										hostsConfig.each { hostConfig ->
											def host = hostConfig.host
											deployResults[host].modules[module] = [
												version: version,
												deployTime: currentTime,
												deployedBy: deployedBy,
												buildNumber: buildNum,
												status: 'success'
											]
										}

									} catch (Exception e) {
										echo "âŒ æ¨¡å— ${module} éƒ¨ç½²å¤±è´¥: ${e.message}"


										hostsConfig.each { hostConfig ->
											def host = hostConfig.host
											deployResults[host].modules[module] = [
												version: version,
												deployTime: currentTime,
												deployedBy: deployedBy,
												buildNumber: buildNum,
												status: 'failed',
												error: e.message
											]
										}

										throw e
									}
								}

							} else {

								def host = env.HOST
								def moduleResults = [:]

								deploymentPlan.each { module, version ->
									echo "\n=========================================="
									echo "å‘å¸ƒæ¨¡å—: ${module}"
									echo "ç‰ˆæœ¬: ${version}"
									echo "=========================================="

									try {
										deployBackendModule(module, version)

										moduleResults[module] = [
											version: version,
											deployTime: currentTime,
											deployedBy: deployedBy,
											buildNumber: buildNum,
											status: 'success'
										]

									} catch (Exception e) {
										echo "âŒ æ¨¡å— ${module} éƒ¨ç½²å¤±è´¥: ${e.message}"

										moduleResults[module] = [
											version: version,
											deployTime: currentTime,
											deployedBy: deployedBy,
											buildNumber: buildNum,
											status: 'failed',
											error: e.message
										]

										throw e
									}
								}

								deployResults[host] = [
									name: "å•ä¸»æœº",
									modules: moduleResults,
									lastDeployTime: currentTime
								]
							}
						}
					}


					env.DEPLOY_RESULTS = writeJSON returnText: true, json: deployResults

					echo "=========================================="
					echo "âœ… æ‰¹é‡å‘å¸ƒå®Œæˆ"
					echo "=========================================="
				}
			}
		}

		stage('æ›´æ–°çŠ¶æ€') {
			steps {
				script {
					echo "=========================================="
					echo "ğŸ“ æ›´æ–°å‘å¸ƒæ¸…å•ï¼ˆå¢é‡æ›´æ–° + å†å²ä¿ç•™ï¼‰"
					echo "=========================================="

					def manifestDir = '/data/deployments'
					def manifestFile = "${manifestDir}/production-deployment.json"
					def currentTime = new Date().format('yyyyMMdd-HHmmss')
					def newManifestFile = "${manifestDir}/production-deployment-${currentTime}.json"

					def manifest = [:]


					if (fileExists(manifestFile)) {
						try {
							manifest = readJSON file: manifestFile
							echo "âœ“ è¯»å–ç°æœ‰æ¸…å•æˆåŠŸ"
							echo "  å½“å‰æ¸…å•: ${manifestFile}"
						} catch (Exception e) {
							echo "âš ï¸ è¯»å–ç°æœ‰æ¸…å•å¤±è´¥ï¼Œåˆ›å»ºæ–°æ¸…å•: ${e.message}"
							manifest = [:]
						}
					} else {
						echo "âœ“ é¦–æ¬¡åˆ›å»ºæ¸…å•"
					}


					if (!manifest.projects) {
						manifest.projects = [:]
					}

					if (!manifest.projects[env.PROJECT_NAME]) {
						manifest.projects[env.PROJECT_NAME] = [:]
					}

					if (!manifest.projects[env.PROJECT_NAME].hosts) {
						manifest.projects[env.PROJECT_NAME].hosts = [:]
					}


					def deployResults = readJSON text: env.DEPLOY_RESULTS


					deployResults.each { host, result ->
						echo ""
						echo "æ›´æ–°ä¸»æœº: ${host} (${result.name})"


						if (!manifest.projects[env.PROJECT_NAME].hosts[host]) {
							echo "  âœ“ æ–°ä¸»æœºï¼Œåˆ›å»ºè®°å½•"
							manifest.projects[env.PROJECT_NAME].hosts[host] = [
								name: result.name,
								modules: [:],
								lastDeployTime: result.lastDeployTime
							]
						} else {
							echo "  âœ“ ä¸»æœºå·²å­˜åœ¨ï¼Œå¢é‡æ›´æ–°"
						}

						result.modules.each { module, moduleInfo ->
							def oldVersion = manifest.projects[env.PROJECT_NAME].hosts[host].modules[module]?.version

							if (oldVersion) {
								echo "  â€¢ ${module}: ${oldVersion} â†’ ${moduleInfo.version}"
							} else {
								echo "  â€¢ ${module}: æ–°å¢ ${moduleInfo.version}"
							}

							manifest.projects[env.PROJECT_NAME].hosts[host].modules[module] = moduleInfo
						}


						manifest.projects[env.PROJECT_NAME].hosts[host].lastDeployTime = result.lastDeployTime
						manifest.projects[env.PROJECT_NAME].hosts[host].name = result.name

						echo "  âœ“ ä¸»æœº ${host} æ›´æ–°å®Œæˆ"
					}


					def updateTime = new Date().format('yyyy-MM-dd HH:mm:ss')
					manifest.metadata = [
						lastUpdate: updateTime,
						version: '1.0',
						buildNumber: env.BUILD_NUMBER.toInteger(),
						deployedBy: env.BUILD_USER ?: 'jenkins'
					]


					writeJSON file: newManifestFile, json: manifest, pretty: 4
					echo ""
					echo "âœ… æ–°æ¸…å•å·²ç”Ÿæˆ: ${newManifestFile}"


					sh """
				cd ${manifestDir}

				# åˆ é™¤æ—§çš„è½¯é“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
				if [ -L production-deployment.json ]; then
					rm -f production-deployment.json
					echo "âœ“ åˆ é™¤æ—§è½¯é“¾æ¥"
				elif [ -f production-deployment.json ]; then
					# å¦‚æœæ˜¯æ™®é€šæ–‡ä»¶ï¼Œå¤‡ä»½ååˆ é™¤
					mv production-deployment.json production-deployment.json.backup
					echo "âœ“ å¤‡ä»½æ—§æ–‡ä»¶ä¸º production-deployment.json.backup"
				fi

				# åˆ›å»ºæ–°çš„è½¯é“¾æ¥
				ln -s production-deployment-${currentTime}.json production-deployment.json
				echo "âœ“ åˆ›å»ºæ–°è½¯é“¾æ¥æŒ‡å‘æœ€æ–°æ¸…å•"

				# æ˜¾ç¤ºå½“å‰è½¯é“¾æ¥
				ls -lh production-deployment.json
			"""


					sh """
				cd ${manifestDir}

				# ç»Ÿè®¡å†å²æ¸…å•æ•°é‡
				HISTORY_COUNT=\$(ls -1 production-deployment-*.json 2>/dev/null | wc -l)
				echo ""
				echo "ğŸ“Š å†å²æ¸…å•ç»Ÿè®¡:"
				echo "  å½“å‰æ•°é‡: \$HISTORY_COUNT"

				if [ "\$HISTORY_COUNT" -gt 10 ]; then
					echo "  ä¿ç•™æ•°é‡: 10"
					echo "  æ¸…ç†æ•°é‡: \$((HISTORY_COUNT - 10))"

					# åˆ é™¤æœ€æ—§çš„æ¸…å•ï¼ˆä¿ç•™æœ€è¿‘ 10 ä¸ªï¼‰
					ls -1t production-deployment-*.json | tail -n +11 | xargs rm -f
					echo "  âœ… å·²æ¸…ç†æ—§æ¸…å•"
				else
					echo "  âœ… æ— éœ€æ¸…ç†ï¼ˆæœªè¶…è¿‡ 10 ä¸ªï¼‰"
				fi

				echo ""
				echo "ğŸ“‹ å†å²æ¸…å•åˆ—è¡¨ï¼ˆæœ€è¿‘ 10 ä¸ªï¼‰:"
				ls -1t production-deployment-*.json | head -10 | while read file; do
					SIZE=\$(du -h "\$file" | cut -f1)
					TIME=\$(stat -c %y "\$file" | cut -d'.' -f1)
					echo "  â€¢ \$file (\$SIZE, \$TIME)"
				done
			"""

					echo ""
					echo "=========================================="
					echo "ğŸ“Š å½“å‰å®Œæ•´éƒ¨ç½²çŠ¶æ€ï¼ˆæ‰€æœ‰æ¨¡å—ï¼‰"
					echo "=========================================="

					manifest.projects[env.PROJECT_NAME].hosts.each { host, info ->
						echo ""
						echo "ğŸ–¥ï¸  ${info.name} (${host})"
						echo "   æœ€åéƒ¨ç½²: ${info.lastDeployTime}"
						echo "   æ¨¡å—æ€»æ•°: ${info.modules.size()}"
						echo ""

						info.modules.each { module, moduleInfo ->
							def statusIcon = moduleInfo.status == 'success' ? 'âœ…' : 'âŒ'
							def isNew = deployResults[host]?.modules?.containsKey(module)
							def badge = isNew ? " ğŸ†• æœ¬æ¬¡æ›´æ–°" : ""

							echo "     ${statusIcon} ${module}${badge}"
							echo "        ç‰ˆæœ¬: ${moduleInfo.version}"
							echo "        æ—¶é—´: ${moduleInfo.deployTime}"
							echo "        æ“ä½œäºº: ${moduleInfo.deployedBy}"
							echo "        æ„å»ºå·: #${moduleInfo.buildNumber}"
							if (moduleInfo.error) {
								echo "        é”™è¯¯: ${moduleInfo.error}"
							}
						}
					}

					echo ""
					echo "=========================================="
					echo "ğŸ“ æœ¬æ¬¡æ›´æ–°æ‘˜è¦"
					echo "=========================================="

					deployResults.each { host, result ->
						echo "  ${result.name} (${host}):"
						result.modules.each { module, moduleInfo ->
							echo "    âœ“ ${module}: ${moduleInfo.version}"
						}
					}

					echo ""
					echo "=========================================="
					echo "ğŸ“‚ æ¸…å•æ–‡ä»¶ä½ç½®"
					echo "=========================================="
					echo "  å½“å‰æ¸…å•: ${manifestFile} (è½¯é“¾æ¥)"
					echo "  æœ€æ–°æ¸…å•: ${newManifestFile}"
					echo "  å†å²ç›®å½•: ${manifestDir}"
					echo "=========================================="
				}
			}
		}


	}

	post {
		success {
			script {
				def deploymentPlan = readJSON text: env.DEPLOYMENT_PLAN

				echo ""
				echo "=========================================="
				echo "âœ… æ‰¹é‡å‘å¸ƒæˆåŠŸï¼"
				echo "=========================================="
				echo "é¡¹ç›®: ${env.PROJECT_NAME}"
				echo "ç±»å‹: ${env.PROJECT_TYPE_CN}"
				echo "æ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
				echo ""
				echo "å·²å‘å¸ƒçš„${env.PROJECT_TYPE == 'frontend' ? 'ç‰ˆæœ¬' : 'æ¨¡å—'}ï¼š"
				deploymentPlan.each { module, version ->
					echo "  âœ… ${module}: ${version}"
				}
				echo "=========================================="
			}
		}
		failure {
			echo "âŒ æ‰¹é‡å‘å¸ƒå¤±è´¥ï¼"
		}
	}
}

@NonCPS
def parseProjectInfo(String project) {
	def matcher = project =~ /^\[(åç«¯|å‰ç«¯)\]\s+(.+)$/
	if (!matcher.find()) {
		return null
	}
	return [
		typeCn: matcher.group(1),
		name: matcher.group(2)
	]
}

def deployBackendModule(String module, String version) {

	if (env.DEPLOY_MODE == 'MULTI_HOST') {

		def hostsConfig = readJSON text: env.HOSTS_CONFIG

		echo ""
		echo "=========================================="
		echo "ğŸ“¦ æ¨¡å—: ${module}"
		echo "ğŸ”„ å¤šä¸»æœºéƒ¨ç½²æ¨¡å¼ï¼ˆå…± ${hostsConfig.size()} å°ä¸»æœºï¼‰"
		echo "=========================================="

		hostsConfig.eachWithIndex { hostConfig, index ->
			echo ""
			echo "----------------------------------------"
			echo "ğŸ–¥ï¸  ä¸»æœº ${index + 1}/${hostsConfig.size()}: ${hostConfig.name} (${hostConfig.host})"
			echo "----------------------------------------"

			deployToSingleHost(
				module: module,
				version: version,
				host: hostConfig.host,
				user: hostConfig.user,
				baseDir: hostConfig.baseDir,
				hostName: hostConfig.name
			)

			echo "âœ… ä¸»æœº ${index + 1} éƒ¨ç½²å®Œæˆ"
		}

		echo ""
		echo "=========================================="
		echo "âœ… æ¨¡å— ${module} å·²æˆåŠŸéƒ¨ç½²åˆ°æ‰€æœ‰ ${hostsConfig.size()} å°ä¸»æœº"
		echo "=========================================="

	} else {
		deployToSingleHost(
			module: module,
			version: version,
			host: env.HOST,
			user: env.USER,
			baseDir: env.BASE_DIR,
			hostName: env.HOST
		)
	}
}

def deployToSingleHost(Map config) {
	def module = config.module
	def version = config.version
	def host = config.host
	def user = config.user
	def baseDir = config.baseDir
	def hostName = config.hostName


	def isDataPlatformJobs = env.PROJECT_NAME == 'zcf-data-platform-jobs'


	def modulePath
	if (isDataPlatformJobs) {
		modulePath = baseDir
	} else {
		modulePath = "${baseDir}/${module}"
	}

	def artifactFile = "${env.ARTIFACTS_DIR}/backend/${env.PROJECT_NAME}/${module}/${module}-${version}.jar"


	def jarName = "${module}.jar"

	echo "  [${module}@${hostName}] å¼€å§‹å‘å¸ƒ..."
	echo "  [${module}@${hostName}] æºæ–‡ä»¶: ${artifactFile}"
	echo "  [${module}@${hostName}] ç›®æ ‡è·¯å¾„: ${modulePath}/${jarName}"

	sshagent(['deploy-ssh-key']) {
		if (isDataPlatformJobs) {
			echo "  [${module}@${hostName}] 1/3 æ£€æŸ¥ç›®æ ‡ç›®å½•..."
			sh """
				ssh -o StrictHostKeyChecking=no ${user}@${host} '
					# åˆ›å»ºç›®æ ‡ç›®å½•
					mkdir -p ${modulePath}

					echo "âœ… ç›®æ ‡ç›®å½•å‡†å¤‡å®Œæˆ"

					# æ˜¾ç¤ºå½“å‰ç›®å½•ä¸‹è¯¥æ¨¡å—çš„å†å²ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰å¤‡ä»½ï¼‰
					echo ""
					echo "ğŸ“¦ ${module} å†å²å¤‡ä»½:"
					if ls ${modulePath}/${module}.jar.bak.* >/dev/null 2>&1; then
						ls -lh ${modulePath}/${module}.jar.bak.* | while read -r line; do
							filename=\$(echo "\$line" | awk "{print \\\$9}")
							size=\$(echo "\$line" | awk "{print \\\$5}")
							date=\$(echo "\$line" | awk "{print \\\$6, \\\$7, \\\$8}")
							echo "  \$filename (\$size, \$date)"
						done
					else
						echo "  (æ— )"
					fi
					echo ""
				'
			"""

			echo "  [${module}@${hostName}] 2/3 å¤‡ä»½ç°æœ‰ç‰ˆæœ¬..."
			sh """
				ssh -o StrictHostKeyChecking=no ${user}@${host} '
					cd ${modulePath}

					if [ -f ${jarName} ]; then
						BACKUP_FILE="${jarName}.bak.\$(date +%Y%m%d_%H%M%S)"
						mv ${jarName} "\$BACKUP_FILE"
						echo "âœ… ç°æœ‰ç‰ˆæœ¬å·²å¤‡ä»½ä¸º: \$BACKUP_FILE"

						# åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
						BACKUP_COUNT=\$(ls -t ${jarName}.bak.* 2>/dev/null | wc -l)
						if [ "\$BACKUP_COUNT" -gt 5 ]; then
							ls -t ${jarName}.bak.* | tail -n +6 | xargs rm -f
							echo "âœ… å·²æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰"
						fi
					else
						echo "â„¹ï¸ é¦–æ¬¡å‘å¸ƒï¼Œæ— éœ€å¤‡ä»½"
					fi
				'
			"""

			echo "  [${module}@${hostName}] 3/3 ä¼ è¾“æ–‡ä»¶..."
			sh """
				scp -o StrictHostKeyChecking=no '${artifactFile}' ${user}@${host}:'${modulePath}/${jarName}'

				# éªŒè¯æ–‡ä»¶ä¼ è¾“æˆåŠŸ
				ssh -o StrictHostKeyChecking=no ${user}@${host} '
					if [ -f ${modulePath}/${jarName} ]; then
						echo "âœ… æ–‡ä»¶ä¼ è¾“æˆåŠŸ"
						echo ""
						echo "æ–‡ä»¶ä¿¡æ¯:"
						ls -lh ${modulePath}/${jarName}
						echo ""

						# è®¡ç®— MD5
						if command -v md5sum >/dev/null 2>&1; then
							MD5=\$(md5sum ${modulePath}/${jarName} | cut -d" " -f1)
							echo "MD5: \$MD5"
						fi
						echo ""

						# ç»Ÿè®¡å¤‡ä»½æ•°é‡
						BACKUP_COUNT=\$(ls ${modulePath}/${jarName}.bak.* 2>/dev/null | wc -l)
						echo "ğŸ“Š ${module} å…±æœ‰ \$BACKUP_COUNT ä¸ªå†å²å¤‡ä»½"
					else
						echo "âŒ æ–‡ä»¶ä¼ è¾“å¤±è´¥"
						exit 1
					fi
				'
			"""

			echo "  [${module}@${hostName}] âœ… å‘å¸ƒå®Œæˆï¼ˆFlink ä»»åŠ¡ jarï¼Œæ— éœ€å¯åŠ¨ï¼‰"

			if (env.DEPLOY_MODE != 'MULTI_HOST') {
				echo ""
				echo "  ğŸ’¡ æç¤ºï¼š"
				echo "  â€¢ æ–‡ä»¶ä½ç½®: ${modulePath}/${jarName}"
				echo "  â€¢ éœ€è¦æ‰‹åŠ¨æäº¤åˆ° Flink é›†ç¾¤"
				echo "  â€¢ æäº¤å‘½ä»¤: flink run -d -c <ä¸»ç±»> ${modulePath}/${jarName}"
				echo ""
			}

		} else {
			echo "  [${module}@${hostName}] 1/5 åœæ­¢æœåŠ¡..."
			sh """
				ssh -o StrictHostKeyChecking=no ${user}@${host} '
					cd ${modulePath}

					# æŸ¥æ‰¾æ‰€æœ‰ stop å¼€å¤´çš„è„šæœ¬
					STOP_SCRIPTS=\$(find . -maxdepth 1 -name "stop*.sh" -type f | sort)

					if [ -z "\$STOP_SCRIPTS" ]; then
						echo "âš ï¸ æœªæ‰¾åˆ°åœæ­¢è„šæœ¬ï¼Œä½¿ç”¨é€šç”¨åœæ­¢é€»è¾‘..."

						APP_NAME="${jarName}"
						MAX_RETRIES=3
						SLEEP_TIME=10

						PIDS=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk "{print \\\$2}")

						if [ -n "\$PIDS" ]; then
							echo "å­˜åœ¨ \$APP_NAME è¿›ç¨‹ï¼Œ PIDsä¸º: \$PIDS, å°è¯• kill..."
							echo "\$PIDS" | xargs kill

							RETRY=0
							while [ \$RETRY -lt \$MAX_RETRIES ]; do
								sleep \$SLEEP_TIME
								REMAINING_PIDS=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk "{print \\\$2}")

								if [ -z "\$REMAINING_PIDS" ]; then
									echo "âœ… æ‰€æœ‰ \$APP_NAME è¿›ç¨‹è¢«æˆåŠŸç»ˆæ­¢."
									break
								else
									echo "ä»æœ‰ \$APP_NAME è¿›ç¨‹å­˜åœ¨, å†æ¬¡å°è¯• kill (Attempt \$((RETRY+1))/\$MAX_RETRIES)..."
									echo "\$REMAINING_PIDS" | xargs kill
									RETRY=\$((RETRY+1))
								fi
							done

							REMAINING_PIDS=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk "{print \\\$2}")
							if [ -n "\$REMAINING_PIDS" ]; then
								echo "âš ï¸ ä½¿ç”¨ kill -9 å¼ºåˆ¶ç»ˆæ­¢..."
								echo "\$REMAINING_PIDS" | xargs kill -9
								sleep 2

								FINAL_PIDS=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk "{print \\\$2}")
								if [ -n "\$FINAL_PIDS" ]; then
									echo "âŒ Error: æ— æ³•ç»ˆæ­¢æ‰€æœ‰è¿›ç¨‹ï¼ŒPIDs: \$FINAL_PIDS"
									exit 1
								fi
							fi
						else
							echo "â„¹ï¸ \$APP_NAME è¿›ç¨‹ä¸å­˜åœ¨."
						fi
					else
						echo "æ‰¾åˆ°åœæ­¢è„šæœ¬:"
						echo "\$STOP_SCRIPTS"
						for script in \$STOP_SCRIPTS; do
							echo "æ‰§è¡Œ: \$script"
							bash \$script || echo "âš ï¸ \$script æ‰§è¡Œå¤±è´¥ï¼Œç»§ç»­..."
						done
					fi
				' || true
			"""

			echo "  [${module}@${hostName}] 2/5 å¤‡ä»½æ—§ç‰ˆæœ¬..."
			sh """
				ssh -o StrictHostKeyChecking=no ${user}@${host} '
					cd ${modulePath}

					if [ -f ${jarName} ]; then
						BACKUP_FILE="${jarName}.bak.\$(date +%Y%m%d_%H%M%S)"
						mv ${jarName} "\$BACKUP_FILE"
						echo "âœ… æ—§ç‰ˆæœ¬å·²å¤‡ä»½ä¸º: \$BACKUP_FILE"

						# åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
						ls -t ${jarName}.bak.* 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
					else
						echo "â„¹ï¸ æ—§ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
					fi
				'
			"""

			echo "  [${module}@${hostName}] 3/5 ä¼ è¾“æ–°æ–‡ä»¶..."
			sh """
				scp -o StrictHostKeyChecking=no '${artifactFile}' ${user}@${host}:'${modulePath}/${jarName}'

				# éªŒè¯æ–‡ä»¶ä¼ è¾“æˆåŠŸ
				ssh -o StrictHostKeyChecking=no ${user}@${host} '
					if [ -f ${modulePath}/${jarName} ]; then
						echo "âœ… æ–‡ä»¶ä¼ è¾“æˆåŠŸ"
						ls -lh ${modulePath}/${jarName}
					else
						echo "âŒ æ–‡ä»¶ä¼ è¾“å¤±è´¥"
						exit 1
					fi
				'
			"""

			echo "  [${module}@${hostName}] 4/5 å¯åŠ¨æœåŠ¡..."
			sh """
				ssh -o StrictHostKeyChecking=no ${user}@${host} '
					cd ${modulePath}

					# æŸ¥æ‰¾æ‰€æœ‰ start å¼€å¤´çš„è„šæœ¬
					START_SCRIPTS=\$(find . -maxdepth 1 -name "start*.sh" -type f | sort)

					if [ -z "\$START_SCRIPTS" ]; then
						echo "âŒ æœªæ‰¾åˆ°å¯åŠ¨è„šæœ¬"
						exit 1
					else
						echo "æ‰¾åˆ°å¯åŠ¨è„šæœ¬:"
						echo "\$START_SCRIPTS"
						for script in \$START_SCRIPTS; do
							echo "æ‰§è¡Œ: \$script"
							bash \$script
						done
					fi
				'
			"""

			if (!params.SKIP_HEALTH_CHECK) {
				echo "  [${module}@${hostName}] 5/5 å¥åº·æ£€æŸ¥..."
				sh """
					ssh -o StrictHostKeyChecking=no ${user}@${host} '
						cd ${modulePath}

						if [ -f health_check.sh ]; then
							echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
							bash health_check.sh
						else
							echo "âš ï¸ health_check.sh ä¸å­˜åœ¨ï¼Œè·³è¿‡å¥åº·æ£€æŸ¥"
						fi
					'
				"""
			}

			echo "  [${module}@${hostName}] âœ… å‘å¸ƒå®Œæˆ"
		}
	}
}




def deployFrontendProject(String tarFileName) {
	def artifactPath = "${env.ARTIFACTS_DIR}/frontend/${env.PROJECT_NAME}/${tarFileName}"
	def nginxWebRoot = "${env.BASE_DIR}"

	echo "  [å‰ç«¯] å¼€å§‹å‘å¸ƒ..."
	echo "  åˆ¶å“: ${tarFileName}"
	echo "  æºè·¯å¾„: ${artifactPath}"
	echo "  ç›®æ ‡è·¯å¾„: ${nginxWebRoot}"

	sshagent(['deploy-ssh-key']) {
		echo "  [å‰ç«¯] 1/5 å¤‡ä»½æ—§ç‰ˆæœ¬..."
		sh """
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                cd ${nginxWebRoot}

                # æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰æ–‡ä»¶ï¼ˆæ’é™¤å¤‡ä»½ç›®å½•ï¼‰
                FILE_COUNT=\$(find . -maxdepth 1 ! -name "." ! -name "backup_*" | wc -l)

                if [ "\$FILE_COUNT" -gt 0 ]; then
                    BACKUP_DIR="backup_\$(date +%Y%m%d_%H%M%S)"
                    mkdir -p "\$BACKUP_DIR"

                    echo "å¤‡ä»½ç°æœ‰æ–‡ä»¶åˆ°: \$BACKUP_DIR"

                    # ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶ï¼ˆæ’é™¤å¤‡ä»½ç›®å½•ï¼‰
                    for item in *; do
                        if [[ "\$item" != backup_* ]]; then
                            mv "\$item" "\$BACKUP_DIR/" 2>/dev/null || true
                        fi
                    done

                    echo "âœ… æ—§ç‰ˆæœ¬å·²å¤‡ä»½"

                    # åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
                    BACKUP_COUNT=\$(ls -dt backup_* 2>/dev/null | wc -l)
                    if [ "\$BACKUP_COUNT" -gt 5 ]; then
                        ls -dt backup_* | tail -n +6 | xargs rm -rf
                        echo "âœ… å·²æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰"
                    fi
                else
                    echo "â„¹ï¸ é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½"
                fi
            '
        """

		echo "  [å‰ç«¯] 2/5 ä¼ è¾“å‹ç¼©åŒ…..."
		sh """
            # ä¼ è¾“åˆ°ä¸´æ—¶ç›®å½•
            scp -o StrictHostKeyChecking=no '${artifactPath}' ${env.USER}@${env.HOST}:/tmp/frontend-deploy.tar.gz

            # éªŒè¯ä¼ è¾“
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                if [ -f /tmp/frontend-deploy.tar.gz ]; then
                    FILE_SIZE=\$(du -h /tmp/frontend-deploy.tar.gz | cut -f1)
                    echo "âœ… æ–‡ä»¶ä¼ è¾“æˆåŠŸï¼Œå¤§å°: \$FILE_SIZE"
                else
                    echo "âŒ æ–‡ä»¶ä¼ è¾“å¤±è´¥"
                    exit 1
                fi
            '
        """

		echo "  [å‰ç«¯] 3/5 è§£å‹æ–‡ä»¶..."
		sh """
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                cd ${nginxWebRoot}

                # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
                TEMP_DIR=\$(mktemp -d)
                tar -xzf /tmp/frontend-deploy.tar.gz -C "\$TEMP_DIR"

                echo "ä¸´æ—¶ç›®å½•: \$TEMP_DIR"
                echo "ä¸´æ—¶ç›®å½•å†…å®¹:"
                ls -la "\$TEMP_DIR"

                DIST_DIR=\$(find "\$TEMP_DIR" -type d -name "dist" | head -1)

                if [ -n "\$DIST_DIR" ]; then
                    echo "âœ… æ‰¾åˆ° dist ç›®å½•: \$DIST_DIR"
                    SOURCE_DIR="\$DIST_DIR"
                else
                    if [ -f "\$TEMP_DIR/index.html" ]; then
                        echo "âœ… æ£€æµ‹åˆ°æ ¹ç›®å½•åŒ…å« index.htmlï¼ˆH5 é¡¹ç›®æ¨¡å¼ï¼‰"
                        SOURCE_DIR="\$TEMP_DIR"
                    else
                        echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ„å»ºäº§ç‰©"
                        echo "ä¸´æ—¶ç›®å½•ç»“æ„:"
                        find "\$TEMP_DIR" -maxdepth 3 -type f
                        rm -rf "\$TEMP_DIR"
                        exit 1
                    fi
                fi

                echo "ä½¿ç”¨æºç›®å½•: \$SOURCE_DIR"

                # ç§»åŠ¨æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
                mv "\$SOURCE_DIR"/* . 2>/dev/null || true
                mv "\$SOURCE_DIR"/.[!.]* . 2>/dev/null || true

                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                rm -rf "\$TEMP_DIR"
                rm -f /tmp/frontend-deploy.tar.gz

                echo "âœ… æ–‡ä»¶è§£å‹å®Œæˆ"
            '
        """

		echo "  [å‰ç«¯] 4/5 éªŒè¯æ–‡ä»¶..."
		sh """
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                cd ${nginxWebRoot}

                if [ -f index.html ]; then
                    echo "âœ… æ–‡ä»¶éƒ¨ç½²æˆåŠŸ"
                    echo ""
                    echo "éƒ¨ç½²æ–‡ä»¶åˆ—è¡¨:"
                    ls -lh | head -15
                    echo ""
                    echo "index.html å¤§å°: \$(du -h index.html | cut -f1)"

                    # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
                    FILE_COUNT=\$(find . -type f ! -path "./backup_*/*" | wc -l)
                    DIR_COUNT=\$(find . -type d ! -path "./backup_*" ! -path "./backup_*/*" | wc -l)
                    TOTAL_SIZE=\$(du -sh --exclude="backup_*" . | cut -f1)

                    echo "æ–‡ä»¶æ•°é‡: \$FILE_COUNT"
                    echo "ç›®å½•æ•°é‡: \$DIR_COUNT"
                    echo "æ€»å¤§å°: \$TOTAL_SIZE"
                else
                    echo "âŒ æœªæ‰¾åˆ° index.htmlï¼Œéƒ¨ç½²å¯èƒ½å¤±è´¥"
                    echo "å½“å‰ç›®å½•å†…å®¹:"
                    ls -la
                    exit 1
                fi
            '
        """

		echo "  [å‰ç«¯] 5/5 é‡è½½ Nginx..."
		sh """
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                echo "æµ‹è¯• Nginx é…ç½®..."
                if sudo nginx -t 2>&1; then
                    echo "âœ… Nginx é…ç½®æµ‹è¯•é€šè¿‡"

                    echo "é‡è½½ Nginx..."
                    sudo nginx -s reload

                    if [ \$? -eq 0 ]; then
                        echo "âœ… Nginx é‡è½½æˆåŠŸ"
                    else
                        echo "âŒ Nginx é‡è½½å¤±è´¥"
                        exit 1
                    fi

                    # æ¸…ç† Nginx ç¼“å­˜ï¼ˆå¦‚æœé…ç½®äº†ç¼“å­˜ï¼‰
                    if [ -d /var/cache/nginx ]; then
                        sudo find /var/cache/nginx -type f -delete 2>/dev/null || true
                        echo "âœ… Nginx ç¼“å­˜å·²æ¸…ç†"
                    fi
                else
                    echo "âŒ Nginx é…ç½®æµ‹è¯•å¤±è´¥"
                    sudo nginx -t
                    exit 1
                fi
            '
        """

		if (!params.SKIP_HEALTH_CHECK) {
			echo "  [å‰ç«¯] 6/6 å¥åº·æ£€æŸ¥..."
			sh """
                # ç­‰å¾… Nginx é‡è½½å®Œæˆ
                sleep 3

                echo "æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§..."

                # å°è¯•è®¿é—®ç½‘ç«™
                HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" http://${env.HOST} 2>/dev/null || echo "000")

                if [ "\$HTTP_CODE" = "200" ]; then
                    echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸ (HTTP 200)"
                elif [ "\$HTTP_CODE" = "000" ]; then
                    echo "âš ï¸ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Nginx é…ç½®"
                else
                    echo "âš ï¸ HTTP çŠ¶æ€ç : \$HTTP_CODE"
                fi

                # éªŒè¯å…³é”®æ–‡ä»¶
                ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                    cd ${nginxWebRoot}

                    echo ""
                    echo "éªŒè¯å…³é”®æ–‡ä»¶:"
                    [ -f index.html ] && echo "  âœ… index.html" || echo "  âŒ index.html"
                    [ -d static ] && echo "  âœ… static/" || echo "  â„¹ï¸ static/ (å¯èƒ½ä¸å­˜åœ¨)"
                    [ -d assets ] && echo "  âœ… assets/" || echo "  â„¹ï¸ assets/ (å¯èƒ½ä¸å­˜åœ¨)"
                    [ -d js ] && echo "  âœ… js/" || echo "  â„¹ï¸ js/ (å¯èƒ½ä¸å­˜åœ¨)"
                    [ -d css ] && echo "  âœ… css/" || echo "  â„¹ï¸ css/ (å¯èƒ½ä¸å­˜åœ¨)"
                '
            """
		}
	}

	echo "  [å‰ç«¯] âœ… å‘å¸ƒå®Œæˆ"
}