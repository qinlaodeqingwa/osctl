properties([
	parameters([
		[$class: 'ChoiceParameter',
			choiceType: 'PT_SINGLE_SELECT',
			name: 'PROJECT',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
                        def artifactsDir = '/data/artifacts'
                        def projects = []

                        try {
                            def backendDir = new File("${artifactsDir}/backend")
                            if (backendDir.exists()) {
                                backendDir.listFiles()?.each { projectDir ->
                                    if (projectDir.isDirectory()) {
                                        projects << "[åç«¯] ${projectDir.name}"
                                    }
                                }
                            }

                            def frontendDir = new File("${artifactsDir}/frontend")
                            if (frontendDir.exists()) {
                                frontendDir.listFiles()?.each { projectDir ->
                                    if (projectDir.isDirectory()) {
                                        projects << "[å‰ç«¯] ${projectDir.name}"
                                    }
                                }
                            }

                            return projects.isEmpty() ? ['æ²¡æœ‰å¯ç”¨çš„é¡¹ç›®'] : projects.sort()
                        } catch (Exception e) {
                            return ['ERROR: ' + e.message]
                        }
                    '''
				]
			],
			description: 'é€‰æ‹©è¦éƒ¨ç½²çš„é¡¹ç›®'
		],
		[$class: 'CascadeChoiceParameter',
			choiceType: 'PT_CHECKBOX',
			name: 'MODULES',
			referencedParameters: 'PROJECT',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
                        def artifactsDir = '/data/artifacts'

                        try {
                            def match = PROJECT =~ /^\\[(åç«¯|å‰ç«¯)\\]\\s+(.+)$/
                            if (!match.find()) {
                                return ['ERROR: é¡¹ç›®æ ¼å¼é”™è¯¯']
                            }

                            def projectType = match.group(1)
                            def projectName = match.group(2)

                            if (projectType == 'å‰ç«¯') {
                                return ['FRONTEND_NO_MODULES']
                            }

                            def projectDir = new File("${artifactsDir}/backend/${projectName}")
                            if (!projectDir.exists()) {
                                return ['ERROR: é¡¹ç›®ç›®å½•ä¸å­˜åœ¨']
                            }

                            def modules = []
                            projectDir.listFiles()?.each { moduleDir ->
                                if (moduleDir.isDirectory()) {
                                    modules << moduleDir.name
                                }
                            }

                            return modules.isEmpty() ? ['ERROR: æ²¡æœ‰å¯ç”¨çš„æ¨¡å—'] : modules.sort()
                        } catch (Exception e) {
                            return ['ERROR: ' + e.message]
                        }
                    '''
				]
			],
			description: 'é€‰æ‹©è¦éƒ¨ç½²çš„æ¨¡å—ï¼ˆåç«¯é¡¹ç›®å¯å¤šé€‰ï¼‰'
		],
		[$class: 'DynamicReferenceParameter',
			choiceType: 'ET_FORMATTED_HTML',
			name: 'MODULE_VERSION_SELECTORS',
			referencedParameters: 'PROJECT,MODULES',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
                def artifactsDir = '/data/artifacts'

                try {
                    def projectMatch = PROJECT =~ /^\\[(åç«¯|å‰ç«¯)\\]\\s+(.+)$/
                    if (!projectMatch.find()) {
                        return '<div style="color: red;">é¡¹ç›®æ ¼å¼é”™è¯¯</div>'
                    }

                    def projectType = projectMatch.group(1)
                    def projectName = projectMatch.group(2)

                    if (projectType == 'å‰ç«¯') {
                        def frontendDir = new File("${artifactsDir}/frontend/${projectName}")

                        if (!frontendDir.exists()) {
                            return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ å‰ç«¯é¡¹ç›®ç›®å½•ä¸å­˜åœ¨</div>'
                        }

                        def tarFiles = frontendDir.listFiles()?.findAll { file ->
                            file.isFile() && file.name.endsWith('.tar.gz')
                        }?.sort { a, b -> b.lastModified() <=> a.lastModified() }

                        if (!tarFiles || tarFiles.isEmpty()) {
                            return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ æœªæ‰¾åˆ°å‰ç«¯æ„å»ºäº§ç‰©</div>'
                        }

                        def html = new StringBuilder()
                        html.append('<div style="font-family: Arial, sans-serif; padding: 15px; background: #f8f9fa; border-radius: 5px;">')
                        html.append('<h3 style="margin-top: 0; color: #333;">ğŸŒ é€‰æ‹©å‰ç«¯ç‰ˆæœ¬</h3>')
                        html.append('<div style="color: #666; margin-bottom: 15px;">é¡¹ç›®: <strong>' + projectName + '</strong> | å…± ' + tarFiles.size() + ' ä¸ªç‰ˆæœ¬</div>')

                        html.append('<div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 5px; max-height: 500px; overflow-y: auto;">')
                        html.append('<table style="width: 100%; border-collapse: collapse;">')
                        html.append('<thead style="position: sticky; top: 0; background: white; z-index: 10;">')
                        html.append('<tr style="background: #f5f5f5;">')
                        html.append('<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd; width: 40px;"></th>')
                        html.append('<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">ç‰ˆæœ¬</th>')
                        html.append('<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">æ„å»ºæ—¶é—´</th>')
                        html.append('<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">å¤§å°</th>')
                        html.append('</tr>')
                        html.append('</thead>')
                        html.append('<tbody>')

                        tarFiles.eachWithIndex { file, index ->
                            def fileName = file.name
                            def date = new Date(file.lastModified()).format('yyyy-MM-dd HH:mm:ss')
                            def sizeMB = file.length() / 1024.0 / 1024.0
                            def size = String.format('%.2f MB', sizeMB)

                            def versionDisplay = fileName.replace('.tar.gz', '')

                            def rowStyle = index == 0 ? 'background: #e3f2fd;' : (index % 2 == 0 ? 'background: #fafafa;' : '')
                            def badge = index == 0 ? '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; margin-left: 8px;">æœ€æ–°</span>' : ''

                            html.append('<tr style="' + rowStyle + '">')
                            html.append('<td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">')
                            html.append('<input type="radio" name="value" value="frontend:' + fileName + '"' + (index == 0 ? ' checked' : '') + '>')
                            html.append('</td>')
                            html.append('<td style="padding: 10px; border-bottom: 1px solid #eee; font-family: Consolas, monospace; font-size: 13px;">')
                            html.append(versionDisplay + badge)
                            html.append('</td>')
                            html.append('<td style="padding: 10px; border-bottom: 1px solid #eee; color: #666;">' + date + '</td>')
                            html.append('<td style="padding: 10px; border-bottom: 1px solid #eee; color: #666; font-weight: 500;">' + size + '</td>')
                            html.append('</tr>')
                        }

                        html.append('</tbody>')
                        html.append('</table>')

                        html.append('<div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-left: 4px solid #ff9800; border-radius: 3px;">')
                        html.append('<strong>ğŸ’¡ æç¤ºï¼š</strong> é»˜è®¤é€‰ä¸­æœ€æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡»å…¶ä»–è¡Œå¯åˆ‡æ¢ç‰ˆæœ¬')
                        html.append('</div>')

                        html.append('</div>')
                        html.append('</div>')

                        return html.toString()
                    }

                    if (!MODULES || MODULES.trim().isEmpty() || MODULES == '(å‰ç«¯é¡¹ç›®æ— éœ€é€‰æ‹©æ¨¡å—)') {
                        return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ è¯·å…ˆé€‰æ‹©æ¨¡å—</div>'
                    }

                    def selectedModules = MODULES.split(',').collect { it.trim() }.findAll { it }

                    if (selectedModules.isEmpty()) {
                        return '<div style="padding: 10px; background: #fff3cd; border-radius: 5px;">âš ï¸ è¯·å…ˆé€‰æ‹©æ¨¡å—</div>'
                    }

                    def html = new StringBuilder()
                    html.append('<div style="font-family: Arial, sans-serif; padding: 15px; background: #f8f9fa; border-radius: 5px;">')
                    html.append('<h3 style="margin-top: 0; color: #333;">ğŸ“¦ ä¸ºæ¯ä¸ªæ¨¡å—é€‰æ‹©ç‰ˆæœ¬</h3>')
                    html.append('<div style="color: #666; margin-bottom: 15px;">é¡¹ç›®: <strong>' + projectName + '</strong> | å·²é€‰æ‹© ' + selectedModules.size() + ' ä¸ªæ¨¡å—</div>')

                    selectedModules.eachWithIndex { module, moduleIndex ->
                        def artifactPath = artifactsDir + '/backend/' + projectName + '/' + module
                        def dir = new File(artifactPath)

                        html.append('<div style="margin-bottom: 20px; padding: 0; background: white; border: 1px solid #ddd; border-radius: 5px; overflow: hidden;">')

                        html.append('<div style="padding: 12px 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; font-size: 15px;">')
                        html.append('<span style="background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 3px; margin-right: 10px;">' + (moduleIndex + 1) + '</span>')
                        html.append(module)
                        html.append('</div>')

                        if (!dir.exists()) {
                            html.append('<div style="padding: 15px; color: #dc3545;">âŒ æ¨¡å—ç›®å½•ä¸å­˜åœ¨</div>')
                        } else {
                            def files = dir.listFiles()?.findAll { file ->
                                file.isFile() && file.name.endsWith('.jar')
                            }

                            if (!files || files.isEmpty()) {
                                html.append('<div style="padding: 15px; color: #dc3545;">âŒ æ²¡æœ‰å¯ç”¨ç‰ˆæœ¬</div>')
                            } else {
                                files.sort { a, b -> b.lastModified() <=> a.lastModified() }

                                html.append('<div style="padding: 15px;">')
                                html.append('<select name="value" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; background: white;">')

                                files.eachWithIndex { file, index ->
                                    def fileName = file.name

                                    def version = fileName
                                    def date = new Date(file.lastModified()).format('yyyy-MM-dd HH:mm:ss')
                                    def sizeMB = file.length() / 1024.0 / 1024.0
                                    def size = String.format('%.2f MB', sizeMB)

                                    def badge = index == 0 ? ' ğŸŒŸ æœ€æ–°' : ''
                                    def selected = index == 0 ? ' selected' : ''

                                    html.append('<option value="' + module + ':' + version + '"' + selected + '>')
                                    html.append(version + badge + ' (' + date + ', ' + size + ')')
                                    html.append('</option>')
                                }

                                html.append('</select>')

                                html.append('<div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-left: 3px solid #667eea; border-radius: 3px; color: #666; font-size: 12px;">')
                                html.append('ğŸ“Š å…± ' + files.size() + ' ä¸ªç‰ˆæœ¬å¯é€‰ | é»˜è®¤é€‰ä¸­æœ€æ–°ç‰ˆæœ¬')
                                html.append('</div>')

                                html.append('</div>')
                            }
                        }

                        html.append('</div>')
                    }

                    html.append('<div style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 3px;">')
                    html.append('<strong>ğŸ’¡ æç¤ºï¼š</strong> æ¯ä¸ªæ¨¡å—é»˜è®¤é€‰ä¸­æœ€æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥åˆ†åˆ«ä¸ºä¸åŒæ¨¡å—é€‰æ‹©ä¸åŒç‰ˆæœ¬')
                    html.append('</div>')

                    html.append('</div>')

                    return html.toString()

                } catch (Exception e) {
                    return '<div style="color: red;">è¯»å–ç‰ˆæœ¬å¤±è´¥: ' + e.message + '</div>'
                }
            '''
				]
			],
			description: 'é€‰æ‹©ç‰ˆæœ¬'
		],
		[$class: 'DynamicReferenceParameter',
			choiceType: 'ET_FORMATTED_HTML',
			name: 'DEPLOY_INSTANCES',
			referencedParameters: 'PROJECT',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
                import groovy.json.JsonSlurper

                def configFile = '/data/deployments/servers-config.json'

                try {
                    def match = PROJECT =~ /^\\[(åç«¯|å‰ç«¯)\\]\\s+(.+)$/
                    if (!match.find()) {
                        return '<input type="hidden" name="value" value="NONE">'
                    }

                    def projectType = match.group(1)
                    def projectName = match.group(2)

                    if (projectType == 'å‰ç«¯') {
                        return '<input type="hidden" name="value" value="NONE">'
                    }

                    def config = new JsonSlurper().parse(new File(configFile))
                    def projectConfig = config.projects[projectName]

                    if (!projectConfig) {
                        return '<input type="hidden" name="value" value="SINGLE">'
                    }

                    if (!projectConfig.instances?.enabled) {
                        return '<input type="hidden" name="value" value="SINGLE">'
                    }

                    def instances = projectConfig.instances.list ?: ['instance1', 'instance2']
                    def defaultInstance = projectConfig.instances.default ?: 'instance2'

                    def uniqueId = "inst_" + System.currentTimeMillis()

                    def html = new StringBuilder()
                    html.append('<input type="hidden" name="value" id="' + uniqueId + '_value" value="' + defaultInstance + '">')

                    html.append('<div id="' + uniqueId + '_container" style="font-family: Arial, sans-serif; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6; margin-top: 8px;">')
                    html.append('<div style="margin-bottom: 12px; font-weight: bold; color: #495057; font-size: 14px;">é€‰æ‹©éƒ¨ç½²å®ä¾‹ï¼ˆç°åº¦å‘å¸ƒï¼‰ï¼š</div>')

                    instances.each { instance ->
                        def isPrimary = (instance == 'instance1' || instance == 'master')
                        def badge = isPrimary ? 'ğŸ”´ ä¸»å®ä¾‹' : 'ğŸŸ¢ ä»å®ä¾‹'
                        def checked = (instance == defaultInstance) ? 'checked' : ''
                        def tip = isPrimary ? 'ï¼ˆç”Ÿäº§æµé‡ï¼‰' : 'ï¼ˆç°åº¦æµé‡ï¼‰'
                        def bgColor = isPrimary ? '#ffebee' : '#e8f5e9'
                        def borderColor = isPrimary ? '#ef5350' : '#66bb6a'

                        html.append('<div style="margin: 8px 0; padding: 12px; background: ' + bgColor + '; border-radius: 5px; border-left: 4px solid ' + borderColor + ';">')
                        html.append("<label style='cursor: pointer; display: flex; align-items: center; user-select: none;'>")
                        html.append("<input type='checkbox' class='${uniqueId}_cb' data-inst='${instance}' ${checked} style='margin-right: 12px; width: 18px; height: 18px; cursor: pointer;'> ")
                        html.append("<span style='font-size: 14px;'>${badge} <strong>${instance}</strong> <span style='color: #6c757d;'>${tip}</span></span>")
                        html.append('</label>')
                        html.append('</div>')
                    }

                    html.append('<div style="margin-top: 12px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 13px; color: #856404;">')
                    html.append('<strong>ğŸ’¡ æç¤ºï¼š</strong> å¯å¤šé€‰ï¼Œé»˜è®¤é€‰ä¸­ <strong>' + defaultInstance + '</strong>ï¼ˆç°åº¦å®ä¾‹ï¼‰')
                    html.append('</div>')
                    html.append('</div>')

                    // JavaScript
                    html.append('<script>')
                    html.append('(function() {')
                    html.append('  var vid = "' + uniqueId + '_value";')
                    html.append('  var cbs = "' + uniqueId + '_cb";')
                    html.append('  ')
                    html.append('  function update() {')
                    html.append('    var boxes = document.querySelectorAll("." + cbs);')
                    html.append('    var sel = [];')
                    html.append('    boxes.forEach(function(b) {')
                    html.append('      if (b.checked) sel.push(b.getAttribute("data-inst"));')
                    html.append('    });')
                    html.append('    var val = sel.length > 0 ? sel.join(",") : "NONE";')
                    html.append('    var inp = document.getElementById(vid);')
                    html.append('    if (inp) inp.value = val;')
                    html.append('  }')
                    html.append('  ')
                    html.append('  function init() {')
                    html.append('    var boxes = document.querySelectorAll("." + cbs);')
                    html.append('    if (boxes.length === 0) {')
                    html.append('      setTimeout(init, 100);')
                    html.append('      return;')
                    html.append('    }')
                    html.append('    boxes.forEach(function(b) {')
                    html.append('      b.addEventListener("change", update);')
                    html.append('    });')
                    html.append('    update();')
                    html.append('  }')
                    html.append('  ')
                    html.append('  if (document.readyState === "loading") {')
                    html.append('    document.addEventListener("DOMContentLoaded", init);')
                    html.append('  } else {')
                    html.append('    setTimeout(init, 50);')
                    html.append('  }')
                    html.append('})();')
                    html.append('</script>')

                    return html.toString()

                } catch (Exception e) {
                    return '<input type="hidden" name="value" value="SINGLE">'
                }
            '''
				]
			],
			description: 'é€‰æ‹©éƒ¨ç½²å®ä¾‹ï¼ˆå¯å¤šé€‰ï¼‰'
		],
		[$class: 'DynamicReferenceParameter',
			choiceType: 'ET_FORMATTED_HTML',
			name: 'DEPLOY_HOSTS',
			referencedParameters: 'PROJECT',
			script: [
				$class: 'GroovyScript',
				script: [
					sandbox: false,
					script: '''
                        import groovy.json.JsonSlurper

                        def configFile = '/data/deployments/servers-config.json'

                        try {
                            def match = PROJECT =~ /^\\[(åç«¯|å‰ç«¯)\\]\\s+(.+)$/
                            if (!match.find()) {
                                return '<div style="color:red;">é¡¹ç›®æ ¼å¼é”™è¯¯</div>'
                            }

                            def projectName = match.group(2)

                            def config = new JsonSlurper().parse(new File(configFile))
                            def projectConfig = config.projects[projectName]

                            if (!projectConfig) {
                                return '<div style="color:orange;">é¡¹ç›®é…ç½®ä¸å­˜åœ¨</div>'
                            }

                            if (!projectConfig.hosts || !(projectConfig.hosts instanceof List)) {
                                return '<input type="hidden" name="value" value="ALL"><div style="color: gray;">å•ä¸»æœºé¡¹ç›®ï¼Œæ— éœ€é€‰æ‹©èŠ‚ç‚¹</div>'
                            }
                            def hosts = projectConfig.hosts

                            def html = new StringBuilder()
                            html.append('<div style="font-family: monospace;">')
                            html.append('<div style="margin-bottom: 10px;"><strong>é€‰æ‹©éƒ¨ç½²èŠ‚ç‚¹ï¼š</strong></div>')

                            hosts.eachWithIndex { hostConfig, idx ->
                                html.append('<div style="margin: 5px 0;">')
                                html.append("<label style='cursor: pointer;'>")
                                html.append("<input type='checkbox' name='host' value='${idx}' checked> ")
                                html.append("èŠ‚ç‚¹ ${idx}: ${hostConfig.name} (${hostConfig.host})")
                                html.append('</label>')
                                html.append('</div>')
                            }

                            html.append('<input type="hidden" name="value" id="hosts_value" value="">')
                            html.append('<script>')
                            html.append('(function() {')
                            html.append('  function updateValue() {')
                            html.append('    var checkboxes = document.getElementsByName("host");')
                            html.append('    var selected = [];')
                            html.append('    for (var i = 0; i < checkboxes.length; i++) {')
                            html.append('      if (checkboxes[i].checked) {')
                            html.append('        selected.push(checkboxes[i].value);')
                            html.append('      }')
                            html.append('    }')
                            html.append('    document.getElementById("hosts_value").value = selected.length > 0 ? selected.join(",") : "ALL";')
                            html.append('  }')
                            html.append('  var checkboxes = document.getElementsByName("host");')
                            html.append('  for (var i = 0; i < checkboxes.length; i++) {')
                            html.append('    checkboxes[i].addEventListener("change", updateValue);')
                            html.append('  }')
                            html.append('  updateValue();')
                            html.append('})();')
                            html.append('</script>')
                            html.append('</div>')

                            return html.toString()

                        } catch (Exception e) {
                            return "<div style='color:red;'>é”™è¯¯: ${e.message}</div>"
                        }
                    '''
				]
			],
			description: 'é€‰æ‹©éƒ¨ç½²èŠ‚ç‚¹'
		],

		booleanParam(
			name: 'SKIP_HEALTH_CHECK',
			defaultValue: false,
			description: 'è·³è¿‡å¥åº·æ£€æŸ¥'
		),

		booleanParam(
			name: 'PARALLEL_DEPLOY',
			defaultValue: false,
			description: 'å¹¶è¡Œéƒ¨ç½²ï¼ˆä»…åç«¯å¤šæ¨¡å—ï¼‰'
		)
	])
])

pipeline {
	agent any

	environment {
		CONFIG_FILE = '/data/deployments/servers-config.json'
		ARTIFACTS_DIR = '/data/artifacts'
	}

	stages {
		stage('è§£æå‚æ•°') {
			steps {
				script {
					echo "=========================================="
					echo "ğŸ“‹ è§£ææ„å»ºå‚æ•°"
					echo "=========================================="

					def projectInfo = parseProjectInfo(params.PROJECT)

					if (!projectInfo) {
						error "âŒ é¡¹ç›®æ ¼å¼é”™è¯¯"
					}

					env.PROJECT_TYPE_CN = projectInfo.typeCn
					env.PROJECT_NAME = projectInfo.name
					env.PROJECT_TYPE = (projectInfo.typeCn == 'åç«¯') ? 'backend' : 'frontend'

					echo "é¡¹ç›®: ${env.PROJECT_NAME}"
					echo "ç±»å‹: ${env.PROJECT_TYPE_CN}"
					echo ""

					echo "=========================================="
					echo "ğŸ“¦ è§£æç‰ˆæœ¬"
					echo "=========================================="

					def deploymentPlan = [:]

					if (!params.MODULE_VERSION_SELECTORS || params.MODULE_VERSION_SELECTORS.trim().isEmpty()) {
						error "âŒ è¯·é€‰æ‹©ç‰ˆæœ¬"
					}

					echo "ğŸ“¥ åŸå§‹å‚æ•°å€¼:"
					echo "   ${params.MODULE_VERSION_SELECTORS}"
					echo ""

					if (env.PROJECT_TYPE == 'frontend') {
						// å‰ç«¯ï¼šfrontend:xxx.tar.gz
						def parts = params.MODULE_VERSION_SELECTORS.trim().split(':', 2)
						if (parts.length == 2 && parts[0] == 'frontend') {
							deploymentPlan['frontend'] = parts[1].trim()
							echo "å‰ç«¯ç‰ˆæœ¬: ${parts[1].trim()}"
						} else {
							error "âŒ å‰ç«¯ç‰ˆæœ¬æ ¼å¼é”™è¯¯ï¼ŒæœŸæœ›æ ¼å¼ï¼šfrontend:æ–‡ä»¶å.tar.gz"
						}
					} else {
						def selections = params.MODULE_VERSION_SELECTORS.trim()
						selections.split(',').each { selection ->
							def trimmed = selection.trim()

							if (trimmed.isEmpty()) {
								return
							}
							def colonIndex = trimmed.indexOf(':')
							if (colonIndex > 0) {
								String module = trimmed.substring(0, colonIndex).trim()
								String version = trimmed.substring(colonIndex + 1).trim()

								if (!module.isEmpty() && !version.isEmpty()) {
									deploymentPlan[module] = version
									echo "  âœ“ ${module}"
									echo "    â””â”€ ${version}"
								} else {
									echo "  âš ï¸ è·³è¿‡æ— æ•ˆé¡¹: ${trimmed}"
								}
							} else {
								echo "  âš ï¸ è·³è¿‡æ ¼å¼é”™è¯¯: ${trimmed}"
							}
						}

						if (deploymentPlan.isEmpty()) {
							error """
âŒ æœªèƒ½è§£æåˆ°ä»»ä½•æ¨¡å—ç‰ˆæœ¬

åŸå§‹è¾“å…¥:
${params.MODULE_VERSION_SELECTORS}

æœŸæœ›æ ¼å¼:
module1:file1.jar,module2:file2.jar
"""
						}
					}

					env.DEPLOYMENT_PLAN = writeJSON returnText: true, json: deploymentPlan

					echo ""
					echo "=========================================="
					echo "ğŸ“‹ æœ€ç»ˆéƒ¨ç½²è®¡åˆ’"
					echo "=========================================="
					deploymentPlan.each { module, version ->
						echo "  ${module}:"
						echo "    ${version}"
					}

					echo "åŸå§‹ DEPLOY_INSTANCES å‚æ•°: '${params.DEPLOY_INSTANCES}'"

					def config = readJSON file: env.CONFIG_FILE
					def projectConfig = config.projects[env.PROJECT_NAME]

					def deployInstances = params.DEPLOY_INSTANCES?.trim() ?: 'SINGLE'

					deployInstances = deployInstances.replaceAll(/^,+|,+$/, '')
					deployInstances = deployInstances.replaceAll(/,{2,}/, ',')

					echo "æ¸…ç†åçš„å€¼: '${deployInstances}'"

					if (deployInstances == 'NONE' || deployInstances.isEmpty() || env.PROJECT_TYPE == 'frontend') {
						env.INSTANCE_MODE = 'NONE'
						env.SELECTED_INSTANCES = 'NONE'
						echo "å‰ç«¯é¡¹ç›®ï¼ˆæ— å®ä¾‹ï¼‰"
					} else if (deployInstances == 'SINGLE' || !projectConfig?.instances?.enabled) {
						env.INSTANCE_MODE = 'SINGLE'
						env.SELECTED_INSTANCES = 'SINGLE'
						echo "å•å®ä¾‹é¡¹ç›®"
					} else {
						env.INSTANCE_MODE = 'MULTI'
						env.SELECTED_INSTANCES = deployInstances

						def instances = deployInstances.split(',').collect { it.trim() }
						echo "åŒå®ä¾‹é¡¹ç›®"
						echo "é€‰æ‹©å®ä¾‹: ${instances.join(', ')} (å…± ${instances.size()} ä¸ª)"
					}

					echo "=========================================="
					echo "ğŸ–¥ï¸ è§£æèŠ‚ç‚¹"
					echo "=========================================="

					if (projectConfig?.hosts && projectConfig.hosts instanceof List) {
						env.SELECTED_HOSTS = params.DEPLOY_HOSTS
						echo "å¤šä¸»æœºé¡¹ç›®"
						echo "é€‰æ‹©èŠ‚ç‚¹: ${env.SELECTED_HOSTS}"
					} else {
						env.SELECTED_HOSTS = 'ALL'
						echo "å•ä¸»æœºé¡¹ç›®"
					}

					echo "=========================================="
					echo "PROJECT_NAME: ${env.PROJECT_NAME}"
					echo "PROJECT_TYPE: ${env.PROJECT_TYPE}"
					echo "INSTANCE_MODE: ${env.INSTANCE_MODE}"
					echo "SELECTED_INSTANCES: ${env.SELECTED_INSTANCES}"
					echo "SELECTED_HOSTS: ${env.SELECTED_HOSTS}"
					echo "DEPLOYMENT_PLAN: ${env.DEPLOYMENT_PLAN}"
					echo "=========================================="
				}
			}
		}

		stage('è¯»å–é…ç½®') {
			steps {
				script {
					def config = readJSON file: env.CONFIG_FILE
					def projectConfig = config.projects[env.PROJECT_NAME]

					if (!projectConfig) {
						error "âŒ é¡¹ç›®é…ç½®ä¸å­˜åœ¨"
					}

					if (projectConfig.hosts) {
						env.DEPLOY_MODE = 'MULTI_HOST'
						def allHosts = projectConfig.hosts
						def selectedHosts = []

						if (env.SELECTED_HOSTS == 'ALL') {
							selectedHosts = allHosts
						} else {
							def indices = env.SELECTED_HOSTS.split(',').collect { it.trim().toInteger() }
							indices.each { idx ->
								if (idx >= 0 && idx < allHosts.size()) {
									selectedHosts << allHosts[idx]
								}
							}
						}

						env.HOSTS_CONFIG = writeJSON returnText: true, json: selectedHosts
						env.BASE_DIR = selectedHosts[0].baseDir
					} else {
						env.DEPLOY_MODE = 'SINGLE_HOST'
						env.HOST = projectConfig.host
						env.USER = projectConfig.user
						env.BASE_DIR = projectConfig.baseDir
					}
				}
			}
		}

		stage('æ£€æŸ¥åˆ¶å“') {
			steps {
				script {
					echo "=========================================="
					echo "æ£€æŸ¥æ‰€æœ‰åˆ¶å“æ˜¯å¦å­˜åœ¨"
					echo "=========================================="

					def deploymentPlan = readJSON text: env.DEPLOYMENT_PLAN
					def missingArtifacts = []

					if (env.PROJECT_TYPE == 'frontend') {
						def tarFileName = deploymentPlan['frontend']
						def artifactFile = "${env.ARTIFACTS_DIR}/frontend/${env.PROJECT_NAME}/${tarFileName}"

						if (!fileExists(artifactFile)) {
							missingArtifacts << "  âŒ ${tarFileName}"
							echo "  âŒ å‰ç«¯åˆ¶å“ä¸å­˜åœ¨: ${artifactFile}"
						} else {
							def fileSize = sh(script: "du -h '${artifactFile}' | cut -f1", returnStdout: true).trim()
							echo "  âœ… å‰ç«¯åˆ¶å“ (${tarFileName}): ${fileSize}"
						}
					} else {
						deploymentPlan.each { module, version ->
							def artifactFile = "${env.ARTIFACTS_DIR}/backend/${env.PROJECT_NAME}/${module}/${version}"

							echo "æ£€æŸ¥: ${module}"
							echo "  æ–‡ä»¶: ${version}"
							echo "  è·¯å¾„: ${artifactFile}"

							if (!fileExists(artifactFile)) {
								missingArtifacts << "  âŒ ${module} (${version})"
								echo "  âŒ ä¸å­˜åœ¨"
							} else {
								def fileSize = sh(script: "du -h '${artifactFile}' | cut -f1", returnStdout: true).trim()
								echo "  âœ… å­˜åœ¨ (${fileSize})"
							}
						}
					}

					if (!missingArtifacts.isEmpty()) {
						error "âŒ ä»¥ä¸‹åˆ¶å“ä¸å­˜åœ¨:\n${missingArtifacts.join('\n')}"
					}

					echo "=========================================="
					echo "âœ… æ‰€æœ‰åˆ¶å“æ£€æŸ¥é€šè¿‡"
					echo "=========================================="
				}
			}
		}

		stage('ç¡®è®¤å‘å¸ƒ') {
			steps {
				script {
					def deploymentPlan = readJSON text: env.DEPLOYMENT_PLAN

					def message = """
========================================
âš ï¸  ç¡®è®¤å‘å¸ƒï¼Ÿ
========================================
é¡¹ç›®: ${env.PROJECT_NAME}
ç±»å‹: ${env.PROJECT_TYPE_CN}

éƒ¨ç½²è®¡åˆ’:
"""

					deploymentPlan.each { key, value ->
						message += "  - ${key}: ${value}\n"
					}

					message += "\n"

					if (env.PROJECT_TYPE == 'backend') {
						if (env.INSTANCE_MODE == 'MULTI') {
							def instances = env.SELECTED_INSTANCES.split(',').collect { it.trim() }
							message += "å®ä¾‹æ¨¡å¼: åŒå®ä¾‹\n"
							message += "é€‰æ‹©å®ä¾‹:\n"
							instances.each { inst ->
								def isPrimary = (inst == 'instance1' || inst == 'master')
								def badge = isPrimary ? 'ğŸ”´' : 'ğŸŸ¢'
								def tip = isPrimary ? 'ä¸»å®ä¾‹ï¼ˆç”Ÿäº§æµé‡ï¼‰' : 'ä»å®ä¾‹ï¼ˆç°åº¦æµé‡ï¼‰'
								message += "  ${badge} ${inst} ${tip}\n"
							}
						} else if (env.INSTANCE_MODE == 'SINGLE') {
							message += "å®ä¾‹æ¨¡å¼: å•å®ä¾‹\n"
						}
					}

					message += "\n"
					if (env.DEPLOY_MODE == 'MULTI_HOST') {
						def hostsConfig = readJSON text: env.HOSTS_CONFIG
						def config = readJSON file: env.CONFIG_FILE
						def allHostsCount = config.projects[env.PROJECT_NAME].hosts.size()

						message += "éƒ¨ç½²æ¨¡å¼: å¤šä¸»æœºéƒ¨ç½²\n"
						message += "å¯ç”¨èŠ‚ç‚¹: ${allHostsCount} å°\n"
						message += "é€‰æ‹©èŠ‚ç‚¹: ${hostsConfig.size()} å°\n\n"
						message += "å°†è¦éƒ¨ç½²åˆ°:\n"

						hostsConfig.eachWithIndex { hostConfig, index ->
							message += "  ${index + 1}. ${hostConfig.name} (${hostConfig.host})\n"
						}
					} else {
						message += "æœåŠ¡å™¨: ${env.HOST}\n"
					}

					message += "\n"
					message += "è·³è¿‡å¥åº·æ£€æŸ¥: ${params.SKIP_HEALTH_CHECK ? 'æ˜¯' : 'å¦'}\n"

					if (env.PROJECT_TYPE == 'backend') {
						message += "å¹¶è¡Œå‘å¸ƒ: ${params.PARALLEL_DEPLOY ? 'æ˜¯' : 'å¦'}\n"
					}

					message += """

âš ï¸ æ­¤æ“ä½œå°†æ›´æ–°ç”Ÿäº§ç¯å¢ƒï¼
========================================
"""

					echo "=========================================="
					echo "ç¡®è®¤å‘å¸ƒå¼¹çª—å†…å®¹:"
					echo "=========================================="
					echo message
					echo "=========================================="

					timeout(time: 10, unit: 'MINUTES') {
						input message: message, ok: 'âœ… ç¡®è®¤å‘å¸ƒ'
					}
				}
			}
		}

		stage('æ‰§è¡Œéƒ¨ç½²') {
			steps {
				script {
					def currentTime = new Date().format('yyyy-MM-dd HH:mm:ss')
					def deployedBy = env.BUILD_USER ?: 'jenkins'
					def buildNum = env.BUILD_NUMBER.toInteger()
					def deploymentPlan = readJSON text: env.DEPLOYMENT_PLAN

					def deployResults

					try {
						if (env.PROJECT_TYPE == 'frontend') {
							deployResults = deployFrontendWithResults(deploymentPlan, currentTime, deployedBy, buildNum)
						} else {
							if (params.PARALLEL_DEPLOY && deploymentPlan.size() > 1) {
								deployResults = deployBackendParallel(deploymentPlan, currentTime, deployedBy, buildNum)
							} else {
								deployResults = deployBackendSerial(deploymentPlan, currentTime, deployedBy, buildNum)
							}
						}

						env.DEPLOY_RESULTS = writeJSON returnText: true, json: deployResults

					} catch (Exception e) {
						echo "âŒ éƒ¨ç½²å¤±è´¥: ${e.message}"
						throw e
					}
				}
			}
		}

		stage('æ›´æ–°æ¸…å•') {
			steps {
				script {
					echo "=========================================="
					echo "ğŸ“ æ›´æ–°å‘å¸ƒæ¸…å•ï¼ˆå¢é‡æ›´æ–° + å†å²ä¿ç•™ + å®ä¾‹è¿½è¸ªï¼‰"
					echo "=========================================="

					def manifestDir = '/data/deployments'
					def manifestFile = "${manifestDir}/production-deployment.json"
					def currentTime = new Date().format('yyyyMMdd-HHmmss')
					def newManifestFile = "${manifestDir}/production-deployment-${currentTime}.json"

					// 1. è¯»å–ç°æœ‰æ¸…å•
					def manifest = [:]
					if (fileExists(manifestFile)) {
						try {
							manifest = readJSON file: manifestFile
							echo "âœ“ è¯»å–ç°æœ‰æ¸…å•æˆåŠŸ"
							echo "  å½“å‰æ¸…å•: ${manifestFile}"
						} catch (Exception e) {
							echo "âš ï¸ è¯»å–ç°æœ‰æ¸…å•å¤±è´¥ï¼Œåˆ›å»ºæ–°æ¸…å•: ${e.message}"
							manifest = [:]
						}
					} else {
						echo "âœ“ é¦–æ¬¡åˆ›å»ºæ¸…å•"
					}

					// åˆå§‹åŒ–ç»“æ„
					if (!manifest.projects) {
						manifest.projects = [:]
					}
					if (!manifest.projects[env.PROJECT_NAME]) {
						manifest.projects[env.PROJECT_NAME] = [:]
					}
					if (!manifest.projects[env.PROJECT_NAME].hosts) {
						manifest.projects[env.PROJECT_NAME].hosts = [:]
					}

					// 2. æ›´æ–°éƒ¨ç½²ç»“æœ
					def deployResults = readJSON text: env.DEPLOY_RESULTS
					def config = readJSON file: env.CONFIG_FILE

					deployResults.each { host, result ->
						echo ""
						echo "æ›´æ–°ä¸»æœº: ${host} (${result.name})"

						if (!manifest.projects[env.PROJECT_NAME].hosts[host]) {
							echo "  âœ“ æ–°ä¸»æœºï¼Œåˆ›å»ºè®°å½•"
							manifest.projects[env.PROJECT_NAME].hosts[host] = [
								name: result.name,
								modules: [:],
								lastDeployTime: result.lastDeployTime
							]
						} else {
							echo "  âœ“ ä¸»æœºå·²å­˜åœ¨ï¼Œå¢é‡æ›´æ–°"
						}

						// æ›´æ–°æ¯ä¸ªæ¨¡å—
						result.modules.each { module, moduleInfo ->
							def oldModuleInfo = manifest.projects[env.PROJECT_NAME].hosts[host].modules[module]
							def oldVersion = oldModuleInfo?.version

							if (moduleInfo.instances) {
								// åŒå®ä¾‹æ¨¡å¼
								echo "  â€¢ ${module}: åŒå®ä¾‹æ¨¡å¼"

								if (!oldModuleInfo) {
									echo "    - é¦–æ¬¡éƒ¨ç½²æ­¤æ¨¡å—"
									manifest.projects[env.PROJECT_NAME].hosts[host].modules[module] = [
										version: moduleInfo.version,
										deployTime: moduleInfo.deployTime,
										deployedBy: moduleInfo.deployedBy,
										buildNumber: moduleInfo.buildNumber,
										status: moduleInfo.status,
										instances: [:]
									]
									oldModuleInfo = manifest.projects[env.PROJECT_NAME].hosts[host].modules[module]
								} else if (!oldModuleInfo.instances) {
									echo "    - ä»å•å®ä¾‹å‡çº§åˆ°åŒå®ä¾‹"
									oldModuleInfo.instances = [:]
								}

								// æ›´æ–°æ¯ä¸ªå®ä¾‹
								moduleInfo.instances.each { instance, instInfo ->
									def oldInstVersion = oldModuleInfo.instances?."${instance}"?.version

									if (oldInstVersion) {
										if (oldInstVersion != instInfo.version) {
											echo "    - ${instance}: ${oldInstVersion} â†’ ${instInfo.version}"
										} else {
											echo "    - ${instance}: ${instInfo.version} (é‡æ–°éƒ¨ç½²)"
										}
									} else {
										echo "    - ${instance}: æ–°å¢ ${instInfo.version}"
									}

									oldModuleInfo.instances[instance] = instInfo
								}

								// æ›´æ–°æ¨¡å—çº§åˆ«ä¿¡æ¯
								oldModuleInfo.version = moduleInfo.version
								oldModuleInfo.deployTime = moduleInfo.deployTime
								oldModuleInfo.deployedBy = moduleInfo.deployedBy
								oldModuleInfo.buildNumber = moduleInfo.buildNumber
								oldModuleInfo.status = moduleInfo.status

							} else {
								// å•å®ä¾‹æ¨¡å¼
								if (oldVersion) {
									echo "  â€¢ ${module}: ${oldVersion} â†’ ${moduleInfo.version}"
								} else {
									echo "  â€¢ ${module}: æ–°å¢ ${moduleInfo.version}"
								}

								manifest.projects[env.PROJECT_NAME].hosts[host].modules[module] = moduleInfo
							}
						}

						// æ›´æ–°ä¸»æœºçº§åˆ«ä¿¡æ¯
						manifest.projects[env.PROJECT_NAME].hosts[host].lastDeployTime = result.lastDeployTime
						manifest.projects[env.PROJECT_NAME].hosts[host].name = result.name

						echo "  âœ“ ä¸»æœº ${host} æ›´æ–°å®Œæˆ"
					}

					// 3. æ›´æ–°å…ƒæ•°æ®
					def updateTime = new Date().format('yyyy-MM-dd HH:mm:ss')
					manifest.metadata = [
						lastUpdate: updateTime,
						version: '1.0',
						buildNumber: env.BUILD_NUMBER.toInteger(),
						deployedBy: env.BUILD_USER ?: 'jenkins'
					]

					// 4. å†™å…¥æ–°æ¸…å•
					writeJSON file: newManifestFile, json: manifest, pretty: 4
					echo ""
					echo "âœ… æ–°æ¸…å•å·²ç”Ÿæˆ: ${newManifestFile}"

					// 5. æ›´æ–°è½¯é“¾æ¥
					sh """
                cd ${manifestDir}

                if [ -L production-deployment.json ]; then
                    rm -f production-deployment.json
                    echo "âœ“ åˆ é™¤æ—§è½¯é“¾æ¥"
                elif [ -f production-deployment.json ]; then
                    mv production-deployment.json production-deployment.json.backup
                    echo "âœ“ å¤‡ä»½æ—§æ–‡ä»¶ä¸º production-deployment.json.backup"
                fi

                ln -s production-deployment-${currentTime}.json production-deployment.json
                echo "âœ“ åˆ›å»ºæ–°è½¯é“¾æ¥æŒ‡å‘æœ€æ–°æ¸…å•"

                ls -lh production-deployment.json
            """

					// 6. æ¸…ç†æ—§æ¸…å•
					sh """
                cd ${manifestDir}

                HISTORY_COUNT=\$(ls -1 production-deployment-*.json 2>/dev/null | wc -l)
                echo ""
                echo "ğŸ“Š å†å²æ¸…å•ç»Ÿè®¡:"
                echo "  å½“å‰æ•°é‡: \$HISTORY_COUNT"

                if [ "\$HISTORY_COUNT" -gt 10 ]; then
                    echo "  ä¿ç•™æ•°é‡: 10"
                    echo "  æ¸…ç†æ•°é‡: \$((HISTORY_COUNT - 10))"

                    ls -1t production-deployment-*.json | tail -n +11 | xargs rm -f
                    echo "  âœ… å·²æ¸…ç†æ—§æ¸…å•"
                else
                    echo "  âœ… æ— éœ€æ¸…ç†ï¼ˆæœªè¶…è¿‡ 10 ä¸ªï¼‰"
                fi

                echo ""
                echo "ğŸ“‹ å†å²æ¸…å•åˆ—è¡¨ï¼ˆæœ€è¿‘ 10 ä¸ªï¼‰:"
                ls -1t production-deployment-*.json | head -10 | while read file; do
                    SIZE=\$(du -h "\$file" | cut -f1)
                    TIME=\$(stat -c %y "\$file" | cut -d'.' -f1)
                    echo "  â€¢ \$file (\$SIZE, \$TIME)"
                done
            """

					// 7. æ˜¾ç¤ºéƒ¨ç½²çŠ¶æ€
					echo ""
					echo "=========================================="
					echo "ğŸ“Š å½“å‰å®Œæ•´éƒ¨ç½²çŠ¶æ€"
					echo "=========================================="

					manifest.projects[env.PROJECT_NAME].hosts.each { host, info ->
						echo ""
						echo "ğŸ–¥ï¸  ${info.name} (${host})"
						echo "   æœ€åéƒ¨ç½²: ${info.lastDeployTime}"
						echo "   æ¨¡å—æ€»æ•°: ${info.modules.size()}"
						echo ""

						info.modules.each { module, moduleInfo ->
							def statusIcon = moduleInfo.status == 'success' ? 'âœ…' : 'âŒ'
							def isNew = deployResults[host]?.modules?.containsKey(module)
							def badge = isNew ? " ğŸ†• æœ¬æ¬¡æ›´æ–°" : ""

							echo "     ${statusIcon} ${module}${badge}"
							echo "        ç‰ˆæœ¬: ${moduleInfo.version}"
							echo "        æ—¶é—´: ${moduleInfo.deployTime}"
							echo "        æ“ä½œäºº: ${moduleInfo.deployedBy}"
							echo "        æ„å»ºå·: #${moduleInfo.buildNumber}"

							if (moduleInfo.instances) {
								echo "        å®ä¾‹æ¨¡å¼: åŒå®ä¾‹"

								def projectConfig = config.projects[env.PROJECT_NAME]
								def allInstances = projectConfig?.instances?.list ?: ['instance1', 'instance2']

								allInstances.each { instance ->
									def instInfo = moduleInfo.instances[instance]
									if (instInfo) {
										def instIcon = instInfo.status == 'success' ? 'âœ…' : 'âŒ'
										def isPrimary = (instance == 'instance1' || instance == 'master')
										def instBadge = isPrimary ? 'ğŸ”´' : 'ğŸŸ¢'
										def isNewInst = deployResults[host]?.modules?."${module}"?.instances?.containsKey(instance)
										def updateBadge = isNewInst ? ' [æœ¬æ¬¡æ›´æ–°]' : ''

										echo "          ${instIcon} ${instBadge} ${instance}: ${instInfo.version} (${instInfo.deployTime})${updateBadge}"
									} else {
										echo "          âšª ${instance}: æœªéƒ¨ç½²"
									}
								}
							} else {
								echo "        å®ä¾‹æ¨¡å¼: å•å®ä¾‹"
							}

							if (moduleInfo.error) {
								echo "        é”™è¯¯: ${moduleInfo.error}"
							}
						}
					}

					echo ""
					echo "=========================================="
					echo "ğŸ“ æœ¬æ¬¡æ›´æ–°æ‘˜è¦"
					echo "=========================================="

					deployResults.each { host, result ->
						echo "  ${result.name} (${host}):"
						result.modules.each { module, moduleInfo ->
							if (moduleInfo.instances) {
								echo "    âœ“ ${module}: ${moduleInfo.version}"
								moduleInfo.instances.each { instance, instInfo ->
									def isPrimary = (instance == 'instance1' || instance == 'master')
									def badge = isPrimary ? 'ğŸ”´' : 'ğŸŸ¢'
									echo "      ${badge} ${instance}: ${instInfo.version}"
								}
							} else {
								echo "    âœ“ ${module}: ${moduleInfo.version}"
							}
						}
					}

					echo ""
					echo "=========================================="
					echo "ğŸ“‚ æ¸…å•æ–‡ä»¶ä½ç½®"
					echo "=========================================="
					echo "  å½“å‰æ¸…å•: ${manifestFile} (è½¯é“¾æ¥)"
					echo "  æœ€æ–°æ¸…å•: ${newManifestFile}"
					echo "  å†å²ç›®å½•: ${manifestDir}"
					echo "=========================================="
				}
			}
		}

	}

	post {
		success {
			echo "âœ… éƒ¨ç½²æˆåŠŸ"
		}
		failure {
			echo "âŒ éƒ¨ç½²å¤±è´¥"
		}
	}
}

@NonCPS
def createModuleInfo(String version, String currentTime, String deployedBy, int buildNum, String status, String error = null) {
	def moduleInfo = [
		version: version,
		deployTime: currentTime,
		deployedBy: deployedBy,
		buildNumber: buildNum,
		status: status
	]

	if (error) {
		moduleInfo.error = error
	}

	if (env.INSTANCE_MODE == 'MULTI') {
		def instances = env.SELECTED_INSTANCES.split(',').collect { it.trim() }
		moduleInfo.instances = [:]
		instances.each { inst ->
			moduleInfo.instances[inst] = [
				version: version,
				deployTime: currentTime,
				status: status
			]
			if (error) {
				moduleInfo.instances[inst].error = error
			}
		}
	}

	return moduleInfo
}
def deployFrontendWithResults(Map deploymentPlan, String currentTime, String deployedBy, int buildNum) {
	def deployResults = [:]

	try {
		deployFrontendProject(deploymentPlan['frontend'])

		def host = env.HOST
		deployResults[host] = [
			name: "å‰ç«¯æœåŠ¡å™¨",
			modules: [
				frontend: createModuleInfo(
					deploymentPlan['frontend'],
					currentTime,
					deployedBy,
					buildNum,
					'success'
				)
			],
			lastDeployTime: currentTime
		]
	} catch (Exception e) {
		echo "âŒ å‰ç«¯éƒ¨ç½²å¤±è´¥: ${e.message}"

		def host = env.HOST
		deployResults[host] = [
			name: "å‰ç«¯æœåŠ¡å™¨",
			modules: [
				frontend: createModuleInfo(
					deploymentPlan['frontend'],
					currentTime,
					deployedBy,
					buildNum,
					'failed',
					e.message
				)
			],
			lastDeployTime: currentTime
		]

		throw e
	}

	return deployResults
}
def deployBackendParallel(Map deploymentPlan, String currentTime, String deployedBy, int buildNum) {
	echo "ä½¿ç”¨å¹¶è¡Œæ¨¡å¼å‘å¸ƒ..."

	def parallelStages = [:]
	deploymentPlan.each { module, version ->
		parallelStages[module] = {
			deployBackendModule(module, version)
		}
	}
	parallel parallelStages

	return recordDeployResults(deploymentPlan, currentTime, deployedBy, buildNum, 'success')
}
def deployBackendSerial(Map deploymentPlan, String currentTime, String deployedBy, int buildNum) {
	echo "ä½¿ç”¨ä¸²è¡Œæ¨¡å¼å‘å¸ƒ..."

	def deployResults

	if (env.DEPLOY_MODE == 'MULTI_HOST') {
		deployResults = deployBackendSerialMultiHost(deploymentPlan, currentTime, deployedBy, buildNum)
	} else {
		deployResults = deployBackendSerialSingleHost(deploymentPlan, currentTime, deployedBy, buildNum)
	}

	return deployResults
}
def deployBackendSerialMultiHost(Map deploymentPlan, String currentTime, String deployedBy, int buildNum) {
	def hostsConfig = readJSON text: env.HOSTS_CONFIG
	def deployResults = [:]

	hostsConfig.each { hostConfig ->
		def host = hostConfig.host
		deployResults[host] = [
			name: hostConfig.name,
			modules: [:],
			lastDeployTime: currentTime
		]
	}
	deploymentPlan.each { module, version ->
		echo "\n=========================================="
		echo "å‘å¸ƒæ¨¡å—: ${module}"
		echo "ç‰ˆæœ¬: ${version}"
		echo "=========================================="

		try {
			deployBackendModule(module, version)

			hostsConfig.each { hostConfig ->
				def host = hostConfig.host
				deployResults[host].modules[module] = createModuleInfo(
					version, currentTime, deployedBy, buildNum, 'success'
				)
			}
		} catch (Exception e) {
			echo "âŒ æ¨¡å— ${module} éƒ¨ç½²å¤±è´¥: ${e.message}"

			hostsConfig.each { hostConfig ->
				def host = hostConfig.host
				deployResults[host].modules[module] = createModuleInfo(
					version, currentTime, deployedBy, buildNum, 'failed', e.message
				)
			}

			throw e
		}
	}

	return deployResults
}
def deployBackendSerialSingleHost(Map deploymentPlan, String currentTime, String deployedBy, int buildNum) {
	def host = env.HOST
	def moduleResults = [:]

	deploymentPlan.each { module, version ->
		echo "\n=========================================="
		echo "å‘å¸ƒæ¨¡å—: ${module}"
		echo "ç‰ˆæœ¬: ${version}"
		echo "=========================================="

		try {
			deployBackendModule(module, version)

			moduleResults[module] = createModuleInfo(
				version, currentTime, deployedBy, buildNum, 'success'
			)
		} catch (Exception e) {
			echo "âŒ æ¨¡å— ${module} éƒ¨ç½²å¤±è´¥: ${e.message}"

			moduleResults[module] = createModuleInfo(
				version, currentTime, deployedBy, buildNum, 'failed', e.message
			)

			throw e
		}
	}

	return [
		(host): [
			name: "å•ä¸»æœº",
			modules: moduleResults,
			lastDeployTime: currentTime
		]
	]
}
def recordDeployResults(Map deploymentPlan, String currentTime, String deployedBy, int buildNum, String status) {
	def deployResults = [:]

	if (env.DEPLOY_MODE == 'MULTI_HOST') {
		def hostsConfig = readJSON text: env.HOSTS_CONFIG

		hostsConfig.each { hostConfig ->
			def host = hostConfig.host
			def moduleResults = [:]

			deploymentPlan.each { module, version ->
				moduleResults[module] = createModuleInfo(
					version, currentTime, deployedBy, buildNum, status
				)
			}

			deployResults[host] = [
				name: hostConfig.name,
				modules: moduleResults,
				lastDeployTime: currentTime
			]
		}
	} else {
		def host = env.HOST
		def moduleResults = [:]

		deploymentPlan.each { module, version ->
			moduleResults[module] = createModuleInfo(
				version, currentTime, deployedBy, buildNum, status
			)
		}

		deployResults[host] = [
			name: "å•ä¸»æœº",
			modules: moduleResults,
			lastDeployTime: currentTime
		]
	}

	return deployResults
}

@NonCPS
def parseProjectInfo(String project) {
	def matcher = project =~ /^\[(åç«¯|å‰ç«¯)\]\s+(.+)$/
	if (!matcher.find()) {
		return null
	}
	return [
		typeCn: matcher.group(1).toString(),
		name: matcher.group(2).toString()
	]
}

def deployBackendModule(String module, String version) {

	if (env.DEPLOY_MODE == 'MULTI_HOST') {

		def hostsConfig = readJSON text: env.HOSTS_CONFIG

		echo ""
		echo "=========================================="
		echo "ğŸ“¦ æ¨¡å—: ${module}"
		echo "ğŸ”„ å¤šä¸»æœºéƒ¨ç½²æ¨¡å¼ï¼ˆå…± ${hostsConfig.size()} å°ä¸»æœºï¼‰"
		echo "=========================================="

		hostsConfig.eachWithIndex { hostConfig, index ->
			echo ""
			echo "----------------------------------------"
			echo "ğŸ–¥ï¸  ä¸»æœº ${index + 1}/${hostsConfig.size()}: ${hostConfig.name} (${hostConfig.host})"
			echo "----------------------------------------"

			deployToSingleHost(
				module: module,
				version: version,
				host: hostConfig.host,
				user: hostConfig.user,
				baseDir: hostConfig.baseDir,
				hostName: hostConfig.name
			)

			echo "âœ… ä¸»æœº ${index + 1} éƒ¨ç½²å®Œæˆ"
		}

		echo ""
		echo "=========================================="
		echo "âœ… æ¨¡å— ${module} å·²æˆåŠŸéƒ¨ç½²åˆ°æ‰€æœ‰ ${hostsConfig.size()} å°ä¸»æœº"
		echo "=========================================="

	} else {
		deployToSingleHost(
			module: module,
			version: version,
			host: env.HOST,
			user: env.USER,
			baseDir: env.BASE_DIR,
			hostName: env.HOST
		)
	}
}

def deployToSingleHost(Map config) {
	def module = config.module
	def version = config.version
	def host = config.host
	def user = config.user
	def baseDir = config.baseDir
	def hostName = config.hostName

	def instanceMode = env.INSTANCE_MODE ?: 'SINGLE'
	def selectedInstances = []

	if (instanceMode == 'MULTI') {
		selectedInstances = env.SELECTED_INSTANCES.split(',').collect { it.trim() }
	}

	def isDataPlatformJobs = env.PROJECT_NAME == 'zcf-data-platform-jobs'

	if (instanceMode == 'MULTI' && !isDataPlatformJobs) {
		echo ""
		echo "=========================================="
		echo "ğŸ¯ åŒå®ä¾‹æ¨¡å¼éƒ¨ç½²"
		echo "æ¨¡å—: ${module}"
		echo "ç‰ˆæœ¬: ${version}"
		echo "ä¸»æœº: ${hostName} (${host})"
		echo "å®ä¾‹: ${selectedInstances.join(', ')}"
		echo "=========================================="

		def artifactFile = "${env.ARTIFACTS_DIR}/backend/${env.PROJECT_NAME}/${module}/${version}"
		def jarName = "${module}.jar"

		selectedInstances.eachWithIndex { instance, idx ->
			def instancePath = "${baseDir}/${module}/${instance}"
			def isPrimary = (instance == 'instance1' || instance == 'master')
			def badge = isPrimary ? 'ğŸ”´ ä¸»å®ä¾‹' : 'ğŸŸ¢ ä»å®ä¾‹'

			// æ ¹æ®å®ä¾‹åç§°ç¡®å®š systemd æœåŠ¡åç§°
			def instanceSuffix = (instance == 'instance1' || instance == 'master') ? 'node1' : 'node2'
			def serviceName = "${module}-${instanceSuffix}.service"

			echo ""
			echo "----------------------------------------"
			echo "${badge} å®ä¾‹ ${idx + 1}/${selectedInstances.size()}: ${instance}"
			echo "----------------------------------------"
			echo "  æºæ–‡ä»¶: ${artifactFile}"
			echo "  ç›®æ ‡è·¯å¾„: ${instancePath}/${jarName}"
			echo "  æœåŠ¡åç§°: ${serviceName}"

			sshagent(['deploy-ssh-key']) {
				echo "  [${instance}] 1/6 æ£€æŸ¥ç›®å½•ç»“æ„..."
				sh """
                    ssh -o StrictHostKeyChecking=no ${user}@${host} '
                        # åˆ›å»ºå®ä¾‹ç›®å½•
                        mkdir -p ${instancePath}
                        echo "âœ… å®ä¾‹ç›®å½•: ${instancePath}"

                        # æ£€æŸ¥æ˜¯å¦é¦–æ¬¡éƒ¨ç½²
                        if [ -f ${instancePath}/${jarName} ]; then
                            CURRENT_SIZE=\$(du -h ${instancePath}/${jarName} | cut -f1)
                            CURRENT_TIME=\$(stat -c %y ${instancePath}/${jarName} | cut -d. -f1)
                            echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬: \$CURRENT_SIZE (\$CURRENT_TIME)"
                        else
                            echo "â„¹ï¸  é¦–æ¬¡éƒ¨ç½²åˆ°æ­¤å®ä¾‹"
                        fi

                        # æ˜¾ç¤ºå†å²å¤‡ä»½
                        echo ""
                        echo "ğŸ“š ${instance} å†å²å¤‡ä»½:"
                        if ls ${instancePath}/${jarName}.bak.* >/dev/null 2>&1; then
                            ls -lht ${instancePath}/${jarName}.bak.* | head -5 | while read -r line; do
                                filename=\$(echo "\$line" | awk "{print \\\$9}")
                                size=\$(echo "\$line" | awk "{print \\\$5}")
                                date=\$(echo "\$line" | awk "{print \\\$6, \\\$7, \\\$8}")
                                echo "  \$(basename \$filename) (\$size, \$date)"
                            done
                        else
                            echo "  (æ— )"
                        fi
                        echo ""
                    '
                """

				echo "  [${instance}] 2/6 åœæ­¢æœåŠ¡ (systemd)..."
				sh """
                    ssh -o StrictHostKeyChecking=no ${user}@${host} '
                        echo "ğŸ›‘ åœæ­¢æœåŠ¡: ${serviceName}"

                        # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
                        if systemctl list-unit-files | grep -q "^${serviceName}"; then
                            echo "âœ… æœåŠ¡å­˜åœ¨: ${serviceName}"

                            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                            if systemctl is-active --quiet ${serviceName}; then
                                echo "æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå‡†å¤‡åœæ­¢..."

                                # åœæ­¢æœåŠ¡
                                sudo systemctl stop ${serviceName}

                                # ç­‰å¾…æœåŠ¡åœæ­¢
                                RETRY=0
                                MAX_RETRIES=10
                                while [ \$RETRY -lt \$MAX_RETRIES ]; do
                                    if ! systemctl is-active --quiet ${serviceName}; then
                                        echo "âœ… æœåŠ¡å·²æˆåŠŸåœæ­¢"
                                        break
                                    fi
                                    echo "ç­‰å¾…æœåŠ¡åœæ­¢... (\$((RETRY+1))/\$MAX_RETRIES)"
                                    sleep 2
                                    RETRY=\$((RETRY+1))
                                done

                                # æœ€ç»ˆæ£€æŸ¥
                                if systemctl is-active --quiet ${serviceName}; then
                                    echo "âŒ æœåŠ¡åœæ­¢è¶…æ—¶"
                                    systemctl status ${serviceName} --no-pager || true
                                    exit 1
                                fi
                            else
                                echo "â„¹ï¸  æœåŠ¡æœªè¿è¡Œ"
                            fi
                        else
                            echo "âš ï¸  æœåŠ¡ä¸å­˜åœ¨: ${serviceName}"
                            echo "ğŸ’¡ æç¤º: è¯·ç¡®ä¿å·²åˆ›å»º systemd æœåŠ¡æ–‡ä»¶"
                            echo "   ä½ç½®: /etc/systemd/system/${serviceName}"
                        fi
                    '
                """

				echo "  [${instance}] 3/6 å¤‡ä»½æ—§ç‰ˆæœ¬..."
				sh """
                    ssh -o StrictHostKeyChecking=no ${user}@${host} '
                        cd ${instancePath}

                        if [ -f ${jarName} ]; then
                            BACKUP_FILE="${jarName}.bak.\$(date +%Y%m%d_%H%M%S)"
                            mv ${jarName} "\$BACKUP_FILE"
                            echo "âœ… æ—§ç‰ˆæœ¬å·²å¤‡ä»½ä¸º: \$BACKUP_FILE"

                            # åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
                            BACKUP_COUNT=\$(ls -t ${jarName}.bak.* 2>/dev/null | wc -l)
                            if [ "\$BACKUP_COUNT" -gt 5 ]; then
                                DELETED=\$(ls -t ${jarName}.bak.* | tail -n +6)
                                ls -t ${jarName}.bak.* | tail -n +6 | xargs rm -f
                                echo "âœ… å·²æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰"
                                echo "åˆ é™¤çš„å¤‡ä»½:"
                                echo "\$DELETED" | while read f; do echo "  - \$(basename \$f)"; done
                            fi
                        else
                            echo "â„¹ï¸  æ—§ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
                        fi
                    '
                """

				echo "  [${instance}] 4/6 ä¼ è¾“æ–°æ–‡ä»¶..."
				sh """
                    scp -o StrictHostKeyChecking=no '${artifactFile}' ${user}@${host}:'${instancePath}/${jarName}'

                    # éªŒè¯æ–‡ä»¶ä¼ è¾“
                    ssh -o StrictHostKeyChecking=no ${user}@${host} '
                        if [ -f ${instancePath}/${jarName} ]; then
                            FILE_SIZE=\$(du -h ${instancePath}/${jarName} | cut -f1)
                            echo "âœ… æ–‡ä»¶ä¼ è¾“æˆåŠŸ: \$FILE_SIZE"

                            # è®¡ç®— MD5
                            if command -v md5sum >/dev/null 2>&1; then
                                MD5=\$(md5sum ${instancePath}/${jarName} | cut -d" " -f1)
                                echo "MD5: \$MD5"
                            fi
                        else
                            echo "âŒ æ–‡ä»¶ä¼ è¾“å¤±è´¥"
                            exit 1
                        fi
                    '
                """

				echo "  [${instance}] 5/6 å¯åŠ¨æœåŠ¡ (systemd)..."
				sh """
                    ssh -o StrictHostKeyChecking=no ${user}@${host} '
                        echo "ğŸš€ å¯åŠ¨æœåŠ¡: ${serviceName}"

                        # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
                        if systemctl list-unit-files | grep -q "^${serviceName}"; then
                            # é‡è½½ systemd é…ç½®ï¼ˆä»¥é˜²æœåŠ¡æ–‡ä»¶æœ‰æ›´æ–°ï¼‰
                            sudo systemctl daemon-reload

                            # å¯åŠ¨æœåŠ¡
                            sudo systemctl start ${serviceName}

                            # ç­‰å¾…æœåŠ¡å¯åŠ¨
                            sleep 3

                            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                            if systemctl is-active --quiet ${serviceName}; then
                                echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
                                echo ""
                                echo "æœåŠ¡çŠ¶æ€:"
                                systemctl status ${serviceName} --no-pager -l || true
                            else
                                echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
                                echo ""
                                echo "æœåŠ¡çŠ¶æ€:"
                                systemctl status ${serviceName} --no-pager -l || true
                                echo ""
                                echo "æœ€è¿‘æ—¥å¿—:"
                                journalctl -u ${serviceName} -n 50 --no-pager || true
                                exit 1
                            fi
                        else
                            echo "âŒ æœåŠ¡ä¸å­˜åœ¨: ${serviceName}"
                            echo "ğŸ’¡ æç¤º: è¯·å…ˆåˆ›å»º systemd æœåŠ¡æ–‡ä»¶"
                            exit 1
                        fi
                    '
                """

				if (!params.SKIP_HEALTH_CHECK) {
					echo "  [${instance}] 6/6 å¥åº·æ£€æŸ¥..."
					sh """
                        ssh -o StrictHostKeyChecking=no ${user}@${host} '
                            echo "ğŸ” å¥åº·æ£€æŸ¥: ${serviceName}"

                            # ç­‰å¾…æœåŠ¡ç¨³å®š
                            sleep 5

                            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                            if systemctl is-active --quiet ${serviceName}; then
                                echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"

                                # æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯
                                MAIN_PID=\$(systemctl show -p MainPID --value ${serviceName})
                                if [ -n "\$MAIN_PID" ] && [ "\$MAIN_PID" != "0" ]; then
                                    echo "è¿›ç¨‹ PID: \$MAIN_PID"

                                    # æ˜¾ç¤ºå†…å­˜ä½¿ç”¨
                                    if command -v ps >/dev/null 2>&1; then
                                        MEM_USAGE=\$(ps -p \$MAIN_PID -o rss= 2>/dev/null | awk "{print \\\$1/1024}")
                                        if [ -n "\$MEM_USAGE" ]; then
                                            echo "å†…å­˜ä½¿ç”¨: \${MEM_USAGE} MB"
                                        fi
                                    fi
                                fi

                                # æ£€æŸ¥ç«¯å£ç›‘å¬ï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰
                                if command -v netstat >/dev/null 2>&1; then
                                    echo ""
                                    echo "ç›‘å¬ç«¯å£:"
                                    netstat -tlnp 2>/dev/null | grep \$MAIN_PID || echo "  (æ— æ³•è·å–ç«¯å£ä¿¡æ¯)"
                                fi

                                # æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—
                                echo ""
                                echo "æœ€è¿‘æ—¥å¿— (æœ€å 10 è¡Œ):"
                                journalctl -u ${serviceName} -n 10 --no-pager || true

                            else
                                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥: æœåŠ¡æœªè¿è¡Œ"
                                echo ""
                                echo "æœåŠ¡çŠ¶æ€:"
                                systemctl status ${serviceName} --no-pager -l || true
                                echo ""
                                echo "æœ€è¿‘æ—¥å¿—:"
                                journalctl -u ${serviceName} -n 50 --no-pager || true
                                exit 1
                            fi
                        '
                    """
				} else {
					echo "  [${instance}] 6/6 è·³è¿‡å¥åº·æ£€æŸ¥"
				}

				echo "  [${instance}] âœ… å®ä¾‹éƒ¨ç½²å®Œæˆ"
			}

			if (idx < selectedInstances.size() - 1) {
				def waitTime = 150
				echo ""
				echo "â³ ç­‰å¾… ${waitTime} ç§’åéƒ¨ç½²ä¸‹ä¸€ä¸ªå®ä¾‹..."
				echo "   (ç¡®ä¿å½“å‰å®ä¾‹ç¨³å®šåå†éƒ¨ç½²ä¸‹ä¸€ä¸ª)"
				sleep waitTime
			}
		}

		echo ""
		echo "=========================================="
		echo "âœ… æ¨¡å— ${module} æ‰€æœ‰å®ä¾‹éƒ¨ç½²å®Œæˆ"
		echo "å·²éƒ¨ç½²å®ä¾‹: ${selectedInstances.join(', ')}"
		echo "=========================================="

		return
	}

	// å•å®ä¾‹æˆ– Flink ä»»åŠ¡éƒ¨ç½²é€»è¾‘
	def modulePath
	if (isDataPlatformJobs) {
		modulePath = baseDir
	} else {
		modulePath = "${baseDir}/${module}"
	}

	def artifactFile = "${env.ARTIFACTS_DIR}/backend/${env.PROJECT_NAME}/${module}/${version}"
	def jarName = "${module}.jar"

	echo "  [${module}@${hostName}] å¼€å§‹å‘å¸ƒ..."
	echo "  [${module}@${hostName}] æºæ–‡ä»¶: ${artifactFile}"
	echo "  [${module}@${hostName}] ç›®æ ‡è·¯å¾„: ${modulePath}/${jarName}"

	sshagent(['deploy-ssh-key']) {
		if (isDataPlatformJobs) {
			// Flink ä»»åŠ¡éƒ¨ç½²ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
			echo "  [${module}@${hostName}] 1/3 æ£€æŸ¥ç›®æ ‡ç›®å½•..."
			sh """
                ssh -o StrictHostKeyChecking=no ${user}@${host} '
                    mkdir -p ${modulePath}
                    echo "âœ… ç›®æ ‡ç›®å½•å‡†å¤‡å®Œæˆ"

                    echo ""
                    echo "ğŸ“¦ ${module} å†å²å¤‡ä»½:"
                    if ls ${modulePath}/${jarName}.bak.* >/dev/null 2>&1; then
                        ls -lht ${modulePath}/${jarName}.bak.* | head -5 | while read -r line; do
                            filename=\$(echo "\$line" | awk "{print \\\$9}")
                            size=\$(echo "\$line" | awk "{print \\\$5}")
                            date=\$(echo "\$line" | awk "{print \\\$6, \\\$7, \\\$8}")
                            echo "  \$(basename \$filename) (\$size, \$date)"
                        done
                    else
                        echo "  (æ— )"
                    fi
                    echo ""
                '
            """

			echo "  [${module}@${hostName}] 2/3 å¤‡ä»½ç°æœ‰ç‰ˆæœ¬..."
			sh """
                ssh -o StrictHostKeyChecking=no ${user}@${host} '
                    cd ${modulePath}

                    if [ -f ${jarName} ]; then
                        BACKUP_FILE="${jarName}.bak.\$(date +%Y%m%d_%H%M%S)"
                        mv ${jarName} "\$BACKUP_FILE"
                        echo "âœ… ç°æœ‰ç‰ˆæœ¬å·²å¤‡ä»½ä¸º: \$BACKUP_FILE"

                        BACKUP_COUNT=\$(ls -t ${jarName}.bak.* 2>/dev/null | wc -l)
                        if [ "\$BACKUP_COUNT" -gt 5 ]; then
                            ls -t ${jarName}.bak.* | tail -n +6 | xargs rm -f
                            echo "âœ… å·²æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰"
                        fi
                    else
                        echo "â„¹ï¸  é¦–æ¬¡å‘å¸ƒï¼Œæ— éœ€å¤‡ä»½"
                    fi
                '
            """

			echo "  [${module}@${hostName}] 3/3 ä¼ è¾“æ–‡ä»¶..."
			sh """
                scp -o StrictHostKeyChecking=no '${artifactFile}' ${user}@${host}:'${modulePath}/${jarName}'

                ssh -o StrictHostKeyChecking=no ${user}@${host} '
                    if [ -f ${modulePath}/${jarName} ]; then
                        echo "âœ… æ–‡ä»¶ä¼ è¾“æˆåŠŸ"
                        echo ""
                        echo "æ–‡ä»¶ä¿¡æ¯:"
                        ls -lh ${modulePath}/${jarName}
                        echo ""

                        if command -v md5sum >/dev/null 2>&1; then
                            MD5=\$(md5sum ${modulePath}/${jarName} | cut -d" " -f1)
                            echo "MD5: \$MD5"
                        fi
                        echo ""

                        BACKUP_COUNT=\$(ls ${modulePath}/${jarName}.bak.* 2>/dev/null | wc -l)
                        echo "ğŸ“Š ${module} å…±æœ‰ \$BACKUP_COUNT ä¸ªå†å²å¤‡ä»½"
                    else
                        echo "âŒ æ–‡ä»¶ä¼ è¾“å¤±è´¥"
                        exit 1
                    fi
                '
            """

			echo "  [${module}@${hostName}] âœ… å‘å¸ƒå®Œæˆï¼ˆFlink ä»»åŠ¡ jarï¼Œæ— éœ€å¯åŠ¨ï¼‰"

			if (env.DEPLOY_MODE != 'MULTI_HOST') {
				echo ""
				echo "  ğŸ’¡ æç¤ºï¼š"
				echo "  â€¢ æ–‡ä»¶ä½ç½®: ${modulePath}/${jarName}"
				echo "  â€¢ éœ€è¦æ‰‹åŠ¨æäº¤åˆ° Flink é›†ç¾¤"
				echo "  â€¢ æäº¤å‘½ä»¤: flink run -d -c <ä¸»ç±»> ${modulePath}/${jarName}"
				echo ""
			}

		} else {
			// æ™®é€šæœåŠ¡éƒ¨ç½²ï¼ˆä½¿ç”¨ systemdï¼‰
			def serviceName = "${module}.service"

			echo "  [${module}@${hostName}] 1/5 åœæ­¢æœåŠ¡ (systemd)..."
			sh """
                ssh -o StrictHostKeyChecking=no ${user}@${host} '
                    echo "ğŸ›‘ åœæ­¢æœåŠ¡: ${serviceName}"

                    # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
                    if systemctl list-unit-files | grep -q "^${serviceName}"; then
                        echo "âœ… æœåŠ¡å­˜åœ¨: ${serviceName}"

                        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                        if systemctl is-active --quiet ${serviceName}; then
                            echo "æœåŠ¡æ­£åœ¨è¿è¡Œï¼Œå‡†å¤‡åœæ­¢..."

                            # åœæ­¢æœåŠ¡
                            sudo systemctl stop ${serviceName}

                            # ç­‰å¾…æœåŠ¡åœæ­¢
                            RETRY=0
                            MAX_RETRIES=10
                            while [ \$RETRY -lt \$MAX_RETRIES ]; do
                                if ! systemctl is-active --quiet ${serviceName}; then
                                    echo "âœ… æœåŠ¡å·²æˆåŠŸåœæ­¢"
                                    break
                                fi
                                echo "ç­‰å¾…æœåŠ¡åœæ­¢... (\$((RETRY+1))/\$MAX_RETRIES)"
                                sleep 2
                                RETRY=\$((RETRY+1))
                            done

                            # æœ€ç»ˆæ£€æŸ¥
                            if systemctl is-active --quiet ${serviceName}; then
                                echo "âŒ æœåŠ¡åœæ­¢è¶…æ—¶"
                                systemctl status ${serviceName} --no-pager || true
                                exit 1
                            fi
                        else
                            echo "â„¹ï¸  æœåŠ¡æœªè¿è¡Œ"
                        fi
                    else
                        echo "âš ï¸  æœåŠ¡ä¸å­˜åœ¨: ${serviceName}"
                        echo "ğŸ’¡ æç¤º: è¯·ç¡®ä¿å·²åˆ›å»º systemd æœåŠ¡æ–‡ä»¶"
                        echo "   ä½ç½®: /etc/systemd/system/${serviceName}"
                    fi
                ' || true
            """

			echo "  [${module}@${hostName}] 2/5 å¤‡ä»½æ—§ç‰ˆæœ¬..."
			sh """
                ssh -o StrictHostKeyChecking=no ${user}@${host} '
                    cd ${modulePath}

                    if [ -f ${jarName} ]; then
                        BACKUP_FILE="${jarName}.bak.\$(date +%Y%m%d_%H%M%S)"
                        mv ${jarName} "\$BACKUP_FILE"
                        echo "âœ… æ—§ç‰ˆæœ¬å·²å¤‡ä»½ä¸º: \$BACKUP_FILE"

                        ls -t ${jarName}.bak.* 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
                    else
                        echo "â„¹ï¸  æ—§ç‰ˆæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½"
                    fi
                '
            """

			echo "  [${module}@${hostName}] 3/5 ä¼ è¾“æ–°æ–‡ä»¶..."
			sh """
                scp -o StrictHostKeyChecking=no '${artifactFile}' ${user}@${host}:'${modulePath}/${jarName}'

                ssh -o StrictHostKeyChecking=no ${user}@${host} '
                    if [ -f ${modulePath}/${jarName} ]; then
                        echo "âœ… æ–‡ä»¶ä¼ è¾“æˆåŠŸ"
                        ls -lh ${modulePath}/${jarName}
                    else
                        echo "âŒ æ–‡ä»¶ä¼ è¾“å¤±è´¥"
                        exit 1
                    fi
                '
            """

			echo "  [${module}@${hostName}] 4/5 å¯åŠ¨æœåŠ¡ (systemd)..."
			sh """
                ssh -o StrictHostKeyChecking=no ${user}@${host} '
                    echo "ğŸš€ å¯åŠ¨æœåŠ¡: ${serviceName}"

                    # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
                    if systemctl list-unit-files | grep -q "^${serviceName}"; then
                        # é‡è½½ systemd é…ç½®
                        sudo systemctl daemon-reload

                        # å¯åŠ¨æœåŠ¡
                        sudo systemctl start ${serviceName}

                        # ç­‰å¾…æœåŠ¡å¯åŠ¨
                        sleep 3

                        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                        if systemctl is-active --quiet ${serviceName}; then
                            echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
                            echo ""
                            echo "æœåŠ¡çŠ¶æ€:"
                            systemctl status ${serviceName} --no-pager -l || true
                        else
                            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
                            echo ""
                            echo "æœåŠ¡çŠ¶æ€:"
                            systemctl status ${serviceName} --no-pager -l || true
                            echo ""
                            echo "æœ€è¿‘æ—¥å¿—:"
                            journalctl -u ${serviceName} -n 50 --no-pager || true
                            exit 1
                        fi
                    else
                        echo "âŒ æœåŠ¡ä¸å­˜åœ¨: ${serviceName}"
                        echo "ğŸ’¡ æç¤º: è¯·å…ˆåˆ›å»º systemd æœåŠ¡æ–‡ä»¶"
                        echo ""
                        echo "ç¤ºä¾‹æœåŠ¡æ–‡ä»¶ (/etc/systemd/system/${serviceName}):"
                        echo "----------------------------------------"
                        echo "[Unit]"
                        echo "Description=${module} Service"
                        echo "After=network.target"
                        echo ""
                        echo "[Service]"
                        echo "Type=simple"
                        echo "User=${user}"
                        echo "WorkingDirectory=${modulePath}"
                        echo "ExecStart=/usr/bin/java -jar ${modulePath}/${jarName}"
                        echo "Restart=on-failure"
                        echo "RestartSec=10"
                        echo ""
                        echo "[Install]"
                        echo "WantedBy=multi-user.target"
                        echo "----------------------------------------"
                        exit 1
                    fi
                '
            """

			if (!params.SKIP_HEALTH_CHECK) {
				echo "  [${module}@${hostName}] 5/5 å¥åº·æ£€æŸ¥..."
				sh """
                    ssh -o StrictHostKeyChecking=no ${user}@${host} '
                        echo "ğŸ” å¥åº·æ£€æŸ¥: ${serviceName}"

                        # ç­‰å¾…æœåŠ¡ç¨³å®š
                        sleep 5

                        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                        if systemctl is-active --quiet ${serviceName}; then
                            echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"

                            # æ˜¾ç¤ºè¿›ç¨‹ä¿¡æ¯
                            MAIN_PID=\$(systemctl show -p MainPID --value ${serviceName})
                            if [ -n "\$MAIN_PID" ] && [ "\$MAIN_PID" != "0" ]; then
                                echo "è¿›ç¨‹ PID: \$MAIN_PID"

                                # æ˜¾ç¤ºå†…å­˜ä½¿ç”¨
                                if command -v ps >/dev/null 2>&1; then
                                    MEM_USAGE=\$(ps -p \$MAIN_PID -o rss= 2>/dev/null | awk "{print \\\$1/1024}")
                                    if [ -n "\$MEM_USAGE" ]; then
                                        echo "å†…å­˜ä½¿ç”¨: \${MEM_USAGE} MB"
                                    fi
                                fi
                            fi

                            # æ˜¾ç¤ºæœ€è¿‘æ—¥å¿—
                            echo ""
                            echo "æœ€è¿‘æ—¥å¿— (æœ€å 10 è¡Œ):"
                            journalctl -u ${serviceName} -n 10 --no-pager || true

                        else
                            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥: æœåŠ¡æœªè¿è¡Œ"
                            echo ""
                            echo "æœåŠ¡çŠ¶æ€:"
                            systemctl status ${serviceName} --no-pager -l || true
                            echo ""
                            echo "æœ€è¿‘æ—¥å¿—:"
                            journalctl -u ${serviceName} -n 50 --no-pager || true
                            exit 1
                        fi
                    '
                """
			} else {
				echo "  [${module}@${hostName}] 5/5 è·³è¿‡å¥åº·æ£€æŸ¥"
			}

			echo "  [${module}@${hostName}] âœ… å‘å¸ƒå®Œæˆ"
		}
	}
}


def deployFrontendProject(String tarFileName) {
	def artifactPath = "${env.ARTIFACTS_DIR}/frontend/${env.PROJECT_NAME}/${tarFileName}"
	def nginxWebRoot = "${env.BASE_DIR}"

	echo "  [å‰ç«¯] å¼€å§‹å‘å¸ƒ..."
	echo "  åˆ¶å“: ${tarFileName}"
	echo "  æºè·¯å¾„: ${artifactPath}"
	echo "  ç›®æ ‡è·¯å¾„: ${nginxWebRoot}"

	sshagent(['deploy-ssh-key']) {
		echo "  [å‰ç«¯] 1/5 å¤‡ä»½æ—§ç‰ˆæœ¬..."
		sh """
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                cd ${nginxWebRoot}

                # æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰æ–‡ä»¶ï¼ˆæ’é™¤å¤‡ä»½ç›®å½•ï¼‰
                FILE_COUNT=\$(find . -maxdepth 1 ! -name "." ! -name "backup_*" | wc -l)

                if [ "\$FILE_COUNT" -gt 0 ]; then
                    BACKUP_DIR="backup_\$(date +%Y%m%d_%H%M%S)"
                    mkdir -p "\$BACKUP_DIR"

                    echo "å¤‡ä»½ç°æœ‰æ–‡ä»¶åˆ°: \$BACKUP_DIR"

                    # ç§»åŠ¨æ‰€æœ‰æ–‡ä»¶ï¼ˆæ’é™¤å¤‡ä»½ç›®å½•ï¼‰
                    for item in *; do
                        if [[ "\$item" != backup_* ]]; then
                            mv "\$item" "\$BACKUP_DIR/" 2>/dev/null || true
                        fi
                    done

                    echo "âœ… æ—§ç‰ˆæœ¬å·²å¤‡ä»½"

                    # åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
                    BACKUP_COUNT=\$(ls -dt backup_* 2>/dev/null | wc -l)
                    if [ "\$BACKUP_COUNT" -gt 5 ]; then
                        ls -dt backup_* | tail -n +6 | xargs rm -rf
                        echo "âœ… å·²æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰"
                    fi
                else
                    echo "â„¹ï¸ é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½"
                fi
            '
        """

		echo "  [å‰ç«¯] 2/5 ä¼ è¾“å‹ç¼©åŒ…..."
		sh """
            # ä¼ è¾“åˆ°ä¸´æ—¶ç›®å½•
            scp -o StrictHostKeyChecking=no '${artifactPath}' ${env.USER}@${env.HOST}:/tmp/frontend-deploy.tar.gz

            # éªŒè¯ä¼ è¾“
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                if [ -f /tmp/frontend-deploy.tar.gz ]; then
                    FILE_SIZE=\$(du -h /tmp/frontend-deploy.tar.gz | cut -f1)
                    echo "âœ… æ–‡ä»¶ä¼ è¾“æˆåŠŸï¼Œå¤§å°: \$FILE_SIZE"
                else
                    echo "âŒ æ–‡ä»¶ä¼ è¾“å¤±è´¥"
                    exit 1
                fi
            '
        """

		echo "  [å‰ç«¯] 3/5 è§£å‹æ–‡ä»¶..."
		sh """
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                cd ${nginxWebRoot}

                # è§£å‹åˆ°ä¸´æ—¶ç›®å½•
                TEMP_DIR=\$(mktemp -d)
                tar -xzf /tmp/frontend-deploy.tar.gz -C "\$TEMP_DIR"

                echo "ä¸´æ—¶ç›®å½•: \$TEMP_DIR"
                echo "ä¸´æ—¶ç›®å½•å†…å®¹:"
                ls -la "\$TEMP_DIR"

                DIST_DIR=\$(find "\$TEMP_DIR" -type d -name "dist" | head -1)

                if [ -n "\$DIST_DIR" ]; then
                    echo "âœ… æ‰¾åˆ° dist ç›®å½•: \$DIST_DIR"
                    SOURCE_DIR="\$DIST_DIR"
                else
                    if [ -f "\$TEMP_DIR/index.html" ]; then
                        echo "âœ… æ£€æµ‹åˆ°æ ¹ç›®å½•åŒ…å« index.htmlï¼ˆH5 é¡¹ç›®æ¨¡å¼ï¼‰"
                        SOURCE_DIR="\$TEMP_DIR"
                    else
                        echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ„å»ºäº§ç‰©"
                        echo "ä¸´æ—¶ç›®å½•ç»“æ„:"
                        find "\$TEMP_DIR" -maxdepth 3 -type f
                        rm -rf "\$TEMP_DIR"
                        exit 1
                    fi
                fi

                echo "ä½¿ç”¨æºç›®å½•: \$SOURCE_DIR"

                # ç§»åŠ¨æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
                mv "\$SOURCE_DIR"/* . 2>/dev/null || true
                mv "\$SOURCE_DIR"/.[!.]* . 2>/dev/null || true

                # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                rm -rf "\$TEMP_DIR"
                rm -f /tmp/frontend-deploy.tar.gz

                echo "âœ… æ–‡ä»¶è§£å‹å®Œæˆ"
            '
        """

		echo "  [å‰ç«¯] 4/5 éªŒè¯æ–‡ä»¶..."
		sh """
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                cd ${nginxWebRoot}

                if [ -f index.html ]; then
                    echo "âœ… æ–‡ä»¶éƒ¨ç½²æˆåŠŸ"
                    echo ""
                    echo "éƒ¨ç½²æ–‡ä»¶åˆ—è¡¨:"
                    ls -lh | head -15
                    echo ""
                    echo "index.html å¤§å°: \$(du -h index.html | cut -f1)"

                    # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
                    FILE_COUNT=\$(find . -type f ! -path "./backup_*/*" | wc -l)
                    DIR_COUNT=\$(find . -type d ! -path "./backup_*" ! -path "./backup_*/*" | wc -l)
                    TOTAL_SIZE=\$(du -sh --exclude="backup_*" . | cut -f1)

                    echo "æ–‡ä»¶æ•°é‡: \$FILE_COUNT"
                    echo "ç›®å½•æ•°é‡: \$DIR_COUNT"
                    echo "æ€»å¤§å°: \$TOTAL_SIZE"
                else
                    echo "âŒ æœªæ‰¾åˆ° index.htmlï¼Œéƒ¨ç½²å¯èƒ½å¤±è´¥"
                    echo "å½“å‰ç›®å½•å†…å®¹:"
                    ls -la
                    exit 1
                fi
            '
        """

		echo "  [å‰ç«¯] 5/5 é‡è½½ Nginx..."
		sh """
            ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                echo "æµ‹è¯• Nginx é…ç½®..."
                if sudo nginx -t 2>&1; then
                    echo "âœ… Nginx é…ç½®æµ‹è¯•é€šè¿‡"

                    echo "é‡è½½ Nginx..."
                    sudo nginx -s reload

                    if [ \$? -eq 0 ]; then
                        echo "âœ… Nginx é‡è½½æˆåŠŸ"
                    else
                        echo "âŒ Nginx é‡è½½å¤±è´¥"
                        exit 1
                    fi

                    # æ¸…ç† Nginx ç¼“å­˜ï¼ˆå¦‚æœé…ç½®äº†ç¼“å­˜ï¼‰
                    if [ -d /var/cache/nginx ]; then
                        sudo find /var/cache/nginx -type f -delete 2>/dev/null || true
                        echo "âœ… Nginx ç¼“å­˜å·²æ¸…ç†"
                    fi
                else
                    echo "âŒ Nginx é…ç½®æµ‹è¯•å¤±è´¥"
                    sudo nginx -t
                    exit 1
                fi
            '
        """

		if (!params.SKIP_HEALTH_CHECK) {
			echo "  [å‰ç«¯] 6/6 å¥åº·æ£€æŸ¥..."
			sh """
                # ç­‰å¾… Nginx é‡è½½å®Œæˆ
                sleep 3

                echo "æ£€æŸ¥ç½‘ç«™å¯è®¿é—®æ€§..."

                # å°è¯•è®¿é—®ç½‘ç«™
                HTTP_CODE=\$(curl -s -o /dev/null -w "%{http_code}" http://${env.HOST} 2>/dev/null || echo "000")

                if [ "\$HTTP_CODE" = "200" ]; then
                    echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸ (HTTP 200)"
                elif [ "\$HTTP_CODE" = "000" ]; then
                    echo "âš ï¸ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Nginx é…ç½®"
                else
                    echo "âš ï¸ HTTP çŠ¶æ€ç : \$HTTP_CODE"
                fi

                # éªŒè¯å…³é”®æ–‡ä»¶
                ssh -o StrictHostKeyChecking=no ${env.USER}@${env.HOST} '
                    cd ${nginxWebRoot}

                    echo ""
                    echo "éªŒè¯å…³é”®æ–‡ä»¶:"
                    [ -f index.html ] && echo "  âœ… index.html" || echo "  âŒ index.html"
                    [ -d static ] && echo "  âœ… static/" || echo "  â„¹ï¸ static/ (å¯èƒ½ä¸å­˜åœ¨)"
                    [ -d assets ] && echo "  âœ… assets/" || echo "  â„¹ï¸ assets/ (å¯èƒ½ä¸å­˜åœ¨)"
                    [ -d js ] && echo "  âœ… js/" || echo "  â„¹ï¸ js/ (å¯èƒ½ä¸å­˜åœ¨)"
                    [ -d css ] && echo "  âœ… css/" || echo "  â„¹ï¸ css/ (å¯èƒ½ä¸å­˜åœ¨)"
                '
            """
		}
	}
	echo "  [å‰ç«¯] âœ… å‘å¸ƒå®Œæˆ"
}
