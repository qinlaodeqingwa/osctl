pipeline {
	agent any

	environment {
		// é¡¹ç›®é…ç½®
		PROJECT_NAME = 'order-service'
		JAR_NAME = 'order-service.jar'
		BUILD_DIR = "${PROJECT_NAME}/target"

		// å½’æ¡£é…ç½®
		ARCHIVE_BASE_DIR = '/data/jenkins-archives'
		ARCHIVE_DIR = "${ARCHIVE_BASE_DIR}/${PROJECT_NAME}"

		// ç”Ÿäº§ç¯å¢ƒé…ç½®
		PROD_REMOTE_DIR = 'zcf-charge-operation-platform/order-service/'
		PROD_DEPLOY_DIR = '/data/zcf-charge-operation-platform/order-service'

		// æ„å»ºä¿¡æ¯
		BUILD_TIME = sh(script: "date '+%Y%m%d_%H%M%S'", returnStdout: true).trim()
		GIT_COMMIT_SHORT = sh(script: "git rev-parse --short HEAD 2>/dev/null || echo 'unknown'", returnStdout: true).trim()
		GIT_BRANCH = sh(script: "git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'unknown'", returnStdout: true).trim()
	}

	parameters {
		// éƒ¨ç½²ç­–ç•¥
		choice(
			name: 'DEPLOY_STRATEGY',
			choices: ['ç°åº¦å‘å¸ƒ', 'å…¨é‡å‘å¸ƒ', 'å•æœºå‘å¸ƒ', 'å›æ»š'],
			description: '''éƒ¨ç½²ç­–ç•¥è¯´æ˜ï¼š
â€¢ ç°åº¦å‘å¸ƒï¼šæŒ‰æ¯”ä¾‹åˆ†æ‰¹éƒ¨ç½²ï¼Œé€æ­¥æ”¾é‡ï¼ˆæ¨èç”Ÿäº§ä½¿ç”¨ï¼‰
â€¢ å…¨é‡å‘å¸ƒï¼šä¸€æ¬¡æ€§éƒ¨ç½²åˆ°æ‰€æœ‰æœåŠ¡å™¨
â€¢ å•æœºå‘å¸ƒï¼šé€å°éƒ¨ç½²ï¼Œæ¯å°éœ€è¦äººå·¥ç¡®è®¤
â€¢ å›æ»šï¼šå›æ»šåˆ°å†å²ç‰ˆæœ¬'''
		)

		// ç”Ÿäº§æœåŠ¡å™¨å¤šé€‰
		extendedChoice(
			name: 'TARGET_SERVERS',
			type: 'PT_CHECKBOX',
			description: '''é€‰æ‹©è¦éƒ¨ç½²çš„ç”Ÿäº§æœåŠ¡å™¨ï¼ˆå¯å¤šé€‰ï¼‰
å»ºè®®ï¼š
  - ç°åº¦å‘å¸ƒï¼šé€‰æ‹©æ‰€æœ‰æœåŠ¡å™¨
  - å•æœºå‘å¸ƒï¼šå…ˆé€‰1-2å°è§‚å¯Ÿ
  - å…¨é‡å‘å¸ƒï¼šé€‰æ‹©æ‰€æœ‰æœåŠ¡å™¨''',
			multiSelectDelimiter: ',',
			value: 'prod-server-01,prod-server-02,prod-server-03,prod-server-04',
			visibleItemCount: 5,
			defaultValue: 'prod-server-01'
		)

		// æ˜¯å¦ä½¿ç”¨å·²æœ‰åˆ¶å“
		booleanParam(
			name: 'USE_EXISTING_ARTIFACT',
			defaultValue: true,
			description: '''æ˜¯å¦ä½¿ç”¨å·²æœ‰åˆ¶å“ï¼Ÿ
â˜‘ å‹¾é€‰ï¼šä½¿ç”¨å·²å½’æ¡£çš„ JAR åŒ…ï¼ˆæ¨èç”Ÿäº§ä½¿ç”¨ï¼Œæ— éœ€é‡æ–°æ„å»ºï¼‰
â˜ ä¸å‹¾é€‰ï¼šé‡æ–°ä»ä»£ç æ„å»ºï¼ˆé€‚åˆæµ‹è¯•ç¯å¢ƒï¼‰

è¯´æ˜ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨å·²åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿‡çš„åˆ¶å“'''
		)

		// åˆ¶å“ç‰ˆæœ¬é€‰æ‹©ï¼ˆä½¿ç”¨å·²æœ‰åˆ¶å“æ—¶ï¼‰
		string(
			name: 'ARTIFACT_VERSION',
			defaultValue: 'latest',
			description: '''è¦éƒ¨ç½²çš„åˆ¶å“ç‰ˆæœ¬ï¼š
â€¢ latest - ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼ˆé»˜è®¤ï¼‰
â€¢ å…·ä½“ç‰ˆæœ¬å· - ä¾‹å¦‚ï¼šorder-service_20231219_120000_abc1234_#123.jar

æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬ï¼š
  ls -lh /data/jenkins-archives/order-service/*/'''
		)

		// ç°åº¦å‘å¸ƒæ¯”ä¾‹
		choice(
			name: 'GRAY_PERCENTAGE',
			choices: ['25%', '50%', '75%', '10%', '100%'],
			description: '''ç°åº¦å‘å¸ƒæ¯”ä¾‹ï¼ˆä»…ç°åº¦å‘å¸ƒæ—¶ç”Ÿæ•ˆï¼‰ï¼š

ç¤ºä¾‹ï¼ˆ4å°æœåŠ¡å™¨ï¼‰ï¼š
â€¢ 10% = ç¬¬1æ‰¹: 1å° â†’ ç¬¬2æ‰¹: 3å°
â€¢ 25% = ç¬¬1æ‰¹: 1å° â†’ ç¬¬2æ‰¹: 3å°
â€¢ 50% = ç¬¬1æ‰¹: 2å° â†’ ç¬¬2æ‰¹: 2å°
â€¢ 75% = ç¬¬1æ‰¹: 3å° â†’ ç¬¬2æ‰¹: 1å°
â€¢ 100% = ç¬¬1æ‰¹: 4å°ï¼ˆç­‰åŒå…¨é‡å‘å¸ƒï¼‰

å»ºè®®ï¼šé¦–æ¬¡å‘å¸ƒç”¨ 25%ï¼Œç¨³å®šåå¯ç”¨ 50%'''
		)

		// ç°åº¦æ‰¹æ¬¡é—´éš”
		choice(
			name: 'GRAY_INTERVAL',
			choices: ['5', '10', '15', '30', '60'],
			description: '''ç°åº¦æ‰¹æ¬¡é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ï¼š

â€¢ 5åˆ†é’Ÿ - å¿«é€Ÿå‘å¸ƒï¼ˆé€‚åˆå°æµé‡å˜æ›´ï¼‰
â€¢ 10åˆ†é’Ÿ - æ ‡å‡†å‘å¸ƒï¼ˆæ¨èï¼‰
â€¢ 15-30åˆ†é’Ÿ - è°¨æ…å‘å¸ƒï¼ˆé‡å¤§å˜æ›´ï¼‰
â€¢ 60åˆ†é’Ÿ - è¶…è°¨æ…å‘å¸ƒï¼ˆæ ¸å¿ƒåŠŸèƒ½å˜æ›´ï¼‰

è¯´æ˜ï¼šé—´éš”æœŸé—´ä¼šç›‘æ§æœåŠ¡çŠ¶æ€'''
		)

		// å¥åº·æ£€æŸ¥è¶…æ—¶
		string(
			name: 'HEALTH_CHECK_TIMEOUT',
			defaultValue: '120',
			description: 'å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®® 120 ç§’'
		)

		// æ˜¯å¦éœ€è¦äººå·¥ç¡®è®¤
		booleanParam(
			name: 'NEED_APPROVAL',
			defaultValue: true,
			description: '''ç°åº¦å‘å¸ƒæ—¶æ˜¯å¦éœ€è¦äººå·¥ç¡®è®¤ä¸‹ä¸€æ‰¹æ¬¡ï¼Ÿ
â˜‘ å‹¾é€‰ï¼šæ¯æ‰¹æ¬¡éƒ¨ç½²åéœ€è¦äººå·¥ç¡®è®¤ï¼ˆæ¨èç”Ÿäº§ä½¿ç”¨ï¼‰
â˜ ä¸å‹¾é€‰ï¼šè‡ªåŠ¨ç»§ç»­ä¸‹ä¸€æ‰¹æ¬¡ï¼ˆé€‚åˆæµ‹è¯•ç¯å¢ƒï¼‰'''
		)

		// æ„å»ºé€‰é¡¹ï¼ˆä»…åœ¨ä¸ä½¿ç”¨å·²æœ‰åˆ¶å“æ—¶ç”Ÿæ•ˆï¼‰
		booleanParam(
			name: 'SKIP_TESTS',
			defaultValue: false,
			description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•ï¼ˆä»…åœ¨é‡æ–°æ„å»ºæ—¶ç”Ÿæ•ˆï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®è·³è¿‡ï¼‰'
		)

		// å›æ»šç‰ˆæœ¬
		string(
			name: 'ROLLBACK_VERSION',
			defaultValue: '',
			description: '''å›æ»šç‰ˆæœ¬ï¼ˆä»…å›æ»šæ¨¡å¼éœ€è¦ï¼‰
æ ¼å¼ï¼šorder-service_20231219_120000_abc1234_#123.jar

æŸ¥çœ‹å†å²ç‰ˆæœ¬ï¼š
  ls -lh /data/jenkins-archives/order-service/*/
  cat /data/jenkins-archives/order-service/*/*.info'''
		)

		// å‘å¸ƒåŸå› ï¼ˆå¿…å¡«ï¼‰
		text(
			name: 'RELEASE_NOTES',
			defaultValue: '',
			description: '''å‘å¸ƒè¯´æ˜ï¼ˆå¿…å¡«ï¼‰ï¼š
è¯·æè¿°æœ¬æ¬¡å‘å¸ƒçš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š
â€¢ ä¿®å¤äº†ä»€ä¹ˆ Bug
â€¢ æ–°å¢äº†ä»€ä¹ˆåŠŸèƒ½
â€¢ ä¼˜åŒ–äº†ä»€ä¹ˆæ€§èƒ½
â€¢ å…¶ä»–é‡è¦å˜æ›´

æ­¤ä¿¡æ¯å°†è®°å½•åˆ°å‘å¸ƒæ—¥å¿—ä¸­'''
		)
	}

	options {
		buildDiscarder(logRotator(
			numToKeepStr: '20',           // ä¿ç•™æ›´å¤šæ„å»ºè®°å½•
			daysToKeepStr: '90',          // ä¿ç•™ 90 å¤©
			artifactDaysToKeepStr: '30',  // åˆ¶å“ä¿ç•™ 30 å¤©ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
			artifactNumToKeepStr: '10'    // ä¿ç•™æœ€è¿‘ 10 ä¸ªåˆ¶å“
		))
		timestamps()
		disableConcurrentBuilds()
		timeout(time: 120, unit: 'MINUTES')  // ç”Ÿäº§ç¯å¢ƒè¶…æ—¶æ—¶é—´æ›´é•¿
	}

	stages {
		stage('ğŸ” å‚æ•°éªŒè¯ä¸é£é™©æç¤º') {
			steps {
				script {
					echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  âš ï¸  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ é¡¹ç›®åç§°: ${PROJECT_NAME}
â•‘ éƒ¨ç½²ç­–ç•¥: ${params.DEPLOY_STRATEGY}
â•‘ ç›®æ ‡æœåŠ¡å™¨: ${params.TARGET_SERVERS}
â•‘ ç°åº¦æ¯”ä¾‹: ${params.GRAY_PERCENTAGE}
â•‘ æ‰¹æ¬¡é—´éš”: ${params.GRAY_INTERVAL} åˆ†é’Ÿ
â•‘ äººå·¥ç¡®è®¤: ${params.NEED_APPROVAL ? 'æ˜¯' : 'å¦'}
â•‘ ä½¿ç”¨å·²æœ‰åˆ¶å“: ${params.USE_EXISTING_ARTIFACT ? 'æ˜¯' : 'å¦'}
â•‘ åˆ¶å“ç‰ˆæœ¬: ${params.ARTIFACT_VERSION}
â•‘ æ„å»ºæ—¶é—´: ${BUILD_TIME}
â•‘ Git åˆ†æ”¯: ${GIT_BRANCH}
â•‘ Git Commit: ${GIT_COMMIT_SHORT}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ å‘å¸ƒè¯´æ˜:
â•‘ ${params.RELEASE_NOTES ?: 'ï¼ˆæœªå¡«å†™ï¼‰'}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

					// éªŒè¯å‘å¸ƒè¯´æ˜
					if (!params.RELEASE_NOTES || params.RELEASE_NOTES.trim() == '') {
						error("âŒ é”™è¯¯: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¿…é¡»å¡«å†™å‘å¸ƒè¯´æ˜!")
					}

					// éªŒè¯æœåŠ¡å™¨é€‰æ‹©
					if (!params.TARGET_SERVERS || params.TARGET_SERVERS.trim() == '') {
						error("âŒ é”™è¯¯: å¿…é¡»é€‰æ‹©è‡³å°‘ä¸€å°æœåŠ¡å™¨!")
					}

					// è§£æé€‰ä¸­çš„æœåŠ¡å™¨
					def selectedServers = params.TARGET_SERVERS.split(',').collect { it.trim() }
					env.SELECTED_SERVERS = selectedServers.join(',')
					env.SERVER_COUNT = selectedServers.size().toString()

					echo """
âœ… å·²é€‰æ‹© ${env.SERVER_COUNT} å°æœåŠ¡å™¨: ${env.SELECTED_SERVERS}

éƒ¨ç½²æµç¨‹è¯´æ˜:
"""

					// æ ¹æ®ç­–ç•¥æ˜¾ç¤ºä¸åŒçš„æµç¨‹è¯´æ˜
					switch(params.DEPLOY_STRATEGY) {
					case 'ç°åº¦å‘å¸ƒ':
					def firstBatchSize = Math.max(1, (selectedServers.size() * (params.GRAY_PERCENTAGE.replace('%', '').toInteger() / 100.0)).toInteger())
					def secondBatchSize = selectedServers.size() - firstBatchSize
					echo """
ã€ç°åº¦å‘å¸ƒæµç¨‹ã€‘
1ï¸âƒ£  ç¬¬ä¸€æ‰¹æ¬¡: éƒ¨ç½² ${firstBatchSize} å°æœåŠ¡å™¨ (${params.GRAY_PERCENTAGE})
   â†“ å¥åº·æ£€æŸ¥
   â†“ ${params.NEED_APPROVAL ? 'ç­‰å¾…äººå·¥ç¡®è®¤' : 'è‡ªåŠ¨ç»§ç»­'}
   â†“ ç­‰å¾… ${params.GRAY_INTERVAL} åˆ†é’Ÿè§‚å¯Ÿ
2ï¸âƒ£  ç¬¬äºŒæ‰¹æ¬¡: éƒ¨ç½²å‰©ä½™ ${secondBatchSize} å°æœåŠ¡å™¨
   â†“ å¥åº·æ£€æŸ¥
3ï¸âƒ£  æœ€ç»ˆéªŒè¯
   â†“ å…¨é‡å¥åº·æ£€æŸ¥
âœ… éƒ¨ç½²å®Œæˆ

ä¼˜åŠ¿: é£é™©å¯æ§ï¼Œå‡ºé—®é¢˜å½±å“é¢å°
"""
					break

					case 'å…¨é‡å‘å¸ƒ':
					echo """
ã€å…¨é‡å‘å¸ƒæµç¨‹ã€‘
1ï¸âƒ£  åŒæ—¶éƒ¨ç½²æ‰€æœ‰ ${selectedServers.size()} å°æœåŠ¡å™¨
   â†“ å¥åº·æ£€æŸ¥
2ï¸âƒ£  æœ€ç»ˆéªŒè¯
âœ… éƒ¨ç½²å®Œæˆ

é£é™©: å¦‚æœæœ‰é—®é¢˜ï¼Œæ‰€æœ‰æœåŠ¡å™¨åŒæ—¶å—å½±å“
"""
					break

					case 'å•æœºå‘å¸ƒ':
					echo """
ã€å•æœºå‘å¸ƒæµç¨‹ã€‘
${selectedServers.collect { "1ï¸âƒ£  éƒ¨ç½² ${it}\n   â†“ å¥åº·æ£€æŸ¥\n   â†“ äººå·¥ç¡®è®¤" }.join('\n')}
âœ… éƒ¨ç½²å®Œæˆ

ä¼˜åŠ¿: æœ€å®‰å…¨ï¼Œæ¯å°éƒ½éœ€è¦äººå·¥ç¡®è®¤
åŠ£åŠ¿: è€—æ—¶è¾ƒé•¿
"""
					break

					case 'å›æ»š':
					if (!params.ROLLBACK_VERSION || params.ROLLBACK_VERSION.trim() == '') {
						error("âŒ é”™è¯¯: å›æ»šæ¨¡å¼å¿…é¡»æŒ‡å®šå›æ»šç‰ˆæœ¬!")
					}
					echo """
ã€å›æ»šæµç¨‹ã€‘
ğŸ”„ å›æ»šåˆ°ç‰ˆæœ¬: ${params.ROLLBACK_VERSION}
1ï¸âƒ£  åŒæ—¶å›æ»šæ‰€æœ‰ ${selectedServers.size()} å°æœåŠ¡å™¨
   â†“ å¥åº·æ£€æŸ¥
2ï¸âƒ£  æœ€ç»ˆéªŒè¯
âœ… å›æ»šå®Œæˆ
"""
					break
					}
				}
			}
		}

		stage('ğŸ“¦ å‡†å¤‡éƒ¨ç½²åˆ¶å“') {
			steps {
				script {
					if (params.DEPLOY_STRATEGY == 'å›æ»š') {
						// å›æ»šæ¨¡å¼ï¼šä½¿ç”¨æŒ‡å®šç‰ˆæœ¬
						env.DEPLOY_JAR_NAME = params.ROLLBACK_VERSION
						env.DEPLOY_JAR_PATH = sh(
							script: "find ${ARCHIVE_DIR} -name '${params.ROLLBACK_VERSION}' -type f | head -1",
							returnStdout: true
						).trim()

						if (!env.DEPLOY_JAR_PATH || env.DEPLOY_JAR_PATH == '') {
							error("âŒ é”™è¯¯: æ‰¾ä¸åˆ°å›æ»šç‰ˆæœ¬ ${params.ROLLBACK_VERSION}")
						}

						echo """
ğŸ”„ å›æ»šæ¨¡å¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç‰ˆæœ¬: ${env.DEPLOY_JAR_NAME}
è·¯å¾„: ${env.DEPLOY_JAR_PATH}
"""

						// æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
						sh """
                            if [ -f ${env.DEPLOY_JAR_PATH}.info ]; then
                                echo "ç‰ˆæœ¬ä¿¡æ¯:"
                                cat ${env.DEPLOY_JAR_PATH}.info
                            fi
                        """

					} else if (params.USE_EXISTING_ARTIFACT) {
						// ä½¿ç”¨å·²æœ‰åˆ¶å“
						if (params.ARTIFACT_VERSION == 'latest') {
							// ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
							env.DEPLOY_JAR_PATH = "${ARCHIVE_DIR}/${PROJECT_NAME}_latest.jar"

							if (!fileExists(env.DEPLOY_JAR_PATH)) {
								error("âŒ é”™è¯¯: æ‰¾ä¸åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæ„å»º")
							}

							env.DEPLOY_JAR_NAME = sh(
								script: "basename \$(readlink -f ${env.DEPLOY_JAR_PATH})",
								returnStdout: true
							).trim()

							echo """
ğŸ“¦ ä½¿ç”¨æœ€æ–°åˆ¶å“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç‰ˆæœ¬: ${env.DEPLOY_JAR_NAME}
è·¯å¾„: ${env.DEPLOY_JAR_PATH}
"""

						} else {
							// ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬
							env.DEPLOY_JAR_NAME = params.ARTIFACT_VERSION
							env.DEPLOY_JAR_PATH = sh(
								script: "find ${ARCHIVE_DIR} -name '${params.ARTIFACT_VERSION}' -type f | head -1",
								returnStdout: true
							).trim()

							if (!env.DEPLOY_JAR_PATH || env.DEPLOY_JAR_PATH == '') {
								error("âŒ é”™è¯¯: æ‰¾ä¸åˆ°æŒ‡å®šç‰ˆæœ¬ ${params.ARTIFACT_VERSION}")
							}

							echo """
ğŸ“¦ ä½¿ç”¨æŒ‡å®šåˆ¶å“
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç‰ˆæœ¬: ${env.DEPLOY_JAR_NAME}
è·¯å¾„: ${env.DEPLOY_JAR_PATH}
"""
						}

						// æ˜¾ç¤ºåˆ¶å“ä¿¡æ¯
						sh """
                            echo "åˆ¶å“è¯¦æƒ…:"
                            ls -lh ${env.DEPLOY_JAR_PATH}
                            md5sum ${env.DEPLOY_JAR_PATH}

                            if [ -f ${env.DEPLOY_JAR_PATH}.info ]; then
                                echo ""
                                echo "æ„å»ºä¿¡æ¯:"
                                cat ${env.DEPLOY_JAR_PATH}.info
                            fi
                        """

					} else {
						// é‡æ–°æ„å»ºï¼ˆç”Ÿäº§ç¯å¢ƒä¸æ¨èï¼‰
						echo """
âš ï¸  è­¦å‘Š: æ­£åœ¨é‡æ–°æ„å»ºä»£ç 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨å·²éªŒè¯çš„åˆ¶å“ï¼
"""

						// è¿™é‡Œå¯ä»¥æ·»åŠ æ„å»ºé€»è¾‘ï¼Œå‚è€ƒä¹‹å‰çš„ä»£ç 
						error("âŒ ç”Ÿäº§ç¯å¢ƒä¸å…è®¸é‡æ–°æ„å»ºï¼Œè¯·ä½¿ç”¨å·²æœ‰åˆ¶å“æˆ–å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæ„å»º")
					}

					// äººå·¥ç¡®è®¤
					timeout(time: 10, unit: 'MINUTES') {
						input message: """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âš ï¸  ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¡®è®¤                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ éƒ¨ç½²ç­–ç•¥: ${params.DEPLOY_STRATEGY}
â•‘ ç›®æ ‡æœåŠ¡å™¨: ${env.SELECTED_SERVERS}
â•‘ æœåŠ¡å™¨æ•°é‡: ${env.SERVER_COUNT} å°
â•‘ éƒ¨ç½²ç‰ˆæœ¬: ${env.DEPLOY_JAR_NAME}
â•‘
â•‘ å‘å¸ƒè¯´æ˜:
â•‘ ${params.RELEASE_NOTES}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ è¯·ç¡®è®¤ä»¥ä¸Šä¿¡æ¯æ— è¯¯åç»§ç»­éƒ¨ç½²
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""",
						ok: 'âœ… ç¡®è®¤éƒ¨ç½²',
						submitter: 'admin,release-manager'
					}
				}
			}
		}
	}

	stage('ğŸ“‹ åˆ¶å®šéƒ¨ç½²è®¡åˆ’') {
		steps {
			script {
				// è§£ææœåŠ¡å™¨åˆ—è¡¨
				def allServers = env.SELECTED_SERVERS.split(',').collect { it.trim() }

				// æ ¹æ®éƒ¨ç½²ç­–ç•¥åˆ†ç»„æœåŠ¡å™¨
				def serverGroups = []

				switch(params.DEPLOY_STRATEGY) {
				case 'å…¨é‡å‘å¸ƒ':
				serverGroups = [allServers]
				break

				case 'å•æœºå‘å¸ƒ':
				serverGroups = allServers.collect { [it] }
				break

				case 'ç°åº¦å‘å¸ƒ':
				serverGroups = calculateGrayGroups(allServers, params.GRAY_PERCENTAGE)
				break

				case 'å›æ»š':
				serverGroups = [allServers]
				break
				}

				env.SERVER_GROUPS = groovy.json.JsonOutput.toJson(serverGroups)

				echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                      éƒ¨ç½²è®¡åˆ’                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ç­–ç•¥: ${params.DEPLOY_STRATEGY}
â•‘ æ€»æœåŠ¡å™¨æ•°: ${allServers.size()}
â•‘ åˆ†æ‰¹æ¬¡æ•°: ${serverGroups.size()}
â•‘ éƒ¨ç½²æ–‡ä»¶: ${env.DEPLOY_JAR_NAME}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
"""
				serverGroups.eachWithIndex { group, index ->
					echo "â•‘ æ‰¹æ¬¡ ${index + 1}: ${group.join(', ')}"
				}
				echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
			}
		}
	}

	stage('ğŸš€ æ‰§è¡Œéƒ¨ç½²') {
		steps {
			script {
				def serverGroups = new groovy.json.JsonSlurper().parseText(env.SERVER_GROUPS)
				def totalGroups = serverGroups.size()

				serverGroups.eachWithIndex { group, batchIndex ->
					def batchNum = batchIndex + 1

					echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              å¼€å§‹éƒ¨ç½²æ‰¹æ¬¡ ${batchNum}/${totalGroups}                        â•‘
â•‘              æœåŠ¡å™¨: ${group.join(', ')}                    â•‘
â•‘              æ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

					// å¹¶è¡Œéƒ¨ç½²å½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰æœåŠ¡å™¨
					def deployTasks = [:]

					group.each { serverName ->
						deployTasks[serverName] = {
							deployToServer(
								serverName,
								env.DEPLOY_JAR_PATH,
								env.DEPLOY_JAR_NAME,
								params.HEALTH_CHECK_TIMEOUT
							)
						}
					}

					// æ‰§è¡Œå¹¶è¡Œéƒ¨ç½²
					parallel deployTasks

					echo "âœ… æ‰¹æ¬¡ ${batchNum}/${totalGroups} éƒ¨ç½²å®Œæˆ"

					// æ‰¹æ¬¡é—´å¤„ç†
					if (batchNum < totalGroups) {
						echo """
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ‰¹æ¬¡ ${batchNum} éƒ¨ç½²å®Œæˆï¼Œå¼€å§‹è§‚å¯ŸæœŸ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""

						echo "â³ ç­‰å¾… 30 ç§’è®©æœåŠ¡ç¨³å®š..."
						sleep(time: 30, unit: 'SECONDS')

						// æ£€æŸ¥å½“å‰æ‰¹æ¬¡æœåŠ¡å¥åº·çŠ¶æ€
						echo "ğŸ” æ£€æŸ¥æ‰¹æ¬¡ ${batchNum} æœåŠ¡å¥åº·çŠ¶æ€..."
						def allHealthy = true
						def healthStatus = [:]

						group.each { serverName ->
							def healthy = checkServerHealth(serverName)
							healthStatus[serverName] = healthy
							if (!healthy) {
								allHealthy = false
							}
						}

						// æ˜¾ç¤ºå¥åº·æ£€æŸ¥ç»“æœ
						echo """
å¥åº·æ£€æŸ¥ç»“æœ:
${healthStatus.collect { server, healthy ->
						"  ${healthy ? 'âœ…' : 'âŒ'} ${server}: ${healthy ? 'æ­£å¸¸' : 'å¼‚å¸¸'}"
						}.join('\n')}
"""

						if (!allHealthy) {
							error("""
âŒ æ‰¹æ¬¡ ${batchNum} å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œåœæ­¢åç»­éƒ¨ç½²ï¼

å¤±è´¥æœåŠ¡å™¨: ${healthStatus.findAll { !it.value }.collect { it.key }.join(', ')}

å»ºè®®æ“ä½œ:
1. æ£€æŸ¥å¤±è´¥æœåŠ¡å™¨çš„æ—¥å¿—
2. ç¡®è®¤é—®é¢˜åŸå› 
3. å¦‚éœ€å›æ»šï¼Œé€‰æ‹©"å›æ»š"ç­–ç•¥é‡æ–°éƒ¨ç½²
""")
						}

						echo "âœ… æ‰¹æ¬¡ ${batchNum} å¥åº·æ£€æŸ¥é€šè¿‡"

						// äººå·¥ç¡®è®¤
						if (params.NEED_APPROVAL && batchNum < totalGroups) {
							timeout(time: 30, unit: 'MINUTES') {
								input message: """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              æ‰¹æ¬¡ ${batchNum}/${totalGroups} éƒ¨ç½²å®Œæˆ                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ å·²éƒ¨ç½²æœåŠ¡å™¨: ${group.join(', ')}
â•‘ å¥åº·çŠ¶æ€: âœ… å…¨éƒ¨æ­£å¸¸
â•‘
â•‘ ä¸‹ä¸€æ‰¹æ¬¡æœåŠ¡å™¨: ${serverGroups[batchNum].join(', ')}
â•‘
â•‘ è¯·ç¡®è®¤:
â•‘ 1. æ£€æŸ¥ç›‘æ§æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€QPSç­‰ï¼‰
â•‘ 2. æ£€æŸ¥ä¸šåŠ¡æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸
â•‘ 3. æ£€æŸ¥ç”¨æˆ·åé¦ˆæ˜¯å¦æ­£å¸¸
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ç¡®è®¤æ— è¯¯åï¼Œç‚¹å‡»"ç»§ç»­éƒ¨ç½²"æŒ‰é’®
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
""",
								ok: 'âœ… ç»§ç»­éƒ¨ç½²',
								submitter: 'admin,release-manager'
							}
						}

						// æ‰¹æ¬¡é—´éš”
						if (params.GRAY_INTERVAL.toInteger() > 0) {
							echo """
â³ è§‚å¯ŸæœŸ: ç­‰å¾… ${params.GRAY_INTERVAL} åˆ†é’Ÿåç»§ç»­...

å»ºè®®åœ¨æ­¤æœŸé—´:
â€¢ ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ
â€¢ æŸ¥çœ‹åº”ç”¨æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸
â€¢ æ£€æŸ¥ä¸šåŠ¡æŒ‡æ ‡æ˜¯å¦æ­£å¸¸
â€¢ å…³æ³¨ç”¨æˆ·åé¦ˆ
"""
							sleep(time: params.GRAY_INTERVAL.toInteger(), unit: 'MINUTES')
						}
					}
				}

				echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âœ… æ‰€æœ‰æ‰¹æ¬¡éƒ¨ç½²å®Œæˆ!                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
			}
		}
	}

	stage('ğŸ” æœ€ç»ˆéªŒè¯') {
		steps {
			script {
				echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  æœ€ç»ˆå¥åº·æ£€æŸ¥                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

				def allServers = env.SELECTED_SERVERS.split(',').collect { it.trim() }
				def healthStatus = [:]

				allServers.each { serverName ->
					healthStatus[serverName] = checkServerHealth(serverName)
				}

				echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  å¥åº·æ£€æŸ¥ç»“æœ                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
"""
				healthStatus.each { server, healthy ->
					def status = healthy ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'
					echo "â•‘ ${server.padRight(30)} ${status}"
				}
				echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

				def failedServers = healthStatus.findAll { !it.value }.collect { it.key }

				if (failedServers.size() > 0) {
					currentBuild.result = 'UNSTABLE'
					echo """
âš ï¸  è­¦å‘Š: ä»¥ä¸‹æœåŠ¡å™¨å¥åº·æ£€æŸ¥å¤±è´¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${failedServers.join('\n')}

å»ºè®®æ“ä½œ:
1. ç™»å½•æœåŠ¡å™¨æ£€æŸ¥æ—¥å¿—
2. ç¡®è®¤æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨
3. å¦‚æœ‰é—®é¢˜ï¼Œç«‹å³å›æ»š
"""
				} else {
					echo """
âœ… æ‰€æœ‰æœåŠ¡å™¨å¥åº·æ£€æŸ¥é€šè¿‡

éƒ¨ç½²æˆåŠŸ! ğŸ‰
"""
				}
			}
		}
	}

	stage('ğŸ“ è®°å½•å‘å¸ƒæ—¥å¿—') {
		steps {
			script {
				def releaseLog = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  ç”Ÿäº§å‘å¸ƒè®°å½•                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ å‘å¸ƒæ—¶é—´: ${BUILD_TIME}
â•‘ å‘å¸ƒäºº: ${env.BUILD_USER ?: 'Jenkins'}
â•‘ æ„å»ºç¼–å·: #${BUILD_NUMBER}
â•‘
â•‘ éƒ¨ç½²ç­–ç•¥: ${params.DEPLOY_STRATEGY}
â•‘ ç°åº¦æ¯”ä¾‹: ${params.GRAY_PERCENTAGE}
â•‘ æ‰¹æ¬¡é—´éš”: ${params.GRAY_INTERVAL} åˆ†é’Ÿ
â•‘
â•‘ ç›®æ ‡æœåŠ¡å™¨: ${env.SELECTED_SERVERS}
â•‘ æœåŠ¡å™¨æ•°é‡: ${env.SERVER_COUNT} å°
â•‘
â•‘ éƒ¨ç½²ç‰ˆæœ¬: ${env.DEPLOY_JAR_NAME}
â•‘ Git åˆ†æ”¯: ${GIT_BRANCH}
â•‘ Git Commit: ${GIT_COMMIT_SHORT}
â•‘
â•‘ å‘å¸ƒè¯´æ˜:
â•‘ ${params.RELEASE_NOTES}
â•‘
â•‘ æ„å»ºæ—¥å¿—: ${BUILD_URL}console
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

				echo releaseLog

				// ä¿å­˜å‘å¸ƒæ—¥å¿—
				sh """
                        mkdir -p /data/jenkins-release-logs
                        cat > /data/jenkins-release-logs/release_${BUILD_TIME}.log <<'EOF'
${releaseLog}
EOF

                        echo "âœ… å‘å¸ƒæ—¥å¿—å·²ä¿å­˜: /data/jenkins-release-logs/release_${BUILD_TIME}.log"
                    """
			}
		}
	}
}

post {
	success {
		script {
			def deployInfo = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âœ… ç”Ÿäº§éƒ¨ç½²æˆåŠŸ!                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ é¡¹ç›®: ${PROJECT_NAME}
â•‘ ç­–ç•¥: ${params.DEPLOY_STRATEGY}
â•‘ ç‰ˆæœ¬: ${env.DEPLOY_JAR_NAME}
â•‘ æœåŠ¡å™¨æ•°: ${env.SERVER_COUNT} å°
â•‘ å®Œæˆæ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ éƒ¨ç½²æœåŠ¡å™¨åˆ—è¡¨:
${env.SELECTED_SERVERS.split(',').collect { "â•‘   âœ“ ${it}" }.join('\n')}
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ å‘å¸ƒè¯´æ˜:
â•‘ ${params.RELEASE_NOTES}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

åç»­å»ºè®®:
â€¢ æŒç»­ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ
â€¢ å…³æ³¨åº”ç”¨æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸
â€¢ æ£€æŸ¥ä¸šåŠ¡æŒ‡æ ‡æ˜¯å¦æ­£å¸¸
â€¢ æ”¶é›†ç”¨æˆ·åé¦ˆ
"""
			echo deployInfo

			// å¯é€‰: å‘é€é’‰é’‰/é‚®ä»¶é€šçŸ¥
			// dingTalk(
			//     robot: 'your-robot-id',
			//     type: 'MARKDOWN',
			//     title: 'âœ… ç”Ÿäº§éƒ¨ç½²æˆåŠŸ',
			//     text: [deployInfo]
			// )
		}
	}

	failure {
		script {
			echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âŒ ç”Ÿäº§éƒ¨ç½²å¤±è´¥!                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ é¡¹ç›®: ${PROJECT_NAME}
â•‘ ç­–ç•¥: ${params.DEPLOY_STRATEGY}
â•‘ å¤±è´¥æ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}
â•‘ æ—¥å¿—: ${BUILD_URL}console
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ç´§æ€¥å¤„ç†:
â•‘ 1. æŸ¥çœ‹æ„å»ºæ—¥å¿—ç¡®è®¤å¤±è´¥åŸå› 
â•‘ 2. å¦‚å·²éƒ¨åˆ†éƒ¨ç½²ï¼Œè¯„ä¼°æ˜¯å¦éœ€è¦å›æ»š
â•‘ 3. é€šçŸ¥ç›¸å…³äººå‘˜
â•‘ 4. ä¿®å¤é—®é¢˜åé‡æ–°éƒ¨ç½²
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

			// å¯é€‰: å‘é€å‘Šè­¦é€šçŸ¥
		}
	}

	unstable {
		script {
			echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              âš ï¸  éƒ¨ç½²å®Œæˆä½†å­˜åœ¨å¼‚å¸¸                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ éƒ¨åˆ†æœåŠ¡å™¨å¥åº·æ£€æŸ¥æœªé€šè¿‡
â•‘ è¯·ç«‹å³æ£€æŸ¥å¹¶å¤„ç†
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
		}
	}
}


// ========== è¾…åŠ©å‡½æ•° ==========

// è®¡ç®—ç°åº¦åˆ†ç»„
def calculateGrayGroups(servers, percentage) {
	def totalServers = servers.size()
	def groups = []

	// è®¡ç®—ç¬¬ä¸€æ‰¹æ¬¡æ•°é‡
	def firstBatchSize = Math.max(1, (totalServers * (percentage.replace('%', '').toInteger() / 100.0)).toInteger())

	// ç¬¬ä¸€æ‰¹æ¬¡
	groups.add(servers.take(firstBatchSize))

	// ç¬¬äºŒæ‰¹æ¬¡ï¼ˆå‰©ä½™çš„ï¼‰
	if (servers.size() > firstBatchSize) {
		groups.add(servers.drop(firstBatchSize))
	}

	return groups.findAll { it.size() > 0 }
}

// éƒ¨ç½²åˆ°å•å°æœåŠ¡å™¨
def deployToServer(serverName, jarPath, jarName, healthCheckTimeout) {
	echo ">>> å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨: ${serverName}"

	try {
		// åœæ­¢æœåŠ¡
		sshPublisher(
			continueOnError: false,
			failOnError: true,
			publishers: [
				sshPublisherDesc(
					configName: serverName,  // ç›´æ¥ä½¿ç”¨æœåŠ¡å™¨åç§°ä½œä¸º SSH é…ç½®å
					transfers: [
						sshTransfer(
							execCommand: """#!/bin/bash
set -e

APP_NAME="${env.JAR_NAME}"
echo "[${serverName}] åœæ­¢æœåŠ¡: \${APP_NAME}"

PIDS=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk '{print \$2}')

if [ -n "\$PIDS" ]; then
    echo "[${serverName}] å‘ç°è¿›ç¨‹: \$PIDSï¼Œå¼€å§‹åœæ­¢..."

    # ä¼˜é›…åœæ­¢
    for pid in \$PIDS; do
        kill -15 \$pid 2>/dev/null || true
    done

    # ç­‰å¾…è¿›ç¨‹é€€å‡º
    for i in {1..15}; do
        sleep 2
        REMAINING=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk '{print \$2}')
        if [ -z "\$REMAINING" ]; then
            echo "[${serverName}] âœ… æœåŠ¡å·²ä¼˜é›…åœæ­¢"
            exit 0
        fi
        echo "[${serverName}] ç­‰å¾…è¿›ç¨‹é€€å‡º... \${i}/15"
    done

    # å¼ºåˆ¶ç»ˆæ­¢
    echo "[${serverName}] âš ï¸  ä¼˜é›…åœæ­¢è¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹..."
    for pid in \$PIDS; do
        kill -9 \$pid 2>/dev/null || true
    done
    sleep 2

    # æœ€ç»ˆç¡®è®¤
    FINAL_CHECK=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk '{print \$2}')
    if [ -n "\$FINAL_CHECK" ]; then
        echo "[${serverName}] âŒ æ— æ³•åœæ­¢è¿›ç¨‹: \$FINAL_CHECK"
        exit 1
    fi
fi

echo "[${serverName}] âœ… æœåŠ¡åœæ­¢å®Œæˆ"
"""
						)
					]
				)
			]
		)

		// ä¼ è¾“æ–‡ä»¶å¹¶å¯åŠ¨
		sshPublisher(
			continueOnError: false,
			failOnError: true,
			publishers: [
				sshPublisherDesc(
					configName: serverName,
					transfers: [
						sshTransfer(
							sourceFiles: jarPath,
							removePrefix: new File(jarPath).parent,
							remoteDirectory: env.PROD_REMOTE_DIR,
							execCommand: """#!/bin/bash
set -e

cd ${env.PROD_DEPLOY_DIR}

echo "[${serverName}] å½“å‰ç›®å½•: \$(pwd)"

# å¤‡ä»½æ—§ç‰ˆæœ¬
if [ -f ${env.JAR_NAME} ]; then
    BACKUP_NAME="${env.JAR_NAME}.backup.\$(date +%Y%m%d_%H%M%S)"
    echo "[${serverName}] å¤‡ä»½æ—§ç‰ˆæœ¬: \$BACKUP_NAME"
    cp ${env.JAR_NAME} \$BACKUP_NAME

    # åªä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½
    ls -t ${env.JAR_NAME}.backup.* 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true

    echo "[${serverName}] å¤‡ä»½å®Œæˆï¼Œä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½"
    ls -lh ${env.JAR_NAME}.backup.* 2>/dev/null || echo "æ— å†å²å¤‡ä»½"
fi

# éƒ¨ç½²æ–°ç‰ˆæœ¬
NEW_JAR_FILE="\$(basename ${jarPath})"
echo "[${serverName}] æŸ¥æ‰¾æ–°æ–‡ä»¶: \$NEW_JAR_FILE"

if [ -f "\$NEW_JAR_FILE" ]; then
    echo "[${serverName}] éƒ¨ç½²æ–°ç‰ˆæœ¬: \$NEW_JAR_FILE -> ${env.JAR_NAME}"
    mv "\$NEW_JAR_FILE" ${env.JAR_NAME}
elif [ -f ${env.JAR_NAME} ]; then
    echo "[${serverName}] âš ï¸  æ–°æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œä½†ç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œç»§ç»­å¯åŠ¨"
else
    echo "[${serverName}] âŒ é”™è¯¯: æ‰¾ä¸åˆ° JAR æ–‡ä»¶"
    ls -la
    exit 1
fi

# éªŒè¯æ–‡ä»¶
echo "[${serverName}] éªŒè¯éƒ¨ç½²æ–‡ä»¶:"
ls -lh ${env.JAR_NAME}
md5sum ${env.JAR_NAME}

# å¯åŠ¨æœåŠ¡
echo "[${serverName}] å¯åŠ¨æœåŠ¡..."
if [ -f ./start.sh ]; then
    chmod +x ./start.sh
    ./start.sh
    echo "[${serverName}] âœ… å¯åŠ¨è„šæœ¬æ‰§è¡Œå®Œæˆ"
else
    echo "[${serverName}] âŒ é”™è¯¯: start.sh ä¸å­˜åœ¨"
    exit 1
fi

echo "[${serverName}] âœ… éƒ¨ç½²å®Œæˆ"
"""
						)
					]
				)
			]
		)

		// å¥åº·æ£€æŸ¥
		echo "[${serverName}] â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ15ç§’ï¼‰..."
		sleep(time: 15, unit: 'SECONDS')

		def maxRetries = 6  // æœ€å¤šæ£€æŸ¥6æ¬¡
		def retryInterval = 10  // æ¯æ¬¡é—´éš”10ç§’
		def healthy = false

		for (int i = 1; i <= maxRetries; i++) {
			echo "[${serverName}] å¥åº·æ£€æŸ¥ (${i}/${maxRetries})..."

			if (checkServerHealth(serverName)) {
				healthy = true
				echo "âœ… [${serverName}] éƒ¨ç½²æˆåŠŸï¼ŒæœåŠ¡å¥åº·"
				break
			}

			if (i < maxRetries) {
				echo "[${serverName}] â³ æœåŠ¡æœªå°±ç»ªï¼Œ${retryInterval}ç§’åé‡è¯•..."
				sleep(time: retryInterval, unit: 'SECONDS')
			}
		}

		if (!healthy) {
			error("âŒ [${serverName}] å¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæœåŠ¡å¯èƒ½æœªæ­£å¸¸å¯åŠ¨")
		}

	} catch (Exception e) {
		echo "âŒ [${serverName}] éƒ¨ç½²å¤±è´¥: ${e.message}"
		throw e
	}
}

// æ£€æŸ¥æœåŠ¡å™¨å¥åº·çŠ¶æ€
def checkServerHealth(serverName) {
	try {
		sshPublisher(
			continueOnError: false,
			failOnError: true,
			publishers: [
				sshPublisherDesc(
					configName: serverName,
					transfers: [
						sshTransfer(
							execCommand: """#!/bin/bash
APP_NAME="${env.JAR_NAME}"

# æ£€æŸ¥è¿›ç¨‹
PID=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk '{print \$2}')

if [ -z "\$PID" ]; then
    echo "[${serverName}] âŒ è¿›ç¨‹ä¸å­˜åœ¨"
    exit 1
fi

echo "[${serverName}] âœ… è¿›ç¨‹è¿è¡Œä¸­, PID: \$PID"

# æ£€æŸ¥è¿›ç¨‹è¿è¡Œæ—¶é—´ï¼ˆç¡®ä¿ä¸æ˜¯åˆšå¯åŠ¨å°±å´©æºƒï¼‰
PROCESS_TIME=\$(ps -p \$PID -o etime= | tr -d ' ')
echo "[${serverName}] è¿›ç¨‹è¿è¡Œæ—¶é—´: \$PROCESS_TIME"

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
MEMORY=\$(ps -p \$PID -o rss= | tr -d ' ')
MEMORY_MB=\$((MEMORY / 1024))
echo "[${serverName}] å†…å­˜ä½¿ç”¨: \${MEMORY_MB} MB"

# å¯é€‰: æ£€æŸ¥ç«¯å£ï¼ˆæ ¹æ®ä½ çš„å®é™…ç«¯å£ä¿®æ”¹ï¼‰
# PORT=8080
# if netstat -tlnp 2>/dev/null | grep \$PID | grep \$PORT > /dev/null; then
#     echo "[${serverName}] âœ… ç«¯å£ \$PORT æ­£å¸¸ç›‘å¬"
# else
#     echo "[${serverName}] âŒ ç«¯å£ \$PORT æœªç›‘å¬"
#     exit 1
# fi

# å¯é€‰: æ£€æŸ¥ HTTP å¥åº·æ£€æŸ¥æ¥å£
# HEALTH_URL="http://localhost:8080/actuator/health"
# if curl -f -s -m 5 \$HEALTH_URL > /dev/null 2>&1; then
#     echo "[${serverName}] âœ… å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸"
# else
#     echo "[${serverName}] âš ï¸  å¥åº·æ£€æŸ¥æ¥å£å¼‚å¸¸ï¼ˆå¯èƒ½æœåŠ¡è¿˜åœ¨å¯åŠ¨ä¸­ï¼‰"
#     exit 1
# fi

echo "[${serverName}] âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
exit 0
"""
						)
					]
				)
			]
		)

		return true

	} catch (Exception e) {
		echo "âš ï¸  [${serverName}] å¥åº·æ£€æŸ¥å¼‚å¸¸: ${e.message}"
		return false
	}
}
