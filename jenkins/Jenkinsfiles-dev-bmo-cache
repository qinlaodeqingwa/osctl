def getBuildTag() {
	return new Date().format('MMddHH') + "-${env.BUILD_ID}"
}
	
properties([
	parameters([
		string(
			name: 'git_branch',
			defaultValue: 'master',
			description: 'è¯·è¾“å…¥ä»£ç åˆ†æ”¯',
			trim: true
		),
		hidden(
			name: 'project_name',
			defaultValue: 'cache-service',
			description: 'é¡¹ç›®åç§°ï¼ˆéšè—å‚æ•°ï¼‰'
		),
		hidden(
			name: 'ssh_server_name',
			defaultValue: 'å¼€å‘-ä¸šåŠ¡å¹³å°',
			description: 'SSHæœåŠ¡å™¨é…ç½®åç§°ï¼ˆéšè—å‚æ•°ï¼‰'
		),
		hidden(
			name: 'remote_deploy_path',
			defaultValue: '/data/zcf-busi-middle-office/cache-service',
			description: 'è¿œç¨‹éƒ¨ç½²è·¯å¾„ï¼ˆéšè—å‚æ•°ï¼‰'
		),
		booleanParam(
			name: 'skip_tests',
			defaultValue: true,
			description: 'æ˜¯å¦è·³è¿‡å•å…ƒæµ‹è¯•'
		),
		booleanParam(
			name: 'clean_workspace',
			defaultValue: true,
			description: 'æ„å»ºå‰æ˜¯å¦æ¸…ç†å·¥ä½œç©ºé—´'
		)
	])
])

pipeline {
	agent any
	options {
		// ä¿ç•™æœ€è¿‘ 1 ä¸ªæ„å»ºè®°å½•ï¼ˆæ ¹æ®æ‚¨çš„åŸå§‹é…ç½®ï¼‰
		buildDiscarder(logRotator(numToKeepStr: '1'))
		// ç¦æ­¢å¹¶è¡Œæ„å»ºï¼Œç¡®ä¿ä¸€æ¬¡åªè¿è¡Œä¸€ä¸ªæ„å»º
		disableConcurrentBuilds()
		// å¯ç”¨ ANSI é¢œè‰²è¾“å‡ºï¼Œæ—¥å¿—æ˜¾ç¤ºæ›´ç¾è§‚
		ansiColor('xterm')
		// è®¾ç½®è¶…æ—¶æ—¶é—´ï¼š30 åˆ†é’Ÿ
		timeout(time: 30, unit: 'MINUTES')
		// ç¦ç”¨é»˜è®¤çš„ checkoutï¼Œæ‰‹åŠ¨æ§åˆ¶
		skipDefaultCheckout(true)
	}
	environment {
		MAVEN_OPTS = '-Xmx1024m'
		APP_NAME = 'cache-service'
		JAR_NAME = "${APP_NAME}.jar"
		GIT_CREDENTIALS_ID = 'aliyun-codeup-credentials'
		GIT_REPO_URL = 'https://codeup.aliyun.com/your-org/your-repo.git'
	}
	stages {
		stage('Preparation') {
			steps {
				script {
					echo """
                    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                    â•‘                    ğŸš€ æ„å»ºä¿¡æ¯                             â•‘
                    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
                    â•‘  é¡¹ç›®åç§°: ${params.project_name}
                    â•‘  Git åˆ†æ”¯: ${params.git_branch}
                    â•‘  è·³è¿‡æµ‹è¯•: ${params.skip_tests}
                    â•‘  æ¸…ç†ç©ºé—´: ${params.clean_workspace}
                    â•‘  æ„å»ºç¼–å·: ${env.BUILD_NUMBER}
                    â•‘  æ„å»ºæ ‡ç­¾: ${getBuildTag()}
                    â•‘  SSH æœåŠ¡å™¨: ${params.ssh_server_name}
                    â•‘  éƒ¨ç½²è·¯å¾„: ${params.remote_deploy_path}
                    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    """
					if (params.clean_workspace) {
						echo "##########æ¸…ç†å·¥ä½œç©ºé—´..."
						deleteDir()
					} else {
						echo "###########è·³è¿‡æ¸…ç†å·¥ä½œç©ºé—´"
					}
				}
			}
		}
		stage('Git Clone') {
			when {
				expression { params.git_branch != "" }
			}
			steps {
				script {
					echo "###################å¼€å§‹å…‹éš†ä»£ç ..."
					echo "   åˆ†æ”¯: ${params.git_branch}"
					echo "   ä»“åº“: ${env.GIT_REPO_URL}"
					checkout([
						$class: 'GitSCM',
						branches: [[name: "*/${params.git_branch}"]],
						doGenerateSubmoduleConfigurations: false,
						extensions: [],
						userRemoteConfigs: [[
							credentialsId: "${env.GIT_CREDENTIALS_ID}",
							url: "${env.GIT_REPO_URL}"
						]]
					])
					sh 'echo "æœ€æ–°æäº¤ä¿¡æ¯ï¼š"'
					sh 'git log -1 --oneline'
					sh 'git log -1 --pretty=format:"   ä½œè€…: %an%n   æ—¶é—´: %ad%n   è¯´æ˜: %s" --date=format:"%Y-%m-%d %H:%M:%S"'
				}
			}
		}
		stage('Maven Build') {
			when {
				expression { params.git_branch != "" }
			}
			steps {
				script {
					echo "#######å¼€å§‹ Maven æ„å»º..."
					echo "#######æ¨¡å—: ${env.APP_NAME}"
					echo "#######è·³è¿‡æµ‹è¯•: ${params.skip_tests}"

					def skipTestsFlag = params.skip_tests ? '-DskipTests' : ''
					sh """
                        mvn clean package \
                            -f pom.xml \
                            -pl ${env.APP_NAME} \
                            -am \
                            ${skipTestsFlag}
                    """
					echo "âœ… Maven æ„å»ºå®Œæˆ"
				}
			}
		}

		stage('Verify Build') {
			when {
				expression { params.git_branch != "" }
			}
			steps {
				script {
					echo "ğŸ” éªŒè¯æ„å»ºç»“æœ..."

					// è·å–å½“å‰æ„å»ºå¯¹è±¡
					def build = currentBuild.rawBuild
					def buildLog = new StringWriter()

					// è¯»å–æ„å»ºæ—¥å¿—
					build.logFile.eachLine { line ->
						buildLog.write(line)
					}
					if (buildLog.toString().contains("BUILD SUCCESS")) {
						currentBuild.result = 'SUCCESS'
						echo "#########Maven æ„å»ºæˆåŠŸï¼Œå·²å¼ºåˆ¶æ›´æ–°æ„å»ºçŠ¶æ€ä¸º SUCCESS"
					} else {
						echo "#########Maven æ„å»ºæœªæˆåŠŸï¼Œä¸æ›´æ–°çŠ¶æ€"
						error("Maven æ„å»ºå¤±è´¥")
					}

					def jarExists = sh(
						script: "test -f ${env.APP_NAME}/target/${env.JAR_NAME} && echo 'true' || echo 'false'",
						returnStdout: true
					).trim()

					if (jarExists == 'true') {
						echo "#########JAR æ–‡ä»¶ç”ŸæˆæˆåŠŸ: ${env.APP_NAME}/target/${env.JAR_NAME}"
						sh "ls -lh ${env.APP_NAME}/target/${env.JAR_NAME}"
					} else {
						error("########JAR æ–‡ä»¶ä¸å­˜åœ¨: ${env.APP_NAME}/target/${env.JAR_NAME}")
					}
				}
			}
		}
		stage('Deploy Confirm') {
			when {
				expression { params.git_branch != "" }
			}
			steps {
				script {
					echo "###########ç­‰å¾…éƒ¨ç½²ç¡®è®¤..."
					input(
						message: """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                       å‡†å¤‡éƒ¨ç½²                             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  é¡¹ç›®: ${params.project_name}								â•‘
â•‘  åˆ†æ”¯: ${params.git_branch}								â•‘
â•‘  æœåŠ¡å™¨: ${params.ssh_server_name}							â•‘
â•‘  è·¯å¾„: ${params.remote_deploy_path}						â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ˜¯å¦ç¡®è®¤éƒ¨ç½²ï¼Ÿ
                        """,
						ok: "ç¡®è®¤éƒ¨ç½²"
					)

					echo "############éƒ¨ç½²å·²ç¡®è®¤ï¼Œç»§ç»­æ‰§è¡Œ..."
				}
			}
		}
		stage('Stop Remote Service') {
			when {
				expression {
					params.git_branch != "" &&
					(currentBuild.result == null || currentBuild.result == 'SUCCESS')
				}
			}
			steps {
				script {
					echo "########åœæ­¢è¿œç¨‹æœåŠ¡..."
					echo "########æœåŠ¡å™¨: ${params.ssh_server_name}"
					echo "########åº”ç”¨åç§°: ${env.JAR_NAME}"
					sshPublisher(
						publishers: [
							sshPublisherDesc(
								configName: "${params.ssh_server_name}",
								transfers: [
									sshTransfer(
										execCommand: """#!/bin/bash

# ============================================================================
# åœæ­¢æœåŠ¡è„šæœ¬
# ============================================================================

# å®šä¹‰å˜é‡
APP_NAME="${env.JAR_NAME}"
MAX_RETRIES=2
SLEEP_TIME=10

echo "=========================================="
echo "åœæ­¢æœåŠ¡: \$APP_NAME"
echo "=========================================="

# è·å–æ‰€æœ‰è¿›ç¨‹ PID
PIDS=(\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk '{print \$2}'))

# å¦‚æœå­˜åœ¨è¿›ç¨‹ï¼Œå°è¯• kill
if [ \${#PIDS[@]} -gt 0 ]; then
    echo "âœ“ å‘ç° \${#PIDS[@]} ä¸ª \$APP_NAME è¿›ç¨‹"
    echo "  PIDs: \${PIDS[*]}"
    echo "  å¼€å§‹ç»ˆæ­¢è¿›ç¨‹..."

    # å°è¯•ç»ˆæ­¢æ‰€æœ‰è¿›ç¨‹
    for pid in "\${PIDS[@]}"; do
        echo "  â†’ ç»ˆæ­¢è¿›ç¨‹ PID: \$pid"
        kill \$pid
    done

    # å¾ªç¯æ£€æµ‹è¿›ç¨‹æ˜¯å¦å·²ç»ˆæ­¢
    RETRY=0
    while [ \$RETRY -lt \$MAX_RETRIES ]; do
        sleep \$SLEEP_TIME
        REMAINING_PIDS=(\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk '{print \$2}'))

        if [ \${#REMAINING_PIDS[@]} -eq 0 ]; then
            echo "âœ“ æ‰€æœ‰ \$APP_NAME è¿›ç¨‹å·²æˆåŠŸç»ˆæ­¢"
            exit 0
        else
            echo "âš  ä»æœ‰ \${#REMAINING_PIDS[@]} ä¸ªè¿›ç¨‹å­˜åœ¨ (PIDs: \${REMAINING_PIDS[*]})"
            echo "  é‡è¯• \$((RETRY+1))/\$MAX_RETRIES..."
            for pid in "\${REMAINING_PIDS[@]}"; do
                echo "  â†’ å†æ¬¡ç»ˆæ­¢è¿›ç¨‹ PID: \$pid"
                kill \$pid
            done
            RETRY=\$((RETRY+1))
        fi
    done

    # å¦‚æœè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ä»å­˜åœ¨è¿›ç¨‹ï¼ŒæŠ¥é”™é€€å‡º
    echo "âœ— é”™è¯¯: å°è¯• \$MAX_RETRIES æ¬¡åä»æœ‰ \${#REMAINING_PIDS[@]} ä¸ªè¿›ç¨‹æ— æ³•ç»ˆæ­¢"
    echo "  æ®‹ç•™ PIDs: \${REMAINING_PIDS[*]}"
    exit 1
else
    echo "âœ“ \$APP_NAME è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæ— éœ€åœæ­¢"
    exit 0
fi
"""
									)
								]
							)
						]
					)

					echo "#############è¿œç¨‹æœåŠ¡å·²åœæ­¢"
				}
			}
		}
		stage('Deploy Application') {
			when {
				expression {
					params.git_branch != "" &&
					(currentBuild.result == null || currentBuild.result == 'SUCCESS')
				}
			}
			steps {
				script {
					echo "#########å¼€å§‹éƒ¨ç½²åº”ç”¨..."
					echo "#########æºæ–‡ä»¶: ${env.APP_NAME}/target/${env.JAR_NAME}"
					echo "#########ç›®æ ‡æœåŠ¡å™¨: ${params.ssh_server_name}"
					echo "#########ç›®æ ‡è·¯å¾„: ${params.remote_deploy_path}"

					sshPublisher(
						publishers: [
							sshPublisherDesc(
								configName: "${params.ssh_server_name}",
								transfers: [
									sshTransfer(
										sourceFiles: "**/${env.JAR_NAME}",
										removePrefix: "${env.APP_NAME}/target",
										remoteDirectory: "busi-middle-office/${env.APP_NAME}/",
										execCommand: """#!/bin/bash

# ============================================================================
# å¯åŠ¨æœåŠ¡è„šæœ¬
# ============================================================================

echo "=========================================="
echo "å¯åŠ¨æœåŠ¡: ${env.JAR_NAME}"
echo "=========================================="

# åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
cd ${params.remote_deploy_path}

# æ£€æŸ¥å¯åŠ¨è„šæœ¬æ˜¯å¦å­˜åœ¨
if [ ! -f start.sh ]; then
    echo "âœ— é”™è¯¯: start.sh ä¸å­˜åœ¨"
    exit 1
fi

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x start.sh

# æ‰§è¡Œå¯åŠ¨è„šæœ¬
echo "âœ“ æ‰§è¡Œå¯åŠ¨è„šæœ¬..."
./start.sh

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 5

# æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯åŠ¨æˆåŠŸ
PIDS=\$(ps -ef | grep "${env.JAR_NAME}" | grep -v grep | awk '{print \$2}')

if [ -n "\$PIDS" ]; then
    echo "âœ“ æœåŠ¡å¯åŠ¨æˆåŠŸ"
    echo "  PID: \$PIDS"
    exit 0
else
    echo "âœ— æœåŠ¡å¯åŠ¨å¤±è´¥"
    exit 1
fi
"""
									)
								]
							)
						]
					)

					echo "#########åº”ç”¨éƒ¨ç½²å®Œæˆ"
				}
			}
		}
		stage('Health Check') {
			when {
				expression {
					params.git_branch != "" &&
					(currentBuild.result == null || currentBuild.result == 'SUCCESS')
				}
			}
			steps {
				script {
					echo "ğŸ¥ å¼€å§‹å¥åº·æ£€æŸ¥..."
					echo "   ç­‰å¾… 10 ç§’åæ£€æŸ¥æœåŠ¡çŠ¶æ€..."

					// ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
					sleep(time: 10, unit: 'SECONDS')

					// æ£€æŸ¥è¿œç¨‹æœåŠ¡çŠ¶æ€
					sshPublisher(
						publishers: [
							sshPublisherDesc(
								configName: "${params.ssh_server_name}",
								transfers: [
									sshTransfer(
										execCommand: """#!/bin/bash
# ============================================================================
# å¥åº·æ£€æŸ¥è„šæœ¬
# ============================================================================

APP_NAME="${env.JAR_NAME}"

echo "=========================================="
echo "å¥åº·æ£€æŸ¥: \$APP_NAME"
echo "=========================================="

# æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
PIDS=\$(ps -ef | grep "\$APP_NAME" | grep -v grep | awk '{print \$2}')

if [ -n "\$PIDS" ]; then
    echo "âœ“ æœåŠ¡è¿è¡Œæ­£å¸¸"
    echo "  PID: \$PIDS"

    # æ˜¾ç¤ºè¿›ç¨‹è¯¦ç»†ä¿¡æ¯
    echo ""
    echo "è¿›ç¨‹è¯¦æƒ…:"
    ps -ef | grep "\$APP_NAME" | grep -v grep

    # æ˜¾ç¤ºç«¯å£ç›‘å¬æƒ…å†µï¼ˆå¦‚æœæœ‰ï¼‰
    echo ""
    echo "ç«¯å£ç›‘å¬:"
    netstat -tlnp 2>/dev/null | grep "\$PIDS" || echo "  (æ— æ³•è·å–ç«¯å£ä¿¡æ¯)"

    exit 0
else
    echo "âœ— æœåŠ¡æœªè¿è¡Œ"
    echo ""
    echo "æœ€è¿‘æ—¥å¿—:"
    tail -n 50 ${params.remote_deploy_path}/logs/*.log 2>/dev/null || echo "  (æ— æ³•è¯»å–æ—¥å¿—)"
    exit 1
fi
"""
									)
								]
							)
						]
					)

					echo "#########å¥åº·æ£€æŸ¥é€šè¿‡"
				}
			}
		}
	}
	post {
		success {
			script {
				echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âœ… æ„å»ºéƒ¨ç½²æˆåŠŸ                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  é¡¹ç›®: ${params.project_name}
â•‘  åˆ†æ”¯: ${params.git_branch}
â•‘  æ„å»ºå·: ${env.BUILD_NUMBER}
â•‘  æ„å»ºæ ‡ç­¾: ${getBuildTag()}
â•‘  æœåŠ¡å™¨: ${params.ssh_server_name}
â•‘  éƒ¨ç½²è·¯å¾„: ${params.remote_deploy_path}
â•‘  è€—æ—¶: ${currentBuild.durationString.replace(' and counting', '')}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """
			}
		}
		failure {
			script {
				echo """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    âŒ æ„å»ºéƒ¨ç½²å¤±è´¥                         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  é¡¹ç›®: ${params.project_name}
â•‘  åˆ†æ”¯: ${params.git_branch}
â•‘  æ„å»ºå·: ${env.BUILD_NUMBER}
â•‘  å¤±è´¥é˜¶æ®µ: ${env.STAGE_NAME}
â•‘  é”™è¯¯ä¿¡æ¯: è¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """
			}
		}
		always {
			script {
				echo "   Pipeline æ‰§è¡Œå®Œæˆ"
				echo "   å¼€å§‹æ—¶é—´: ${new Date(currentBuild.startTimeInMillis).format('yyyy-MM-dd HH:mm:ss')}"
				echo "   ç»“æŸæ—¶é—´: ${new Date().format('yyyy-MM-dd HH:mm:ss')}"
				echo "   æ€»è€—æ—¶: ${currentBuild.durationString.replace(' and counting', '')}"
			}
		}
	}
}
