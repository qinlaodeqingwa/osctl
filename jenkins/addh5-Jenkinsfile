properties([
	parameters([
		choice(
			name: 'REPOSITORY',
			choices: [
				'zcf-charge-operation-platform',
				'zcf-busi-middle-office',
				'zcf-iot-gateway',
				'zcf-data-platform-jobs',
				'zcf-charge-plat',
				'zcf-charge-tenant',
				'zcf-data-platform-engine',
				'zcf-charge-h5'
			],
			description: 'é€‰æ‹©è¦æ„å»ºçš„ä»£ç ä»“åº“'
		),

		[$class: 'CascadeChoiceParameter',
			choiceType: 'PT_SINGLE_SELECT',
			name: 'BRANCH',
			referencedParameters: 'REPOSITORY',
			script: [
				$class: 'GroovyScript',
				fallbackScript: [
					sandbox: true,
					script: '''
                        return ['è¯·å…ˆé€‰æ‹©ä»£ç ä»“åº“']
                    '''
				],
				script: [
					sandbox: false,
					script: '''
                       import jenkins.model.Jenkins
                        import com.cloudbees.plugins.credentials.CredentialsProvider
                        import com.cloudbees.plugins.credentials.common.StandardUsernamePasswordCredentials
                        import com.cloudbees.plugins.credentials.domains.DomainRequirement

                        def getCredentials(String credentialsId) {
                            def creds = CredentialsProvider.lookupCredentials(
                                StandardUsernamePasswordCredentials.class,
                                Jenkins.instance,
                                null,
                                Collections.<DomainRequirement>emptyList()
                            )
                            return creds.find { it.id == credentialsId }
                        }

                        def credentialsId = '99b27b05-ecce-4a92-a478-f806be8528f3'
                        def credentials = getCredentials(credentialsId)

                        if (!credentials) {
                            return ['é”™è¯¯: æœªæ‰¾åˆ°å‡­æ®']
                        }

                        def username = credentials.username
                        def password = credentials.password.plainText

                        def repoMap = [
                        		'zcf-charge-operation-platform': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/backend/zcf-charge-operation-platform.git',
								'zcf-busi-middle-office': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/middle-office/backend/zcf-busi-middle-office.git',
								'zcf-iot-gateway': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/base-framework/backend/zcf-iot-gateway.git',
								'zcf-charge-plat': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-platform-web.git',
								'zcf-charge-tenant': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-tenant-web.git',
								'zcf-data-platform-jobs': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/data-middle-office/backend/zcf-data-middle-office-job.git',
								'zcf-data-platform-engine': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/data-middle-office/backend/zcf-data-middle-office-job-framework.git',
								'zcf-charge-h5': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-platform-applet.git'
                        ]

                        def repoUrl = repoMap[REPOSITORY]

                        if (!repoUrl) {
                            return ['è¯·å…ˆé€‰æ‹©ä»£ç ä»“åº“']
                        }

                        def authenticatedUrl = repoUrl.replace('https://', "https://${username}:${password}@")

                        try {
                            def command = "git ls-remote -h ${authenticatedUrl}"
                            def proc = command.execute()
                            proc.waitForOrKill(30000)

                            def exitCode = proc.exitValue()
                            def output = proc.text

                            if (exitCode != 0) {
                                return ['è·å–åˆ†æ”¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‡­æ®å’Œç½‘ç»œ']
                            }

                            def branches = []
                            output.eachLine { line ->
                                if (line && line.trim()) {
                                    def parts = line.trim().split(/\\s+/)
                                    if (parts.size() >= 2 && parts[1].startsWith('refs/heads/')) {
                                        def branchName = parts[1].replace('refs/heads/', '')
                                        branches.add("origin/${branchName}".toString())
                                    }
                                }
                            }

                            if (branches.isEmpty()) {
                                return ['æœªæ‰¾åˆ°åˆ†æ”¯']
                            }

                            return branches.sort().reverse().collect { it.toString() }

                        } catch (Exception e) {
                            return ["å¼‚å¸¸: ${e.message}".toString()]
                        }
                    '''
				]
			],
			description: 'é€‰æ‹©è¦æ„å»ºçš„åˆ†æ”¯'
		],

		[$class: 'CascadeChoiceParameter',
			choiceType: 'PT_CHECKBOX',
			name: 'BUILD_MODULES',
			referencedParameters: 'REPOSITORY,BRANCH',
			script: [
				$class: 'GroovyScript',
				fallbackScript: [
					sandbox: true,
					script: '''
                        return ['è¯·å…ˆé€‰æ‹©ä»£ç ä»“åº“å’Œåˆ†æ”¯']
                    '''
				],
				script: [
					sandbox: false,
					script: '''
                        import jenkins.model.Jenkins
                        import com.cloudbees.plugins.credentials.CredentialsProvider
                        import com.cloudbees.plugins.credentials.common.StandardUsernamePasswordCredentials
                        import com.cloudbees.plugins.credentials.domains.DomainRequirement

                        def frontendProjects = ['zcf-charge-h5', 'zcf-charge-plat', 'zcf-charge-tenant']

                        if (frontendProjects.contains(REPOSITORY)) {
                            return ['å‰ç«¯é¡¹ç›®æ— éœ€é€‰æ‹©æ¨¡å—']
                        }

                        def getCredentials(String credentialsId) {
                            def creds = CredentialsProvider.lookupCredentials(
                                StandardUsernamePasswordCredentials.class,
                                Jenkins.instance,
                                null,
                                Collections.<DomainRequirement>emptyList()
                            )
                            return creds.find { it.id == credentialsId }
                        }

                        def credentialsId = '99b27b05-ecce-4a92-a478-f806be8528f3'
                        def credentials = getCredentials(credentialsId)

                        if (!credentials) {
                            return ['é”™è¯¯: æœªæ‰¾åˆ°å‡­æ®']
                        }

                        def username = credentials.username
                        def password = credentials.password.plainText

                        def repoMap = [
                            		'zcf-charge-operation-platform': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/backend/zcf-charge-operation-platform.git',
		'zcf-busi-middle-office': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/middle-office/backend/zcf-busi-middle-office.git',
		'zcf-iot-gateway': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/base-framework/backend/zcf-iot-gateway.git',
		'zcf-charge-plat': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-platform-web.git',
		'zcf-charge-tenant': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-tenant-web.git',
		'zcf-data-platform-jobs': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/data-middle-office/backend/zcf-data-middle-office-job.git',
		'zcf-data-platform-engine': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/data-middle-office/backend/zcf-data-middle-office-job-framework.git',
		'zcf-charge-h5': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-platform-applet.git'
		]

                        def repoUrl = repoMap[REPOSITORY]

                        if (!repoUrl || !BRANCH) {
                            return ['è¯·å…ˆé€‰æ‹©ä»£ç ä»“åº“å’Œåˆ†æ”¯']
                        }

                        def authenticatedUrl = repoUrl.replace('https://', "https://${username}:${password}@")

                        try {
                            def tempDir = File.createTempFile("jenkins-modules-", "")
                            tempDir.delete()
                            tempDir.mkdirs()

                            println "========== DEBUG: è·å–æ¨¡å—åˆ—è¡¨ =========="
                            println "Repository: ${REPOSITORY}"
                            println "Branch: ${BRANCH}"
                            println "Temp Dir: ${tempDir.absolutePath}"

                            try {
                                def branchName = BRANCH.replace('origin/', '')
                                def cloneCommand = "git clone --depth 1 --branch ${branchName} ${authenticatedUrl} ${tempDir.absolutePath}"

                                println "Executing: git clone --depth 1 --branch ${branchName} <repo> <temp>"

                                def cloneProc = cloneCommand.execute()
                                cloneProc.waitForOrKill(60000)

                                def cloneExitCode = cloneProc.exitValue()

                                if (cloneExitCode != 0) {
                                    def cloneError = cloneProc.err.text
                                    println "Clone failed: ${cloneError}"
                                    return ['å…‹éš†ä»“åº“å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆ†æ”¯åç§°']
                                }

                                println "Clone successful"

                                def pomFile = new File(tempDir, "pom.xml")

                                if (!pomFile.exists()) {
                                    println "pom.xml not found"
                                    return ['æœªæ‰¾åˆ° pom.xml æ–‡ä»¶']
                                }

                                println "Reading pom.xml"

                                def allModules = []
                                def deepScanProjects = [
                                    'zcf-data-platform-jobs': ['job-dwd', 'job-dws', 'job-ods', 'job-ads', 'job-dim'],
                                    'zcf-data-platform-engine': []
                                ]

                                if (deepScanProjects.containsKey(REPOSITORY)) {
                                    def parentModules = deepScanProjects[REPOSITORY]

                                    println "Deep scan enabled for: ${parentModules}"
                                    parentModules.each { parentModule ->
                                        def parentPomFile = new File(tempDir, "${parentModule}/pom.xml")

                                        if (parentPomFile.exists()) {
                                            println "Scanning parent module: ${parentModule}"

                                            def parentPomContent = parentPomFile.text
                                            def modulePattern = /<module>([^<]+)<\\/module>/
                                            def matcher = parentPomContent =~ modulePattern

                                            matcher.each { match ->
                                                def subModuleName = match[1].trim()
                                                if (subModuleName && !subModuleName.isEmpty()) {
                                                    allModules.add("[${parentModule}]${subModuleName}".toString())
                                                    println "  Found sub-module: ${subModuleName}"
                                                }
                                            }
                                        } else {
                                            println "Parent pom not found: ${parentModule}/pom.xml"
                                        }
                                    }
                                }

                                def pomContent = pomFile.text
                                def modulePattern = /<module>([^<]+)<\\/module>/
                                def matcher = pomContent =~ modulePattern

                                matcher.each { match ->
                                    def moduleName = match[1].trim()
                                    if (moduleName && !moduleName.isEmpty()) {
                                        if (!deepScanProjects.containsKey(REPOSITORY) ||
                                            !deepScanProjects[REPOSITORY].contains(moduleName)) {
                                            allModules.add(moduleName.toString())
                                            println "Found root module: ${moduleName}"
                                        }
                                    }
                                }

                                println "Total modules found: ${allModules.size()}"
                                println "Modules: ${allModules}"
                                println "=========================================="

                                if (allModules.isEmpty()) {
                                    return ['æœªæ‰¾åˆ°æ¨¡å—']
                                }

                                return allModules.sort().collect { it.toString() }

                            } finally {
                                tempDir.deleteDir()
                                println "Temp dir cleaned"
                            }

                        } catch (Exception e) {
                            println "Exception: ${e.message}"
                            e.printStackTrace()
                            return ["è·å–æ¨¡å—å¤±è´¥: ${e.message}".toString()]
                        }
                    '''
				]
			],
			description: 'é€‰æ‹©è¦æ„å»ºçš„æ¨¡å—ï¼ˆå‰ç«¯é¡¹ç›®æ— éœ€é€‰æ‹©ï¼‰'
		],

		string(
			name: 'VERSION_SUFFIX',
			defaultValue: 'SNAPSHOT',
			description: 'ç‰ˆæœ¬å·åç¼€ï¼ˆå¦‚ï¼šSNAPSHOTã€RC1ã€RELEASEï¼‰'
		),

		booleanParam(
			name: 'SKIP_TESTS',
			defaultValue: true,
			description: 'æ˜¯å¦è·³è¿‡å•å…ƒæµ‹è¯•'
		)
	])
])

pipeline {
	agent any

	tools {
		maven 'maven3'
	}

	environment {
		REPO_URL = getRepositoryUrl(params.REPOSITORY)
		CREDENTIALS_ID = '99b27b05-ecce-4a92-a478-f806be8528f3'
		MAVEN_SETTINGS = '/data/apache-maven-3.8.6/conf/settings-zcf-nexus.xml'
		IS_FRONTEND = isFrontendProject(params.REPOSITORY)

		ARTIFACTS_BASE_DIR = '/data/artifacts'
	}

	stages {
		stage('å‡†å¤‡é˜¶æ®µ') {
			steps {
				script {
					echo"""
					æ„å»ºä¿¡æ¯
					==========================================
					ä»£ç ä»“åº“: ${params.REPOSITORY}
					ä»“åº“åœ°å€: ${env.REPO_URL}
					é¡¹ç›®ç±»å‹: ${env.IS_FRONTEND == 'true' ? 'å‰ç«¯é¡¹ç›®' : 'åç«¯é¡¹ç›®'}
					åˆ†æ”¯: ${params.BRANCH}
					==========================================
					"""
					if (env.IS_FRONTEND == 'false') {
						echo "æ„å»ºæ¨¡å—: ${params.BUILD_MODULES}"
					}
					echo """
					ç‰ˆæœ¬åç¼€: ${params.VERSION_SUFFIX}
					è·³è¿‡æµ‹è¯•: ${params.SKIP_TESTS}
					åˆ¶å“å­˜å‚¨: ${env.ARTIFACTS_BASE_DIR}
					==========================================
					"""

					sh """
						mkdir -p ${env.ARTIFACTS_BASE_DIR}/backend
						mkdir -p ${env.ARTIFACTS_BASE_DIR}/frontend
						mkdir -p ${env.ARTIFACTS_BASE_DIR}/releases
					"""
				}
			}
		}

		stage('æ‹‰å–ä»£ç ') {
			steps {
				script {
					cleanWs()

					checkout([
						$class: 'GitSCM',
						branches: [[name: params.BRANCH]],
						userRemoteConfigs: [[
							credentialsId: env.CREDENTIALS_ID,
							url: env.REPO_URL
						]]
					])
				}
			}
		}

		stage('ç”Ÿæˆç‰ˆæœ¬å·å¹¶æ„å»º') {
			steps {
				script {
					def gitCommitShort = sh(
						script: "git rev-parse --short HEAD",
						returnStdout: true
					).trim()

					def gitCommitTime = sh(
						script: "git log -1 --format=%cd --date=format:'%Y%m%d%H%M%S'",
						returnStdout: true
					).trim()

					def branchName = params.BRANCH.replaceAll('origin/', '').replaceAll('/', '-')
					def buildVersion = "${gitCommitTime}-${gitCommitShort}-${branchName}-${params.VERSION_SUFFIX}"

					env.BUILD_VERSION = buildVersion
					env.GIT_COMMIT_SHORT = gitCommitShort
					env.GIT_COMMIT_TIME = gitCommitTime
					env.BRANCH_NAME = branchName

					echo ""
					echo """
    ==========================================
    ç‰ˆæœ¬ä¿¡æ¯
    ==========================================
    Git Commit: ${gitCommitShort}
    æäº¤æ—¶é—´: ${gitCommitTime}
    åˆ†æ”¯åç§°: ${branchName}
    ç‰ˆæœ¬åç¼€: ${params.VERSION_SUFFIX}
    æœ€ç»ˆç‰ˆæœ¬å·: ${buildVersion}
    ==========================================
""".stripIndent().trim()

					if (env.IS_FRONTEND == 'true') {
						echo "å¼€å§‹æ„å»ºå‰ç«¯é¡¹ç›®: ${params.REPOSITORY}"

						try {
							def packageJsonExists = fileExists('package.json')
							if (!packageJsonExists) {
								error("æœªæ‰¾åˆ° package.json æ–‡ä»¶")
							}

							echo "æ­£åœ¨å®‰è£…ä¾èµ–..."
							sh "/data/nodejs/node-v24.10.0-linux-x64/bin/npm install"

							echo "æ­£åœ¨æ„å»ºé¡¹ç›®..."
							def buildCommand
							if (params.REPOSITORY == 'zcf-charge-h5') {
								buildCommand = "build:h5:prod"
							} else {
								buildCommand = "build:prod"
							}
							sh "/data/nodejs/node-v24.10.0-linux-x64/bin/npm run ${buildCommand}"

							def distDir
							if (params.REPOSITORY == 'zcf-charge-h5') {
								distDir = "dist/build/h5"
								echo "H5 é¡¹ç›®ï¼Œä½¿ç”¨æ„å»ºäº§ç‰©ç›®å½•: ${distDir}"
							} else {
								distDir = "dist"
								echo "å‰ç«¯é¡¹ç›®ï¼Œä½¿ç”¨æ„å»ºäº§ç‰©ç›®å½•: ${distDir}"
							}

							if (fileExists(distDir)) {
								def tarName = "${params.REPOSITORY}-${buildVersion}.tar.gz"

								sh """
								cd ${distDir}
								tar -czf ${env.WORKSPACE}/${tarName} .
            					"""
								env.BUILT_MODULES = params.REPOSITORY
								env.FRONTEND_ARTIFACT = tarName
								echo """
								âœ… å‰ç«¯é¡¹ç›®æ„å»ºæˆåŠŸï¼Œäº§ç‰©: ${tarName}
								æ‰“åŒ…ç›®å½•: ${distDir}
								äº§ç‰©è·¯å¾„: ${env.WORKSPACE}/${tarName}
								"""
							} else {
								error("æ„å»ºäº§ç‰©ç›®å½• ${distDir} ä¸å­˜åœ¨")
							}

						} catch (Exception e) {
							echo "âŒ å‰ç«¯é¡¹ç›®æ„å»ºå¤±è´¥: ${e.message}"
							throw e
						}

					} else {
						echo """==========================================
						ğŸ“‹ å¼€å§‹è§£ææ„å»ºæ¨¡å—
						åŸå§‹æ¨¡å—åˆ—è¡¨: ${params.BUILD_MODULES}
						==========================================
						"""

						def modules = params.BUILD_MODULES.split(',')
						def buildResults = [:]
						def builtModulesList = []
						def artifactsList = []

						echo "è§£æåˆ° ${modules.size()} ä¸ªæ¨¡å—"

						for (module in modules) {
							module = module.trim()

							if (!module) {
								echo "âš ï¸ è·³è¿‡ç©ºæ¨¡å—"
								continue
							}

							def buildPath = '.'
							def moduleName = module
							def parentModule = ''
							def groupId = 'com.zcf.middle-office.data'
							def originalModule = module
							if (module.startsWith('[') && module.contains(']')) {
								def parts = module.split(']', 2)
								parentModule = parts[0].substring(1)
								moduleName = parts[1]
								buildPath = parentModule

								echo """
								ğŸ” æ£€æµ‹åˆ°äºŒçº§å­æ¨¡å—
								åŸå§‹: ${originalModule}
								çˆ¶æ¨¡å—: ${parentModule}
								å­æ¨¡å—: ${moduleName}
								"""
							} else {
								echo "ğŸ” æ™®é€šæ¨¡å—: ${moduleName}"
							}

							echo """
							==========================================
							ğŸ”¨ å¼€å§‹æ„å»ºæ¨¡å—: ${moduleName}
							==========================================
							æ„å»ºè·¯å¾„: ${buildPath}
							æ¨¡å—åç§°: ${moduleName}
							"""
							if (parentModule) {
								echo "çˆ¶æ¨¡å—: ${parentModule}"
								echo "GroupId: ${groupId}"
							}
							echo "=========================================="

							try {
								def skipTestsFlag = params.SKIP_TESTS ? '-DskipTests' : ''

								def isDataPlatformJobs = params.REPOSITORY == 'zcf-data-platform-jobs'

								def mavenCommand
								if (parentModule && isDataPlatformJobs) {
									echo "ğŸ“¦ ä½¿ç”¨å®Œæ•´åæ ‡æ„å»ºæ¨¡å¼ï¼ˆzcf-data-platform-jobsï¼‰"
									echo "âš ï¸ æ³¨æ„ï¼šå°†åœ¨æ ¹ç›®å½•æ‰§è¡Œæ„å»ºä»¥è§£ææ‰€æœ‰ä¾èµ–"
									mavenCommand = """
										cd ${env.WORKSPACE}
										pwd
										echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: mvn clean package -U -pl ${groupId}:${moduleName} -am ${skipTestsFlag}"
										mvn clean package -U -pl ${groupId}:${moduleName} -am ${skipTestsFlag} \
											-s ${MAVEN_SETTINGS} \
											-gs ${MAVEN_SETTINGS}
									"""
								} else if (parentModule) {
									echo "ğŸ“¦ ä½¿ç”¨ç›¸å¯¹è·¯å¾„æ„å»ºæ¨¡å¼"
									mavenCommand = """
										cd ${env.WORKSPACE}/${parentModule}
										pwd
										echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: mvn clean package -U -pl ${moduleName} -am ${skipTestsFlag}"
										mvn clean package -U -pl ${moduleName} -am ${skipTestsFlag} \
											-s ${MAVEN_SETTINGS} \
											-gs ${MAVEN_SETTINGS}
									"""
								} else {

									echo "ğŸ“¦ ä½¿ç”¨æ™®é€šæ„å»ºæ¨¡å¼"
									mavenCommand = """
										cd ${env.WORKSPACE}
										pwd
										echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: mvn clean package -U -pl ${moduleName} -am ${skipTestsFlag}"
										mvn clean package -U -pl ${moduleName} -am ${skipTestsFlag} \
											-s ${MAVEN_SETTINGS} \
											-gs ${MAVEN_SETTINGS}
									"""
								}

								sh mavenCommand

								buildResults[moduleName] = 'SUCCESS'
								echo "âœ… æ¨¡å— ${moduleName} ç¼–è¯‘æˆåŠŸ"

								def jarSearchPath = parentModule ? "${parentModule}/${moduleName}" : moduleName

								echo """
								ğŸ” æŸ¥æ‰¾æ„å»ºäº§ç‰©...
								æœç´¢è·¯å¾„: ${env.WORKSPACE}/${jarSearchPath}/target
								"""

								def targetDirExists = sh(
									script: "[ -d '${env.WORKSPACE}/${jarSearchPath}/target' ] && echo 'yes' || echo 'no'",
									returnStdout: true
								).trim()

								if (targetDirExists == 'no') {
									echo "âŒ target ç›®å½•ä¸å­˜åœ¨: ${env.WORKSPACE}/${jarSearchPath}/target"
									buildResults[moduleName] = 'FAILED'
									continue
								}

								echo "âœ… target ç›®å½•å­˜åœ¨"

								sh "ls -lh ${env.WORKSPACE}/${jarSearchPath}/target/*.jar || true"

								def jarFile = sh(
									script: "find ${env.WORKSPACE}/${jarSearchPath}/target -name '*.jar' -not -name '*-sources.jar' -not -name '*-javadoc.jar' -not -name '*.original' | head -1",
									returnStdout: true
								).trim()

								if (jarFile) {
									echo "âœ… æ‰¾åˆ° jar æ–‡ä»¶: ${jarFile}"

									def jarName = jarFile.split('/').last()
									def newJarName = jarName.replaceAll('\\.jar$', "-${buildVersion}.jar")
									def newJarPath = "${env.WORKSPACE}/${jarSearchPath}/target/${newJarName}"

									sh "cp ${jarFile} ${newJarPath}"
									echo "âœ… é‡å‘½åäº§ç‰©: ${newJarName}"

									builtModulesList.add(moduleName)
									artifactsList.add("${moduleName}:${newJarPath}")
									echo "âœ… æ¨¡å— ${moduleName} æ„å»ºå®Œæˆ"
								} else {
									echo "âŒ æœªæ‰¾åˆ° jar æ–‡ä»¶"
									buildResults[moduleName] = 'FAILED'
								}

							} catch (Exception e) {
								buildResults[moduleName] = 'FAILED'
								echo """
								âŒ æ¨¡å— ${moduleName} æ„å»ºå¤±è´¥"
								é”™è¯¯ä¿¡æ¯: ${e.message}
								å †æ ˆè·Ÿè¸ªå·²çœç•¥ï¼ˆJenkins å®‰å…¨é™åˆ¶ï¼‰
								"""
							}

							echo ""
						}

						echo """
						==========================================
						ğŸ“Š æ„å»ºç»Ÿè®¡
						==========================================
						æ€»æ¨¡å—æ•°: ${modules.size()}
						æˆåŠŸæ¨¡å—æ•°: ${builtModulesList.size()}
						æˆåŠŸæ¨¡å—: ${builtModulesList.join(', ')}
						==========================================
						"""
						env.BUILD_RESULTS = buildResults.collect { k, v -> "${k}:${v}" }.join(',')
						env.BUILT_MODULES = builtModulesList.size() > 0 ? builtModulesList.join(', ') : 'æ— '
						env.BACKEND_ARTIFACTS = artifactsList.join('|')

						echo "æœ€ç»ˆæ„å»ºæ¨¡å—: ${env.BUILT_MODULES}"
					}
				}
			}
		}

		stage('å­˜å‚¨æ„å»ºäº§ç‰©') {
			steps {
				script {
					echo """
					==========================================
					å¼€å§‹å­˜å‚¨æ„å»ºäº§ç‰©åˆ°æœ¬åœ°"
					==========================================
					"""

					def gitCommitFull = ""
					def gitAuthor = ""
					def gitCommitTime = ""
					def gitCommitMessage = ""

					try {
						gitCommitFull = sh(script: "git rev-parse HEAD", returnStdout: true).trim()
						gitAuthor = sh(script: "git log -1 --format='%an <%ae>'", returnStdout: true).trim()
						gitCommitTime = sh(script: "git log -1 --format='%ci'", returnStdout: true).trim()
						gitCommitMessage = sh(script: "git log -1 --format='%s'", returnStdout: true).trim()
					} catch (Exception e) {
						echo "âš ï¸ è·å– Git ä¿¡æ¯å¤±è´¥: ${e.message}"
						gitCommitFull = "unknown"
						gitAuthor = "unknown"
						gitCommitTime = "unknown"
						gitCommitMessage = "unknown"
					}

					def buildUser = "System"
					def jenkinsNode = env.NODE_NAME ?: 'master'

					if (env.IS_FRONTEND == 'true') {
						def tarFile = env.FRONTEND_ARTIFACT
						def targetDir = "${env.ARTIFACTS_BASE_DIR}/frontend/${params.REPOSITORY}"

						sh "mkdir -p ${targetDir}"
						sh "cp ${tarFile} ${targetDir}/"

						def targetPath = "${targetDir}/${tarFile}"
						def fileSize = sh(script: "du -h ${targetPath} | cut -f1", returnStdout: true).trim()
						def fileMd5 = sh(script: "md5sum ${targetPath} | cut -d' ' -f1", returnStdout: true).trim()

						echo """
						âœ… å‰ç«¯äº§ç‰©å·²å­˜å‚¨
						è·¯å¾„: ${targetPath}
						å¤§å°: ${fileSize}
						MD5: ${fileMd5}
                        """

						def metadata = [
							project: params.REPOSITORY,
							type: 'frontend',
							version: env.BUILD_VERSION,
							artifact: tarFile,
							path: targetPath,
							size: fileSize,
							md5: fileMd5,
							gitCommit: env.GIT_COMMIT_SHORT ?: 'unknown',
							gitCommitFull: gitCommitFull,
							gitBranch: params.BRANCH,
							gitAuthor: gitAuthor,
							gitCommitTime: gitCommitTime,
							gitCommitMessage: gitCommitMessage,
							buildTime: new Date().format('yyyy-MM-dd HH:mm:ss'),
							buildNumber: env.BUILD_NUMBER,
							buildUrl: env.BUILD_URL ?: 'unknown',
							buildUser: buildUser,
							jenkinsNode: jenkinsNode
						]

						def jsonString = groovy.json.JsonOutput.toJson(metadata)
						def prettyJson = groovy.json.JsonOutput.prettyPrint(jsonString)
						prettyJson = decodeUnicode(prettyJson)

						writeFile file: "${targetDir}/${tarFile}.json", text: prettyJson, encoding: 'UTF-8'
						echo "   å…ƒæ•°æ®: ${targetDir}/${tarFile}.json"

					} else {
						def artifacts = env.BACKEND_ARTIFACTS.split('\\|')
						def storedCount = 0

						for (artifact in artifacts) {
							def parts = artifact.split(':')
							if (parts.size() != 2) continue

							def moduleName = parts[0].trim()
							def jarPath = parts[1].trim()

							if (!fileExists(jarPath)) {
								echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: ${jarPath}"
								continue
							}

							def jarName = jarPath.split('/').last()
							def targetDir = "${env.ARTIFACTS_BASE_DIR}/backend/${params.REPOSITORY}/${moduleName}"

							sh "mkdir -p ${targetDir}"
							sh "cp ${jarPath} ${targetDir}/"

							def targetPath = "${targetDir}/${jarName}"
							def fileSize = sh(script: "du -h ${targetPath} | cut -f1", returnStdout: true).trim()
							def fileMd5 = sh(script: "md5sum ${targetPath} | cut -d' ' -f1", returnStdout: true).trim()

							echo """
							âœ… ${moduleName} å·²å­˜å‚¨
							è·¯å¾„: ${targetPath}
							å¤§å°: ${fileSize}
							MD5: ${fileMd5}
							"""

							def moduleMetadata = [
								project: params.REPOSITORY,
								module: moduleName,
								type: 'backend',
								version: env.BUILD_VERSION,
								artifact: jarName,
								path: targetPath,
								size: fileSize,
								md5: fileMd5,
								gitCommit: env.GIT_COMMIT_SHORT ?: 'unknown',
								gitCommitFull: gitCommitFull,
								gitBranch: params.BRANCH,
								gitAuthor: gitAuthor,
								gitCommitTime: gitCommitTime,
								gitCommitMessage: gitCommitMessage,
								buildTime: new Date().format('yyyy-MM-dd HH:mm:ss'),
								buildNumber: env.BUILD_NUMBER,
								buildUrl: env.BUILD_URL ?: 'unknown',
								buildUser: buildUser,
								jenkinsNode: jenkinsNode
							]

							def jsonString = groovy.json.JsonOutput.toJson(moduleMetadata)
							def prettyJson = groovy.json.JsonOutput.prettyPrint(jsonString)
							prettyJson = decodeUnicode(prettyJson)

							writeFile file: "${targetDir}/${jarName}.json", text: prettyJson, encoding: 'UTF-8'

							storedCount++
						}

						echo """
						==========================================
						å­˜å‚¨ç»Ÿè®¡: æˆåŠŸ ${storedCount} ä¸ªæ¨¡å—
						==========================================
						"""
					}
				}
			}
		}

		stage('å½’æ¡£åˆ° Jenkins') {
			steps {
				script {
					echo "æ­£åœ¨å½’æ¡£æ„å»ºäº§ç‰©åˆ° Jenkins..."

					try {
						if (env.IS_FRONTEND == 'true') {
							archiveArtifacts artifacts: "*.tar.gz", fingerprint: true
							echo "âœ… å‰ç«¯äº§ç‰©å·²å½’æ¡£åˆ° Jenkins"
						} else {
							def modules = params.BUILD_MODULES.split(',')
							def archived = false

							modules.each { module ->
								module = module.trim()

								def moduleName = module
								def parentModule = ''

								if (module.startsWith('[') && module.contains(']')) {
									def parts = module.split(']', 2)
									parentModule = parts[0].substring(1)
									moduleName = parts[1]
								}

								def jarSearchPath = parentModule ? "${parentModule}/${moduleName}" : moduleName
								def pattern = "${jarSearchPath}/target/*-${env.BUILD_VERSION}.jar"

								if (findFiles(glob: pattern).size() > 0) {
									archiveArtifacts artifacts: pattern, fingerprint: true, allowEmptyArchive: true
									archived = true
								}
							}

							if (archived) {
								echo "âœ… åç«¯äº§ç‰©å·²å½’æ¡£åˆ° Jenkins"
							}
						}
					} catch (Exception e) {
						echo "âš ï¸ å½’æ¡£å¤±è´¥: ${e.message}"
					}
				}
			}
		}

		stage('æ¸…ç†æ—§ç‰ˆæœ¬') {
			steps {
				script {
					echo "æ­£åœ¨æ¸…ç†æ—§ç‰ˆæœ¬..."

					try {
						def projectType = env.IS_FRONTEND == 'true' ? 'frontend' : 'backend'
						def projectDir = "${env.ARTIFACTS_BASE_DIR}/${projectType}/${params.REPOSITORY}"

						if (params.VERSION_SUFFIX == 'SNAPSHOT') {
							sh """
								cd ${projectDir}
								find . -name "*-SNAPSHOT.jar" -o -name "*-SNAPSHOT.tar.gz" | \
								sort -r | tail -n +31 | xargs -r rm -f
								find . -name "*-SNAPSHOT.jar.json" -o -name "*-SNAPSHOT.tar.gz.json" | \
								sort -r | tail -n +31 | xargs -r rm -f
							"""
							echo "âœ… å·²æ¸…ç†æ—§çš„ SNAPSHOT ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘ 30 ä¸ªï¼‰"
						}

					} catch (Exception e) {
						echo "âš ï¸ æ¸…ç†å¤±è´¥: ${e.message}"
					}
				}
			}
		}
	}

	post {
		always {
			script {
				def buildUser = 'System'
				try {
					wrap([$class: 'BuildUser']) {
						buildUser = env.BUILD_USER ?: 'System'
					}
				} catch (Exception e) {
					buildUser = 'System'
				}

				def version = env.BUILD_VERSION ?: 'æœªæŒ‡å®š'
				def timestamp = new Date().format('yyyy-MM-dd HH:mm:ss')
				def modules = env.BUILT_MODULES ?: 'æ— '
				def projectType = env.IS_FRONTEND == 'true' ? 'ğŸŒ' : 'â˜•'

				def buildStatus = currentBuild.result ?: 'SUCCESS'
				def statusIcon = buildStatus == 'SUCCESS' ? 'âœ…' : 'âŒ'

				currentBuild.description = """
				${projectType} ${modules} |
                ğŸ“¦ ${version} |
                â° ${timestamp} |
                ğŸ‘¤ ${buildUser} |
                ${statusIcon}
            """.replaceAll(/\s+/, ' ').trim()
			}
		}

		success {
			script {
				def projectType = env.IS_FRONTEND == 'true' ? 'frontend' : 'backend'
				def storagePath = "${env.ARTIFACTS_BASE_DIR}/${projectType}/${params.REPOSITORY}"

				echo """
				==========================================
				ğŸ‰ æ„å»ºå®Œæˆ
				==========================================
				ç‰ˆæœ¬å·: ${env.BUILD_VERSION}
				æ„å»ºæ¨¡å—: ${env.BUILT_MODULES}
				å­˜å‚¨è·¯å¾„: ${storagePath}
				Jenkins å½’æ¡£: ${env.BUILD_URL}artifact/
				==========================================
				"""
			}
		}

		failure {
			echo "âŒ æ„å»ºå¤±è´¥ï¼è¯·æŸ¥çœ‹æ—¥å¿—æ’æŸ¥é—®é¢˜ã€‚"
		}
	}
}

def getRepositoryUrl(repoName) {
	def repoMap = [
		'zcf-charge-operation-platform': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/backend/zcf-charge-operation-platform.git',
		'zcf-busi-middle-office': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/middle-office/backend/zcf-busi-middle-office.git',
		'zcf-iot-gateway': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/base-framework/backend/zcf-iot-gateway.git',
		'zcf-charge-plat': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-platform-web.git',
		'zcf-charge-tenant': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-tenant-web.git',
		'zcf-data-platform-jobs': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/data-middle-office/backend/zcf-data-middle-office-job.git',
		'zcf-data-platform-engine': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/data-middle-office/backend/zcf-data-middle-office-job-framework.git',
		'zcf-charge-h5': 'https://codeup.aliyun.com/6552e8ef77eababf21d319a4/business-platform/frontend/zcf-charge-operation-platform-applet.git'
	]
	return repoMap[repoName]
}

def isFrontendProject(repoName) {
	def frontendProjects = ['zcf-charge-plat', 'zcf-charge-tenant','zcf-charge-h5']
	return frontendProjects.contains(repoName) ? 'true' : 'false'
}

def decodeUnicode(String text) {
	def result = new StringBuilder()
	def i = 0
	while (i < text.length()) {
		if (text[i] == '\\' && i + 5 < text.length() && text[i + 1] == 'u') {
			try {
				def unicode = text.substring(i + 2, i + 6)
				def ch = (char) Integer.parseInt(unicode, 16)
				result.append(ch)
				i += 6
			} catch (Exception e) {
				result.append(text[i])
				i++
			}
		} else {
			result.append(text[i])
			i++
		}
	}
	return result.toString()
}
